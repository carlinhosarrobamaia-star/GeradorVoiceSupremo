<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gerador Supremo</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Rajdhani:wght@400;600;700&family=Exo+2:wght@300;400;600;700&family=Black+Ops+One&display=swap" rel="stylesheet">
<style>
:root,[data-theme="dark"]{
  --bg1:#050508;--bg2:#09090f;--bg3:#0f0f18;--bg4:#171724;
  --border:#202035;--border2:#18182a;
  --glass:rgba(255,255,255,0.025);--glass2:rgba(255,255,255,0.05);
  --text:#c0c0d8;--text2:#8888aa;--text3:#444466;
  --accent:#5588ff;--accent-glow:rgba(85,136,255,0.3);
  --modal-bg:linear-gradient(160deg,#09090f,#0e0e1a);
  --shadow:rgba(0,0,0,0.8);--card-bg:rgba(255,255,255,0.025);--h1-glow:rgba(85,136,255,0.3);
}
[data-theme="midnight"]{
  --bg1:#080812;--bg2:#0d0d1e;--bg3:#131328;--bg4:#1a1a32;
  --border:#252548;--border2:#1e1e3a;
  --glass:rgba(100,80,255,0.04);--glass2:rgba(100,80,255,0.07);
  --text:#c8c8f0;--text2:#8080cc;--text3:#404080;
  --accent:#7c5cff;--accent-glow:rgba(124,92,255,0.35);
  --modal-bg:linear-gradient(160deg,#0d0d1e,#12121e);
  --shadow:rgba(0,0,10,0.85);--card-bg:rgba(80,60,200,0.04);--h1-glow:rgba(124,92,255,0.4);
}
[data-theme="light"]{
  --bg1:#f4f4f8;--bg2:#ebebf2;--bg3:#e2e2ec;--bg4:#d8d8e5;
  --border:#c8c8dc;--border2:#d0d0e4;
  --glass:rgba(0,0,0,0.03);--glass2:rgba(0,0,0,0.06);
  --text:#222238;--text2:#555580;--text3:#aaaacc;
  --accent:#3355dd;--accent-glow:rgba(51,85,221,0.2);
  --modal-bg:linear-gradient(160deg,#f0f0f8,#e8e8f4);
  --shadow:rgba(0,0,0,0.15);--card-bg:rgba(0,0,0,0.03);--h1-glow:rgba(51,85,221,0.3);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{overflow:hidden;width:100%;height:100%;}
body{font-family:'Exo 2',sans-serif;background:var(--bg1);color:var(--text);transition:background .3s,color .3s;}
#shakeWrapper{padding:0;overflow-y:auto;overflow-x:hidden;height:100vh;}
#shakeInner{padding:28px 72px 28px 24px;}
.topbar{display:flex;align-items:center;gap:12px;margin-bottom:24px;}
h1{font-family:'Cinzel Decorative',serif;font-size:1.9rem;color:var(--text);letter-spacing:3px;flex:1;text-shadow:0 0 40px var(--h1-glow);}
[data-theme="light"] h1{color:#111130;}
.settings-btn{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--glass2);border:1px solid var(--border);cursor:pointer;font-size:1.2rem;color:var(--text2);transition:all .2s;flex-shrink:0;}
.settings-btn:hover{background:var(--glass);border-color:var(--accent);color:var(--accent);}
h3{color:var(--text2);font-size:.92rem;text-transform:uppercase;letter-spacing:2.5px;margin-bottom:10px;}
h4{color:var(--text3);font-size:.82rem;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;}
textarea{width:100%;height:110px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:.95rem;resize:vertical;transition:border-color .2s;}
textarea:focus{outline:none;border-color:var(--accent);}
textarea::placeholder{color:var(--text3);font-size:.86rem;line-height:1.7;}
button{margin:3px;padding:8px 16px;border:none;border-radius:9px;cursor:pointer;background:var(--bg4);color:var(--text2);font-weight:600;font-family:'Exo 2',sans-serif;font-size:.9rem;border:1px solid var(--border);transition:all .18s;}
button:hover{background:var(--bg3);color:var(--text);border-color:var(--text3);transform:translateY(-1px);}
button:active{transform:translateY(0);}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 0 18px var(--accent-glow);}
.btn-primary:hover{filter:brightness(1.15);box-shadow:0 0 28px var(--accent-glow);}
.btn-danger{background:rgba(180,30,30,.15);border-color:#550000;color:#ff8888;}
.btn-danger:hover{background:rgba(180,30,30,.3);}
[data-theme="light"] .btn-primary{color:#fff;}
.category{background:var(--card-bg);padding:15px;margin-bottom:12px;border-radius:15px;border:1px solid var(--border2);}
.subcategory{background:var(--glass2);padding:11px;margin-top:9px;border-radius:11px;border:1px solid var(--border2);}
.controls-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px;}
.controls-row label{color:var(--text2);font-size:.77rem;letter-spacing:1px;}
.controls-row input[type=number]{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);font-family:'Exo 2',sans-serif;width:68px;}
.characters{display:flex;flex-wrap:wrap;gap:15px;margin-top:20px;}
.pinned{border-color:var(--accent)!important;box-shadow:0 0 18px var(--accent-glow)!important;}
.charHeader .char-name{flex:1;cursor:pointer;}
.charHeader .char-name:hover{color:var(--accent);}
.charHeader span.icon-btn{cursor:pointer;font-size:.95rem;opacity:.45;transition:opacity .15s,transform .15s;padding:3px;}
.charHeader span.icon-btn:hover{opacity:1;transform:scale(1.18);}
p.skill-item{padding:7px 90px 7px 46px;margin-bottom:4px;border-radius:9px;font-weight:600;font-size:.94rem;cursor:pointer;border:1px solid transparent;position:relative;color:#fff;transition:filter .15s,transform .1s;font-family:'Rajdhani',sans-serif;letter-spacing:.3px;will-change:transform;}
p.skill-item:hover{filter:brightness(1.22);transform:scale(1.01);}
p.skill-item::after{content:"‚ü≥";position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:.85rem;opacity:.3;}
p.skill-item.empty-slot::after{content:"üé≤";}
p.skill-item.locked::after{content:"üîí";opacity:.7;}
p.skill-item.boss-skill{cursor:default!important;}
p.skill-item.boss-skill:hover{filter:none;transform:none;}
p.skill-item.boss-skill::after{content:''!important;}

@keyframes auroraShift{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
@keyframes auroraGlow{
  0%  {box-shadow:0 0 5px #ff0080,0 0 14px #ff008066,inset 0 0 6px rgba(255,0,128,.15);}
  16% {box-shadow:0 0 5px #ff8800,0 0 14px #ff880066,inset 0 0 6px rgba(255,136,0,.15);}
  33% {box-shadow:0 0 5px #aaff00,0 0 14px #aaff0066,inset 0 0 6px rgba(170,255,0,.15);}
  50% {box-shadow:0 0 5px #00ff88,0 0 14px #00ff8866,inset 0 0 6px rgba(0,255,136,.15);}
  66% {box-shadow:0 0 5px #00cfff,0 0 14px #00cfff66,inset 0 0 6px rgba(0,207,255,.15);}
  83% {box-shadow:0 0 5px #aa44ff,0 0 14px #aa44ff66,inset 0 0 6px rgba(170,68,255,.15);}
  100%{box-shadow:0 0 5px #ff0080,0 0 14px #ff008066,inset 0 0 6px rgba(255,0,128,.15);}
}
@keyframes auroraBorder{
  0%{border-color:#ff0080;}16%{border-color:#ff8800;}33%{border-color:#aaff00;}
  50%{border-color:#00ff88;}66%{border-color:#00cfff;}83%{border-color:#aa44ff;}100%{border-color:#ff0080;}
}
@keyframes auroraTremor{
  0%{transform:translate(0,0);}25%{transform:translate(-.8px,.4px);}50%{transform:translate(.8px,-.4px);}75%{transform:translate(-.4px,.8px);}100%{transform:translate(0,0);}
}
.rarity-aurora{background:linear-gradient(135deg,#0a001a 0%,#150030 50%,#0a001a 100%)!important;animation:auroraBorder 2s linear infinite, auroraGlow 2s linear infinite, auroraTremor .45s infinite!important;color:#ffffff!important;text-shadow:0 0 8px rgba(255,255,255,.5)!important;}
@keyframes tremorMitica{0%{transform:translate(0,0);}25%{transform:translate(-.8px,.4px);}50%{transform:translate(.8px,-.4px);}75%{transform:translate(-.4px,.8px);}100%{transform:translate(0,0);}}
@keyframes tremorOmega{0%{transform:translate(0,0);}25%{transform:translate(-1.2px,.8px);}50%{transform:translate(1.2px,-.8px);}75%{transform:translate(-.8px,-.4px);}100%{transform:translate(0,0);}}
@keyframes neonMitica{0%,100%{box-shadow:0 0 4px #ff0000,0 0 10px #ff000066;}50%{box-shadow:0 0 8px #ff3333,0 0 18px #ff000088;}}
@keyframes neonOmega{0%,100%{box-shadow:0 0 4px #ffffff88,0 0 12px #ffffff44;}50%{box-shadow:0 0 8px #ffffffaa,0 0 20px #ffffff66;}}
@keyframes rouletteNeonOmega{
  0%,100%{box-shadow:0 0 0 4px rgba(255,255,255,.2),0 0 30px 8px rgba(255,255,255,.3),0 0 70px 20px rgba(255,255,255,.12);}
  50%{box-shadow:0 0 0 4px rgba(255,255,255,.5),0 0 45px 14px rgba(255,255,255,.55),0 0 100px 30px rgba(255,255,255,.2);}
}
@keyframes rouletteNeonAurora{
  0%  {box-shadow:0 0 0 4px #ff0080cc,0 0 30px 8px #ff008066,0 0 70px 20px #ff008033;}
  16% {box-shadow:0 0 0 4px #ff8800cc,0 0 30px 8px #ff880066,0 0 70px 20px #ff880033;}
  33% {box-shadow:0 0 0 4px #aaff00cc,0 0 30px 8px #aaff0066,0 0 70px 20px #aaff0033;}
  50% {box-shadow:0 0 0 4px #00ff88cc,0 0 30px 8px #00ff8866,0 0 70px 20px #00ff8833;}
  66% {box-shadow:0 0 0 4px #00cfffcc,0 0 30px 8px #00cfff66,0 0 70px 20px #00cfff33;}
  83% {box-shadow:0 0 0 4px #aa44ffcc,0 0 30px 8px #aa44ff66,0 0 70px 20px #aa44ff33;}
  100%{box-shadow:0 0 0 4px #ff0080cc,0 0 30px 8px #ff008066,0 0 70px 20px #ff008033;}
}
#rouletteCanvas.neon-omega{border-radius:50%;animation:rouletteNeonOmega 1.2s ease-in-out infinite;}
#rouletteCanvas.neon-aurora{border-radius:50%;animation:rouletteNeonAurora 1.8s linear infinite;}

li{padding:5px 9px;margin-bottom:3px;border-radius:6px;font-weight:600;font-size:.9rem;list-style:none;border:1px solid transparent;font-family:'Rajdhani',sans-serif;}
hr{border:none;border-top:1px solid var(--border2);margin:20px 0;}

@keyframes omegaRouletteBgGlow{
  0%,100%{box-shadow:inset 0 0 30px 10px rgba(255,255,255,.08),0 0 40px 15px rgba(255,255,255,.15);}
  50%{box-shadow:inset 0 0 60px 20px rgba(255,255,255,.18),0 0 80px 30px rgba(255,255,255,.3);}
}
#rouletteCanvasWrap.omega-bg-glow{animation:omegaRouletteBgGlow 1s ease-in-out infinite;border-radius:50%;}

#multiSpinOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:999;backdrop-filter:blur(18px);overflow-y:auto;overflow-x:hidden;}
#multiSpinOverlay.visible{display:block;}
#multiSpinInner{width:100%;max-width:1440px;margin:0 auto;padding:18px 14px 40px;}
#multiSpinTitle{font-family:'Cinzel Decorative',serif;color:var(--text);font-size:.95rem;text-align:center;letter-spacing:2px;margin-bottom:12px;}
#multiSpinGrid{display:grid;justify-content:center;justify-items:center;align-items:start;}
.mini-roulette-wrap{display:flex;flex-direction:column;align-items:center;gap:2px;width:100%;box-sizing:border-box;}
.mini-roulette-cat{font-size:.58rem;color:var(--text3);text-align:center;text-transform:uppercase;letter-spacing:.8px;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mini-roulette-subname{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:.78rem;color:var(--text);text-align:center;line-height:1.1;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mini-roulette-result{font-family:'Rajdhani',sans-serif;font-size:.7rem;font-weight:600;text-align:center;min-height:16px;border-radius:5px;padding:1px 5px;border:1px solid transparent;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
@keyframes miniLockedNeon{
  0%,100%{box-shadow:0 0 5px #ffcc00,0 0 12px rgba(255,170,0,.5);}
  50%{box-shadow:0 0 9px #ffdd44,0 0 20px rgba(255,170,0,.8);}
}
.mini-cv-locked{animation:miniLockedNeon 1.6s ease-in-out infinite;border-radius:50%;}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(14px);}
.modal-overlay.open{display:flex;align-items:center;justify-content:center;}
/* rename always on top of other modals */
#renameOverlay{z-index:2500;}
#confirmOverlay{z-index:2400;}
.modal-box{background:var(--modal-bg);border:1px solid var(--border);border-radius:18px;padding:24px 22px 20px;min-width:310px;max-width:470px;width:92vw;box-shadow:0 0 70px var(--shadow),0 0 0 1px rgba(255,255,255,.04);position:relative;overflow:hidden;}
[data-theme="light"] .modal-box{box-shadow:0 8px 40px rgba(0,0,0,.15);}
.modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.5;}
.modal-title{font-family:'Cinzel Decorative',serif;color:var(--text);font-size:.9rem;letter-spacing:2px;margin-bottom:16px;}
.modal-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:9px 13px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:.88rem;margin-bottom:13px;}
.modal-input:focus{outline:none;border-color:var(--accent);}
.modal-actions{display:flex;gap:7px;justify-content:flex-end;margin-top:5px;}
.modal-actions button{margin:0;}

#skillPickerModal{max-width:550px;width:95vw;max-height:80vh;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;touch-action:pan-y;}
#skillPickerOverlay{overflow-y:auto;}
.skill-picker-cats{display:flex;flex-direction:column;gap:8px;}
.sp-cat-title{color:var(--text2);font-size:.7rem;text-transform:uppercase;letter-spacing:2px;margin-bottom:5px;border-bottom:1px solid var(--border);padding-bottom:5px;}
.sp-sub-title{color:var(--text3);font-size:.65rem;text-transform:uppercase;letter-spacing:1.5px;margin:7px 0 4px;padding-left:5px;}
.sp-options-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:4px;}
.sp-option{padding:6px 11px;border-radius:8px;cursor:pointer;font-size:.78rem;font-weight:700;font-family:'Rajdhani',sans-serif;border:1px solid transparent;transition:filter .15s,transform .1s;}
.sp-option:hover{filter:brightness(1.28);transform:scale(1.02);}
.sp-option-aurora{animation:auroraBorder 2s linear infinite, auroraGlow 1.5s linear infinite!important;}
.edit-options-list{display:flex;flex-direction:column;gap:5px;max-height:300px;overflow-y:auto;margin-bottom:11px;}
.edit-option-row{display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:8px;background:var(--bg3);border:1px solid var(--border);}
.edit-option-row .eor-name{flex:1;color:var(--text);font-size:.8rem;font-weight:600;}
.edit-option-row .eor-pct{font-size:.72rem;min-width:55px;}
.edit-option-row input{background:var(--bg4);border:1px solid var(--border);border-radius:5px;padding:3px 7px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:.76rem;}
.edit-option-row input:focus{outline:none;border-color:var(--accent);}

#settingsModal{max-width:380px;}
.theme-picker{display:flex;gap:8px;margin:12px 0;}
.theme-option{flex:1;padding:14px 8px;border-radius:12px;cursor:pointer;text-align:center;border:2px solid transparent;transition:all .2s;font-size:.75rem;font-weight:700;font-family:'Exo 2',sans-serif;letter-spacing:1px;text-transform:uppercase;}
.theme-option.dark{background:#050508;color:#aaaacc;border-color:#202035;}
.theme-option.midnight{background:#080812;color:#c8c8f0;border-color:#252548;}
.theme-option.light{background:#f4f4f8;color:#333360;border-color:#c8c8dc;}
.theme-option.active{border-color:var(--accent)!important;box-shadow:0 0 15px var(--accent-glow);}
.theme-option:hover{transform:scale(1.04);}
.rc-row{display:flex;align-items:center;gap:10px;font-size:.75rem;color:var(--text2);}
.rc-row label{min-width:100px;text-transform:uppercase;letter-spacing:1px;}
.rc-row input[type=range]{flex:1;accent-color:var(--accent);}
.rc-row span{min-width:42px;color:var(--text);font-weight:700;text-align:right;}

#rouletteOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:999;align-items:center;justify-content:center;backdrop-filter:blur(16px);}
#rouletteOverlay.visible{display:flex;}
#rouletteModal{background:var(--modal-bg);border:1px solid var(--border);border-radius:22px;padding:26px 22px 20px;min-width:340px;max-width:420px;width:92vw;max-height:92vh;display:flex;flex-direction:column;align-items:center;gap:11px;box-shadow:0 0 90px var(--shadow);position:relative;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;touch-action:pan-y;}
#rouletteOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:999;align-items:center;justify-content:center;backdrop-filter:blur(16px);overflow-y:auto;}
#rouletteModal::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.6;}
#rouletteModal h2{font-family:'Cinzel Decorative',serif;color:var(--text);font-size:.95rem;text-align:center;letter-spacing:2.5px;}
#rouletteCanvasWrap{position:relative;width:290px;height:290px;cursor:pointer;flex-shrink:0;}
#rouletteCanvas{border-radius:50%;display:block;will-change:transform;}
#spinHint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:50px;height:50px;border-radius:50%;background:var(--bg4);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--text2);pointer-events:none;opacity:.8;user-select:none;transition:opacity .2s;}
#roulettePointer{position:absolute;top:-16px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:22px solid var(--text);filter:drop-shadow(0 2px 4px #000);z-index:10;}
#rouletteFlash{position:absolute;inset:0;border-radius:22px;pointer-events:none;opacity:0;z-index:50;}
#rouletteBigResult{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:60;pointer-events:none;opacity:0;flex-direction:column;gap:7px;}
#rouletteBigGlow{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:280px;height:120px;border-radius:50%;pointer-events:none;opacity:0;filter:blur(35px);transition:opacity .3s;}
#rouletteBigResultText{font-family:'Cinzel Decorative',serif;font-size:1.6rem;font-weight:700;text-align:center;padding:0 20px;line-height:1.25;position:relative;z-index:2;}
#rouletteBigResultSub{font-size:.95rem;font-weight:600;opacity:.8;font-family:'Rajdhani',sans-serif;position:relative;z-index:2;}
#rouletteResult{font-size:.9rem;font-weight:700;text-align:center;min-height:24px;color:#fff;padding:6px 16px;border-radius:9px;border:1px solid transparent;opacity:0;transition:opacity .5s;font-family:'Rajdhani',sans-serif;}
#rouletteResult.shown{opacity:1;}
#rouletteCloseBtn{background:transparent;border:1px solid var(--border);color:var(--text3);font-size:.76rem;margin-top:2px;transition:visibility 0s,opacity .2s;}
#rouletteCloseBtn:hover{border-color:var(--text2);color:var(--text2);}

#luckPanel{background:var(--card-bg);border:1px solid var(--border2);border-radius:15px;padding:15px;margin-top:18px;}
#luckPanel select{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:5px 9px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:.78rem;}
.luck-tabs{display:flex;gap:5px;margin-bottom:13px;}
.luck-tab{padding:5px 13px;border-radius:8px;cursor:pointer;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;border:1px solid var(--border);color:var(--text2);background:transparent;transition:all .2s;}
.luck-tab.active{background:var(--accent-glow);border-color:var(--accent);color:var(--text);}
.luck-section{display:none;}
.luck-section.active{display:block;}
#luckActiveTag,#guaranteeActiveTag{display:inline-block;padding:3px 11px;border-radius:20px;font-size:.7rem;font-weight:700;letter-spacing:1px;opacity:0;transition:opacity .3s;margin-top:5px;}
#luckActiveTag.on,#guaranteeActiveTag.on{opacity:1;}

#particlesCanvas{position:fixed;inset:0;pointer-events:none;z-index:998;display:none;}
#particlesCanvas.active{display:block;}

#omegaRitual{position:fixed;inset:0;z-index:1100;pointer-events:none;display:none;align-items:center;justify-content:center;}
#omegaRitual.active{display:flex;}
#omegaBeamCanvas{position:absolute;inset:0;width:100%;height:100%;z-index:1;}
#omegaRitualText{font-family:'Cinzel Decorative',serif;font-size:2.8rem;color:#fff;letter-spacing:8px;text-align:center;position:relative;z-index:10;text-shadow:0 0 30px #fff,0 0 80px #fff,0 0 120px rgba(200,220,255,.8);opacity:0;pointer-events:none;}

#miticaOverlay{position:fixed;inset:0;z-index:1100;pointer-events:none;display:none;align-items:center;justify-content:center;}
#miticaOverlay.active{display:flex;}
#miticaCanvas{position:absolute;inset:0;width:100%;height:100%;}
#miticaText{font-family:'Cinzel Decorative',serif;font-size:2.4rem;color:#ff4400;letter-spacing:6px;text-align:center;position:relative;z-index:2;text-shadow:0 0 15px #ff0000,0 0 40px #ff0000;opacity:0;}

#auroraOverlay{position:fixed;inset:0;z-index:1100;pointer-events:none;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0);}
#auroraOverlay.active{display:flex;}
#auroraCanvas{position:absolute;inset:0;width:100%;height:100%;}
#auroraRevealText{font-family:'Cinzel Decorative',serif;font-size:2.6rem;letter-spacing:6px;text-align:center;position:relative;z-index:2;opacity:0;background:linear-gradient(270deg,#ff0080,#ff8800,#ffff00,#00ff88,#00cfff,#aa44ff,#ff0080);background-size:300% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:auroraShift 1.2s linear infinite;filter:drop-shadow(0 0 20px rgba(255,0,128,1)) drop-shadow(0 0 40px rgba(0,207,255,.9));}

#guaranteePersistBadge{display:none;position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:500;padding:6px 16px 6px 10px;border-radius:20px;font-size:.74rem;font-weight:700;letter-spacing:1px;font-family:'Exo 2',sans-serif;cursor:pointer;transition:all .2s;white-space:nowrap;}
#guaranteePersistBadge:hover{filter:brightness(1.2);transform:translateX(-50%) scale(1.05);}
#guaranteePersistBadge.visible{display:flex;align-items:center;gap:8px;}

#toast{position:fixed;bottom:28px;right:28px;z-index:3000;background:var(--bg4);border:1px solid var(--border);border-radius:11px;padding:11px 18px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:.82rem;font-weight:600;opacity:0;transform:translateY(16px);transition:opacity .28s,transform .28s;pointer-events:none;box-shadow:0 6px 24px var(--shadow);}
#toast.show{opacity:1;transform:translateY(0);}

.desc-item{margin-bottom:5px;padding:4px 8px;border-radius:6px;border-left:3px solid transparent;font-size:.8rem;}
.desc-item-name{font-weight:700;font-family:'Rajdhani',sans-serif;font-size:.88rem;}
.desc-item-text{color:var(--text2);font-size:.76rem;margin-top:1px;}

.skill-lock-btn{position:absolute;right:26px;top:50%;transform:translateY(-50%);font-size:.72rem;opacity:0;transition:opacity .15s;cursor:pointer;padding:2px;}
p.skill-item:hover .skill-lock-btn{opacity:.5;}
p.skill-item.locked .skill-lock-btn{opacity:1 !important;}
.skill-clear-btn{position:absolute;right:46px;top:50%;transform:translateY(-50%);font-size:.65rem;opacity:0;transition:opacity .15s;cursor:pointer;padding:2px;color:#ff6666;}
p.skill-item:hover .skill-clear-btn{opacity:.45;}
p.skill-item.empty-slot .skill-clear-btn{display:none;}

@keyframes lockedNeon{
  0%,100%{box-shadow:0 0 4px #ffcc00,0 0 10px #ffaa0066,inset 0 0 5px rgba(255,200,0,.1);}
  50%{box-shadow:0 0 8px #ffdd33,0 0 18px #ffaa0099,inset 0 0 9px rgba(255,200,0,.2);}
}
p.skill-item.locked{
  border-color:#ffcc00 !important;
  animation:lockedNeon 1.6s ease-in-out infinite !important;
  outline:none;
}

#saveIndicator{position:fixed;bottom:28px;left:28px;z-index:500;font-size:.68rem;color:var(--text3);font-family:'Exo 2',sans-serif;opacity:0;transition:opacity .4s;pointer-events:none;}
#saveIndicator.flash{opacity:1;}

.character{background:var(--card-bg);padding:15px;border-radius:15px;min-width:260px;max-width:620px;border:1px solid var(--border2);transition:border-color .2s,box-shadow .2s;}
.charHeader{font-weight:700;margin-bottom:11px;display:flex;align-items:center;gap:4px;flex-wrap:wrap;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:1.1rem;letter-spacing:.5px;}
.char-with-desc{display:flex;gap:10px;align-items:flex-start;flex-wrap:nowrap;}
.char-skills-col{flex:1;min-width:220px;}
.char-desc-panel{margin-top:0;padding:8px 10px;border-radius:9px;background:var(--bg3);border:1px solid var(--border2);font-size:.82rem;line-height:1.6;font-family:'Exo 2',sans-serif;flex:0 0 170px;max-width:170px;}

/* ‚îÄ‚îÄ‚îÄ RARITY REVEAL OVERLAY ‚îÄ‚îÄ‚îÄ */
#rarityRevealOverlay{position:fixed;inset:0;z-index:1200;pointer-events:none;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;background:rgba(0,0,0,0);transition:opacity .3s;}
#rarityRevealText{font-family:'Cinzel Decorative',serif;font-size:clamp(2.5rem,7vw,6rem);font-weight:700;text-align:center;letter-spacing:8px;line-height:1.15;padding:20px 40px;transform:scale(0.5);}
#rarityRevealSub{font-family:'Rajdhani',sans-serif;font-size:1.4rem;font-weight:700;text-align:center;letter-spacing:5px;margin-top:8px;opacity:0.85;}
#rarityRevealGlow{position:absolute;inset:0;pointer-events:none;border-radius:0;filter:blur(60px);opacity:0;transition:opacity .3s;}
@keyframes rarityRevealIn{0%{transform:scale(0.2) rotate(-5deg);opacity:0;}60%{transform:scale(1.12) rotate(1deg);}100%{transform:scale(1) rotate(0deg);opacity:1;}}
@keyframes rarityRevealOut{0%{transform:scale(1);opacity:1;}100%{transform:scale(1.4);opacity:0;}}

/* ‚îÄ‚îÄ‚îÄ LOCK ALL BTN ‚îÄ‚îÄ‚îÄ */
.lock-all-btn{font-size:.7rem;padding:2px 7px;margin:0;background:rgba(255,204,0,.07);border-color:#444400;color:#aa8800;border-radius:6px;}
.lock-all-btn.all-locked{background:rgba(255,204,0,.16);border-color:#ffcc00 !important;color:#ffee44 !important;box-shadow:0 0 8px rgba(255,204,0,.3);}
.lock-all-btn:hover{background:rgba(255,204,0,.18)!important;border-color:#ffcc00!important;color:#ffee44!important;}

/* ‚îÄ‚îÄ‚îÄ BOSS DIFF BUTTONS ‚îÄ‚îÄ‚îÄ */
.boss-diff-btn{display:flex;align-items:center;gap:12px;padding:11px 14px;border-radius:11px;cursor:pointer;border:1px solid var(--border);background:var(--glass2);transition:all .18s;}
.boss-diff-btn:hover{border-color:var(--text3);background:var(--glass);transform:translateX(3px);}
.boss-diff-btn.selected{border-color:currentColor;box-shadow:0 0 14px rgba(255,255,255,.1);background:rgba(255,255,255,.07);}

/* ‚îÄ‚îÄ‚îÄ MAIN TABS ‚îÄ‚îÄ‚îÄ */
.main-tabs{display:flex;gap:6px;margin-bottom:22px;background:var(--bg3);padding:5px;border-radius:14px;border:1px solid var(--border);}
.main-tab{flex:1;padding:9px 14px;border-radius:10px;cursor:pointer;font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;border:none;background:transparent;color:var(--text2);font-family:'Exo 2',sans-serif;transition:all .2s;text-align:center;}
.main-tab:hover{color:var(--text);background:var(--glass2);}
.main-tab.active{background:var(--accent);color:#fff;box-shadow:0 0 18px var(--accent-glow);}
.tab-page{display:none;}.tab-page.active{display:block;}

/* ‚îÄ‚îÄ‚îÄ BATTLE SYSTEM ‚îÄ‚îÄ‚îÄ */
.battle-arena{display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:start;margin-bottom:20px;}
@media(max-width:640px){.battle-arena{grid-template-columns:1fr;}}
.battle-team{background:var(--card-bg);border:1px solid var(--border2);border-radius:16px;padding:16px;}
.battle-team-title{font-family:'Cinzel Decorative',serif;font-size:.75rem;letter-spacing:2px;margin-bottom:12px;text-align:center;}
.battle-team-a .battle-team-title{color:#5588ff;}
.battle-team-b .battle-team-title{color:#ff4422;}
.battle-vs{display:flex;align-items:center;justify-content:center;font-family:'Cinzel Decorative',serif;font-size:1.5rem;color:var(--text3);padding-top:40px;}
@media(max-width:640px){.battle-vs{padding:8px 0;}}
.battle-slot{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:10px;border:1px dashed var(--border);margin-bottom:7px;cursor:pointer;transition:all .18s;background:var(--glass);}
.battle-slot:hover{border-color:var(--accent);background:var(--glass2);}
.battle-slot.filled{border-style:solid;border-color:var(--border);cursor:default;}
.battle-slot.filled:hover{border-color:var(--border);background:var(--glass);}
.battle-slot-name{flex:1;font-size:.85rem;font-weight:700;font-family:'Rajdhani',sans-serif;color:var(--text);}
.battle-slot-remove{font-size:.75rem;opacity:.4;cursor:pointer;padding:2px 5px;border-radius:5px;transition:opacity .15s;}
.battle-slot-remove:hover{opacity:1;background:rgba(255,60,60,.2);}
.battle-add-btn{width:100%;padding:7px;border-radius:9px;border:1px dashed var(--border);background:transparent;color:var(--text3);font-size:.78rem;cursor:pointer;transition:all .18s;font-family:'Exo 2',sans-serif;}
.battle-add-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--glass);}
.battle-add-btn:disabled{opacity:.3;cursor:not-allowed;}
.battle-start-btn{width:100%;padding:16px;border-radius:14px;border:none;font-family:'Cinzel Decorative',serif;font-size:1rem;letter-spacing:3px;cursor:pointer;background:linear-gradient(135deg,#1a0a00,#4d1500,#1a0a00);color:#ff8844;border:1px solid #ff4400;box-shadow:0 0 30px rgba(255,68,0,.3);transition:all .25s;margin-bottom:20px;}
.battle-start-btn:hover:not(:disabled){filter:brightness(1.25);box-shadow:0 0 50px rgba(255,68,0,.5);transform:translateY(-2px);}
.battle-start-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}

/* ‚îÄ‚îÄ‚îÄ HP BARS STICKY ‚îÄ‚îÄ‚îÄ */
#battleHpBars{display:none;position:sticky;top:0;z-index:900;background:rgba(5,5,8,0.97);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:10px 14px;margin:0 -24px 18px -24px;}
#battleHpBars.visible{display:block;}
.hp-bars-grid{display:flex;flex-direction:column;gap:5px;}
.hp-team-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.hp-team-label{font-family:'Cinzel Decorative',serif;font-size:.55rem;letter-spacing:2px;min-width:38px;text-align:center;}
.hp-team-label.a{color:#5588ff;}
.hp-team-label.b{color:#ff4422;}
.hp-char-wrap{flex:1;min-width:80px;max-width:200px;position:relative;}
.hp-char-wrap.team-a-wrap .hp-char-name{text-align:right;}
.hp-char-wrap.team-a-wrap .hp-val{text-align:right;}
.hp-char-wrap.team-b-wrap .hp-char-name{text-align:left;}
.hp-char-wrap.team-b-wrap .hp-val{text-align:left;}
#hpRowA{display:flex;flex-direction:column;gap:6px;align-items:flex-end;}
#hpRowB{display:flex;flex-direction:column;gap:6px;align-items:flex-start;}
.hp-focused{outline:3px solid #ffcc00;outline-offset:2px;border-radius:8px;transition:outline .15s;}
@keyframes hpFocusPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,204,0,0);}50%{box-shadow:0 0 0 6px rgba(255,204,0,0.4);}}
.hp-bar-track.focused{animation:hpShake .35s ease, hpFocusPulse .5s ease;}
.dmg-float{position:absolute;font-family:'Black Ops One',sans-serif;font-size:1.1rem;font-weight:700;pointer-events:none;animation:dmgFloatUp .9s ease-out forwards;white-space:nowrap;z-index:1000;}
@keyframes dmgFloatUp{0%{transform:translateY(0) scale(1);opacity:1;}60%{transform:translateY(-28px) scale(1.15);opacity:1;}100%{transform:translateY(-50px) scale(0.85);opacity:0;}}
.hp-char-name{font-size:.82rem;font-family:'Black Ops One',sans-serif;color:#dde;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:1px;text-shadow:0 0 8px rgba(150,170,255,0.4);}
.hp-bar-track{height:18px;border-radius:6px;background:rgba(255,255,255,.13);overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.25);box-shadow:inset 0 1px 3px rgba(0,0,0,.5),0 0 8px rgba(0,0,0,.4);}
.hp-bar-fill{height:100%;border-radius:6px;transition:width .55s cubic-bezier(.4,0,.2,1),background .3s;position:relative;}
.hp-bar-fill.team-a{background:linear-gradient(90deg,#1a44bb,#5588ff,#88aaff);box-shadow:0 0 10px #5588ff88;}
.hp-bar-fill.team-b{background:linear-gradient(90deg,#aa1100,#ff4422,#ff7755);box-shadow:0 0 10px #ff442288;}
.hp-val{font-size:.72rem;color:#aab;font-family:'Black Ops One',sans-serif;margin-top:2px;text-align:right;letter-spacing:1px;}
@keyframes hpShake{0%{transform:translateX(0)}20%{transform:translateX(-5px)}40%{transform:translateX(5px)}60%{transform:translateX(-3px)}80%{transform:translateX(3px)}100%{transform:translateX(0)}}
@keyframes glowCrit{0%,100%{box-shadow:none}50%{box-shadow:0 0 14px #ff2200,0 0 30px #ff220066}}
@keyframes glowCounter{0%,100%{box-shadow:none}50%{box-shadow:0 0 14px #00ff88,0 0 30px #00ff8866}}
@keyframes glowHeal{0%,100%{box-shadow:none}50%{box-shadow:0 0 14px #00ff44,0 0 30px #00ff4488}}
@keyframes glowUltimate{0%{box-shadow:none}30%{box-shadow:0 0 22px #ffcc00,0 0 60px #ffcc0077}70%{box-shadow:0 0 22px #ff8800,0 0 60px #ff880066}100%{box-shadow:none}}
.anim-crit .hp-bar-track{animation:hpShake .4s ease,glowCrit .6s ease;}
.anim-crit .hp-bar-fill{background:linear-gradient(90deg,#880000,#ff2200)!important;transition:none!important;}
.anim-counter .hp-bar-track{animation:glowCounter .7s ease;}
.anim-heal .hp-bar-track{animation:glowHeal .7s ease;}
.anim-ultimate .hp-bar-track{animation:glowUltimate .9s ease;}

/* ‚îÄ‚îÄ‚îÄ BAR FOCUS OVERLAY ‚Äî escurece s√≥ o fundo, barra fica iluminada ‚îÄ‚îÄ‚îÄ */
#battleDimmer{
  display:none;position:fixed;inset:0;z-index:8000;pointer-events:none;
  background:rgba(0,0,0,0);transition:background .2s;
}
#battleDimmer.active{display:block;background:rgba(0,0,0,0.75);}

/* ‚îÄ‚îÄ‚îÄ ULTIMATE TUNNEL / BEAM EFFECT ‚îÄ‚îÄ‚îÄ */
#ultimateCanvas{
  display:none;position:fixed;inset:0;z-index:8100;pointer-events:none;
}
#ultimateCanvas.active{display:block;}

/* ‚îÄ‚îÄ‚îÄ BAR-SIDE EVENT CARD ‚îÄ‚îÄ‚îÄ */
/* Positioned via JS next to the target bar */
#barEventCard{
  display:none;position:fixed;z-index:8500;pointer-events:none;
  min-width:160px;max-width:220px;
  background:rgba(5,5,8,0.97);
  border:2px solid #fff;
  border-radius:14px;
  padding:12px 18px;
  text-align:center;
  opacity:0;
  transform:scale(0.7);
  transition:opacity .2s, transform .25s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 0 40px rgba(255,255,255,0.15), 0 0 0 1px rgba(255,255,255,0.05);
}
#barEventCard.show{display:block;opacity:1;transform:scale(1);}
#barEventCard.hide{opacity:0;transform:scale(0.8);transition:opacity .25s ease-in,transform .25s ease-in;}
#barEventCardType{
  font-family:'Black Ops One',sans-serif;
  font-size:1.15rem;letter-spacing:4px;
  margin-bottom:6px;
  animation:barCardPulse .5s ease-in-out infinite alternate;
}
@keyframes barCardPulse{from{filter:brightness(1);}to{filter:brightness(1.5);}}
#barEventCardName{
  font-family:'Cinzel Decorative',serif;
  font-size:.65rem;letter-spacing:2px;
  color:rgba(255,255,255,0.65);
  margin-bottom:8px;
  line-height:1.4;
}
#barEventCardAmount{
  font-family:'Black Ops One',sans-serif;
  font-size:1.6rem;letter-spacing:2px;
}

/* ‚îÄ‚îÄ‚îÄ BAR FOCUS HIGHLIGHT ‚Äî elevates the bar above the dimmer ‚îÄ‚îÄ‚îÄ */
.hp-char-wrap.bar-focused{
  position:relative;
  z-index:8200;
  filter:drop-shadow(0 0 12px currentColor);
  transform:scale(1.06);
  transition:transform .2s, filter .2s;
}
.hp-char-wrap.team-a-wrap.bar-focused{filter:drop-shadow(0 0 16px #5588ff);}
.hp-char-wrap.team-b-wrap.bar-focused{filter:drop-shadow(0 0 16px #ff4422);}

/* ‚îÄ‚îÄ‚îÄ HP DEAD STATE ‚îÄ‚îÄ‚îÄ */
.hp-char-wrap.dead .hp-char-name{color:#444;text-decoration:line-through;}
.hp-char-wrap.dead .hp-bar-track{opacity:.3;}
.hp-char-wrap.dead .hp-val{color:#333;}
@keyframes deathFlash{
  0%{filter:brightness(3) saturate(0);}
  40%{filter:brightness(0.1) saturate(0);}
  100%{filter:brightness(1) saturate(0) opacity(0.3);}
}
.hp-char-wrap.dying{animation:deathFlash .7s ease forwards;}

/* Event popup - Street Fighter style */
#battleEventPopup{
  position:fixed;top:45%;left:50%;
  transform:translate(-50%,-50%) scale(0);
  z-index:9999;pointer-events:none;
  font-family:'Black Ops One',sans-serif;
  font-size:3.5rem;font-weight:400;
  letter-spacing:6px;text-align:center;
  opacity:0;
  transition:transform .12s cubic-bezier(.34,1.56,.64,1),opacity .15s;
  white-space:nowrap;
}
#battleEventPopup.show{transform:translate(-50%,-50%) scale(1);opacity:1;}
#battleEventPopup.hide{transform:translate(-50%,-50%) scale(1.6);opacity:0;transition:transform .35s ease-in,opacity .35s ease-in;}
#battleEventPopup.ev-counter{
  color:#ff0000;
  -webkit-text-stroke:3px #000;
  text-shadow:
    4px 4px 0 #000,
    -2px -2px 0 #000,
    6px 6px 0 rgba(255,0,0,.4),
    10px 10px 0 rgba(255,0,0,.25),
    16px 16px 0 rgba(255,0,0,.12);
}
#battleEventPopup.ev-crit{
  color:#ff2200;
  -webkit-text-stroke:2px #000;
  text-shadow:0 0 20px #ff2200,0 0 50px #ff220088,4px 4px 0 #000;
}
#battleEventPopup.ev-heal{
  color:#00ff44;
  -webkit-text-stroke:2px #003300;
  text-shadow:0 0 20px #00ff44,0 0 50px #00ff4466,2px 2px 0 #003300;
}
#battleEventPopup.ev-ultimate{
  color:#ffcc00;
  -webkit-text-stroke:2px #000;
  text-shadow:0 0 30px #ffcc00,0 0 70px #ffcc0088,4px 4px 0 #000;
}
@keyframes counterEcho{
  0%{opacity:1;transform:translate(-50%,-50%) scale(1);}
  100%{opacity:0;transform:translate(-50%,-50%) scale(1.8);}
}
.battle-narrative{font-family:'Rajdhani',sans-serif;font-size:1.05rem;font-weight:600;line-height:1.9;color:var(--text);}

/* ‚îÄ‚îÄ‚îÄ BATTLE RESULT ‚îÄ‚îÄ‚îÄ */
#battleResult{display:none;}
#battleResult.visible{display:block;}
.battle-result-box{background:var(--card-bg);border:1px solid var(--border);border-radius:18px;padding:24px;position:relative;overflow:hidden;}
.battle-result-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#ff4400,#ff8800,#ff4400,transparent);}
.battle-winner-banner{text-align:center;padding:20px;margin-bottom:20px;border-radius:14px;background:linear-gradient(135deg,rgba(255,68,0,.1),rgba(255,136,0,.15),rgba(255,68,0,.1));border:1px solid rgba(255,100,0,.3);}
.battle-winner-label{font-family:'Cinzel Decorative',serif;font-size:.7rem;letter-spacing:4px;color:#ff8844;margin-bottom:6px;opacity:.8;}
.battle-winner-name{font-family:'Cinzel Decorative',serif;font-size:1.8rem;color:#fff;text-shadow:0 0 20px #ff6600,0 0 50px rgba(255,100,0,.5);letter-spacing:3px;}
.battle-mvp{display:inline-block;margin-top:10px;padding:4px 16px;border-radius:20px;background:rgba(255,180,0,.15);border:1px solid rgba(255,180,0,.4);color:#ffcc44;font-size:.75rem;font-weight:700;letter-spacing:2px;}
.battle-narrative{font-family:'Rajdhani',sans-serif;font-size:1rem;line-height:1.85;color:var(--text);}
.dmg-tag{display:inline-block;padding:1px 8px;border-radius:5px;font-size:.78rem;font-weight:700;background:rgba(255,60,0,.2);border:1px solid rgba(255,60,0,.4);color:#ff8866;margin:0 2px;font-family:'Exo 2',sans-serif;}
.battle-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px;}
@media(max-width:500px){.battle-stats{grid-template-columns:1fr;}}
.battle-stat-card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px;}
.battle-stat-card h4{color:var(--text2);margin-bottom:10px;font-size:.75rem;}
.battle-stat-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border2);font-size:.82rem;}
.battle-stat-row:last-child{border-bottom:none;}
.battle-stat-val{font-weight:700;color:var(--text);font-family:'Rajdhani',sans-serif;}
.loading-battle{text-align:center;padding:40px 20px;}
.loading-battle .lb-icon{font-size:3rem;animation:spin 1s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-battle p{font-family:'Cinzel Decorative',serif;font-size:.85rem;color:var(--text2);letter-spacing:2px;margin-top:16px;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}

/* ‚îÄ‚îÄ‚îÄ RARITY QUICK-PICKER ‚îÄ‚îÄ‚îÄ */
.skill-rarity-badge{
  position:absolute;right:66px;top:50%;transform:translateY(-50%);
  font-size:.85rem;font-weight:700;font-family:'Exo 2',sans-serif;
  width:18px;height:18px;border-radius:50%;cursor:pointer;
  opacity:0;transition:opacity .15s;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.12);color:rgba(255,255,255,.7);
  border:1px solid rgba(255,255,255,.2);
  z-index:2;user-select:none;line-height:1;
  flex-shrink:0;
}
p.skill-item:hover .skill-rarity-badge { opacity:1; }
p.skill-item.locked .skill-rarity-badge { opacity:.5; }

/* ‚îÄ‚îÄ Rarity QPicker ‚Äî modal centralizado ‚îÄ‚îÄ */
#rarityQPickerOverlay {
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);
  z-index:3000;align-items:center;justify-content:center;
  backdrop-filter:blur(14px);
}
#rarityQPickerOverlay.open { display:flex; }
.rarity-qpicker {
  background:var(--modal-bg);border:1px solid var(--border);
  border-radius:18px;padding:20px 18px 16px;
  width:92vw;max-width:480px;max-height:80vh;
  overflow-y:auto;-webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  box-shadow:0 0 70px var(--shadow),0 0 0 1px rgba(255,255,255,.04);
  position:relative;animation:qpIn .2s ease;
}
.rarity-qpicker::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.5;}
@keyframes qpIn{from{opacity:0;transform:scale(.94) translateY(10px);}to{opacity:1;transform:scale(1) translateY(0);}}
.rarity-qpicker-title{
  font-family:'Cinzel Decorative',serif;font-size:.85rem;letter-spacing:2px;
  color:var(--text);padding:0 4px 12px;border-bottom:1px solid var(--border);margin-bottom:10px;text-align:center;
}
.rarity-qpicker-group { margin-bottom:8px; }
.rarity-qpicker-group-label{
  font-size:.62rem;font-weight:900;letter-spacing:2px;text-transform:uppercase;
  padding:4px 8px;border-radius:6px;margin-bottom:5px;display:inline-block;opacity:.9;border:1px solid transparent;
}
.rarity-qpicker-item{
  padding:7px 11px;border-radius:9px;cursor:pointer;font-size:.84rem;font-family:'Rajdhani',sans-serif;font-weight:600;
  border:1px solid transparent;transition:filter .12s,transform .1s;margin-bottom:3px;
  display:flex;align-items:center;justify-content:space-between;gap:8px;
}
.rarity-qpicker-item:hover{ filter:brightness(1.28);transform:scale(1.01); }
.rarity-qpicker-item .qp-pct{ font-size:.72rem;opacity:.6;flex-shrink:0; }
.rarity-qpicker-close{
  display:block;width:100%;margin-top:12px;padding:9px;
  background:var(--bg4);border:1px solid var(--border);border-radius:10px;
  text-align:center;font-size:.82rem;color:var(--text2);cursor:pointer;
  transition:all .18s;font-family:'Exo 2',sans-serif;font-weight:600;
}
.rarity-qpicker-close:hover{background:var(--bg3);color:var(--text);border-color:var(--text3);}

/* ‚îÄ‚îÄ‚îÄ TTS ENGINE BUTTONS ‚îÄ‚îÄ‚îÄ */
.tts-engine-btn{padding:6px 13px;border-radius:9px;cursor:pointer;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;border:1px solid var(--border);color:var(--text2);background:transparent;transition:all .18s;font-family:'Exo 2',sans-serif;}
.tts-engine-btn:hover{border-color:var(--accent);color:var(--text);}
.tts-engine-btn.active{background:rgba(100,120,255,.2);border-color:#88aaff;color:#88aaff;}

/* ‚îÄ‚îÄ‚îÄ FINALIZACAO OVERLAY ‚îÄ‚îÄ‚îÄ */
.finalizacao-overlay {
  display:none;position:fixed;inset:0;z-index:9500;
  align-items:center;justify-content:center;flex-direction:column;gap:20px;
  pointer-events:none;opacity:0;transition:opacity .35s;
}
.finalizacao-overlay.active {
  display:flex;opacity:1;
}
#finalizacaoTitle {
  font-family:'Black Ops One',sans-serif;
  font-size:clamp(3rem,12vw,7rem);
  letter-spacing:12px;text-align:center;
  animation:finTitleIn .4s cubic-bezier(.34,1.56,.64,1) both;
}
#finalizacaoSub {
  font-family:'Cinzel Decorative',serif;
  font-size:clamp(1rem,4vw,2rem);
  letter-spacing:6px;text-align:center;opacity:0;
  animation:finSubIn .5s .3s ease both;
}
@keyframes finTitleIn {
  0%   { transform:scale(3) rotate(-3deg); opacity:0; filter:blur(20px); }
  100% { transform:scale(1) rotate(0deg);  opacity:1; filter:blur(0); }
}
@keyframes finSubIn {
  0%   { transform:translateY(30px); opacity:0; }
  100% { transform:translateY(0);    opacity:1; }
}
.finalizacao-fatality   #finalizacaoTitle,
.finalizacao-brutality  #finalizacaoTitle { animation:finTitleIn .3s cubic-bezier(.34,1.56,.64,1) both, finShake .5s .3s ease both; }
@keyframes finShake {
  0%,100%{transform:translate(0,0) scale(1);}
  20%{transform:translate(-6px,3px) scale(1.02);}
  40%{transform:translate(6px,-3px) scale(1.02);}
  60%{transform:translate(-4px,4px) scale(1.01);}
  80%{transform:translate(4px,-2px) scale(1.01);}
}


#charPickerOverlay{z-index:2600;}
#charPickerList{display:flex;flex-direction:column;gap:7px;max-height:60vh;overflow-y:auto;margin-top:14px;}
.char-picker-item{padding:10px 14px;border-radius:10px;background:var(--bg3);border:1px solid var(--border);cursor:pointer;transition:all .15s;}
.char-picker-item:hover{border-color:var(--accent);background:var(--glass2);}
.char-picker-item .cpi-name{font-weight:700;font-size:.9rem;font-family:'Rajdhani',sans-serif;color:var(--text);}
.char-picker-item .cpi-skills{font-size:.72rem;color:var(--text3);margin-top:3px;}

</style>
</head>
<body>
<div class="settings-btn" id="fixedSettingsBtn" onclick="openModal('settingsOverlay')" title="Configura√ß√µes" style="position:fixed;top:22px;right:26px;z-index:1500;">‚öôÔ∏è</div>
<div id="shakeWrapper">
<div id="shakeInner">

<div class="topbar">
  <h1>üé≤ Gerador Supremo</h1>
</div>

<div class="main-tabs">
  <button class="main-tab active" onclick="switchMainTab('gerador',this)">üé≤ Gerador</button>
  <button class="main-tab" onclick="switchMainTab('batalha',this)">‚öîÔ∏è Arena de Batalha</button>
</div>

<div id="tab-gerador" class="tab-page active">

<h3>Categorias</h3>
<textarea id="importBox" placeholder="Formato para importar:&#10;NomeDaCategoria&#10;NomeDaSubcategoria&#10;Op√ß√£o Um 5&#10;Op√ß√£o Dois (descri√ß√£o aqui) 20&#10;Op√ß√£o Tres 70&#10;&#10;(n√∫mero no fim = peso)&#10;peso ‚â§ 0.3 ‚Üí AURORA | ‚â§1 ‚Üí OMEGA | ‚â§5 ‚Üí M√çTICA&#10;Entre par√™nteses = descri√ß√£o opcional"></textarea><br>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
  <button class="btn-primary" onclick="importCategory()">üì• Importar Categoria</button>
  <button onclick="createBlankCategory()" style="background:rgba(255,255,255,.07);border-color:#334;color:var(--text);">‚ûï Nova Categoria</button>
</div>
<hr>
<div id="categories"></div>
<br>
<div class="controls-row">
  <label>Quantidade</label>
  <input type="number" id="amount" value="1" min="1">
  <button class="btn-primary" onclick="generateAll()">‚ö° Gerar Todos</button>
  <button onclick="generateOne()">‚ûï Gerar Um</button>
  <button onclick="openBossGen()" style="background:linear-gradient(135deg,#3d0000,#1a0000);border-color:#ff2200;color:#ff6644;font-weight:700;">üíÄ Gerar Chef√£o</button>
  <button onclick="openMultiSpin()" style="background:rgba(255,255,255,.08);border-color:#555577;color:var(--text);">üé∞ Girar Todas</button>
</div>
<div class="characters" id="characters"></div>

<div id="luckPanel">
  <h3 style="margin-bottom:10px;">üçÄ Manipulador de Sorte</h3>
  <div class="luck-tabs">
    <div class="luck-tab active" onclick="switchLuckTab('multiplier',this)">Multiplicador</div>
    <div class="luck-tab" onclick="switchLuckTab('guarantee',this)">Giro Garantido</div>
  </div>
  <div class="luck-section active" id="luck-tab-multiplier">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px;">
      <label style="color:var(--text2);font-size:.77rem;text-transform:uppercase;letter-spacing:1px;">Raridade alvo</label>
      <select id="luckTargetRarity" onchange="updateLuckTag()">
        <option value="">Nenhuma (Normal)</option>
        <option value="aurora">Aurora (‚â§0.3%)</option>
        <option value="omega">Omega (‚â§1%)</option>
        <option value="mitica">M√≠tica (1‚Äì3%)</option>
        <option value="lendaria">Lend√°ria (5‚Äì10%)</option>
        <option value="epica">√âpica (10‚Äì20%)</option>
        <option value="rara">Rara (20‚Äì40%)</option>
        <option value="incomum">Incomum (40‚Äì70%)</option>
        <option value="comum">Comum (&gt;70%)</option>
      </select>
      <label style="color:var(--text2);font-size:.77rem;text-transform:uppercase;letter-spacing:1px;">Multiplicador</label>
      <input type="range" id="luckMultiplier" min="1" max="100" value="1" step="1" style="width:100px;accent-color:var(--accent);" oninput="document.getElementById('luckMultiplierVal').innerText=this.value+'x';updateLuckTag();">
      <span id="luckMultiplierVal" style="color:var(--text);font-weight:700;min-width:38px;">1x</span>
    </div>
    <p style="color:var(--text3);font-size:.74rem;">O peso das op√ß√µes da raridade alvo √© multiplicado antes do sorteio.</p>
    <div><span id="luckActiveTag">‚ú¶ SORTE ATIVA</span></div>
  </div>
  <div class="luck-section" id="luck-tab-guarantee">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px;">
      <label style="color:var(--text2);font-size:.77rem;text-transform:uppercase;letter-spacing:1px;">Raridade garantida</label>
      <select id="guaranteeRarity" onchange="updateGuaranteeTag()">
        <option value="">Nenhuma</option>
        <option value="aurora">Aurora (‚â§0.3%)</option>
        <option value="omega">Omega (‚â§1%)</option>
        <option value="mitica">M√≠tica (1‚Äì3%)</option>
        <option value="lendaria">Lend√°ria (5‚Äì10%)</option>
        <option value="epica">√âpica (10‚Äì20%)</option>
        <option value="rara">Rara (20‚Äì40%)</option>
        <option value="incomum">Incomum (40‚Äì70%)</option>
        <option value="comum">Comum (&gt;70%)</option>
      </select>
    </div>
    <p style="color:var(--text3);font-size:.74rem;">O resultado ser√° <strong style="color:var(--text)">sempre</strong> da raridade escolhida em todos os giros. Para cancelar, selecione "Nenhuma".</p>
    <div><span id="guaranteeActiveTag">üéØ GIRO GARANTIDO ATIVO</span></div>
  </div>
</div>

</div><!-- end tab-gerador -->

<!-- BATTLE TAB -->
<div id="tab-batalha" class="tab-page">

<!-- HP BARS STICKY -->
<div id="battleHpBars">
  <div style="display:grid;grid-template-columns:1fr 60px 1fr;gap:8px;align-items:center;">
    <div id="hpSideA">
      <div style="font-family:'Cinzel Decorative',serif;font-size:.55rem;letter-spacing:2px;color:#5588ff;margin-bottom:5px;text-align:right;">TIME A</div>
      <div id="hpRowA"></div>
    </div>
    <div style="text-align:center;font-family:'Cinzel Decorative',serif;font-size:.8rem;color:rgba(255,255,255,0.15);padding-top:10px;">VS</div>
    <div id="hpSideB">
      <div style="font-family:'Cinzel Decorative',serif;font-size:.55rem;letter-spacing:2px;color:#ff4422;margin-bottom:5px;text-align:left;">TIME B</div>
      <div id="hpRowB"></div>
    </div>
  </div>
</div>

<!-- BATTLE DIM + BAR-SIDE CARD -->
<div id="battleDimmer"></div>
<canvas id="ultimateCanvas"></canvas>
<div id="barEventCard">
  <div id="barEventCardType"></div>
  <div id="barEventCardName"></div>
  <div id="barEventCardAmount"></div>
</div>

<!-- EVENT POPUP -->
<div id="battleEventPopup"></div>

<!-- API KEY -->
<div id="battleApiKeyWrap" style="background:var(--card-bg);border:1px solid rgba(255,160,0,.3);border-radius:14px;padding:16px;margin-bottom:18px;">
  <h3 style="margin-bottom:8px;color:#ffaa44;">üîë Chave da API Groq</h3>
  <p style="font-size:.78rem;color:var(--text3);margin-bottom:10px;">Gratuito! Pegue em <a href="https://console.groq.com/keys" target="_blank" style="color:#4da6ff;">console.groq.com/keys</a> ‚Üí "Create API Key". Salva localmente no seu navegador.</p>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <input type="password" id="battleApiKey" placeholder="gsk_..." style="flex:1;min-width:200px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:.85rem;">
    <button class="btn-primary" onclick="saveBattleApiKey()">üíæ Salvar</button>
    <span id="apiKeyStatus" style="font-size:.75rem;color:var(--text3);"></span>
  </div>
</div>


<!-- TTS CONFIG -->
<div id="ttsConfigWrap" style="background:var(--card-bg);border:1px solid rgba(100,120,255,.25);border-radius:14px;padding:16px;margin-bottom:18px;">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
    <h3 style="margin:0;color:#88aaff;">&#127897; Narra√ß√£o por Voz</h3>
    <div style="display:flex;gap:6px;margin-left:auto;">
      <button id="ttsEngineWeb" class="tts-engine-btn active" onclick="setTtsEngine('web')">&#128266; Web Speech</button>
      <button id="ttsEngineEleven" class="tts-engine-btn" onclick="setTtsEngine('eleven')">&#11088; ElevenLabs</button>
      <button id="ttsEngineOff" class="tts-engine-btn" onclick="setTtsEngine('off')">&#128263; Desligado</button>
    </div>
  </div>
  <div id="ttsWebOptions">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <label style="color:var(--text2);font-size:.78rem;text-transform:uppercase;letter-spacing:1px;">Voz</label>
      <select id="ttsVoiceSelect" style="flex:1;min-width:180px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);font-family:Exo 2,sans-serif;font-size:.82rem;"></select>
      <label style="color:var(--text2);font-size:.78rem;text-transform:uppercase;letter-spacing:1px;">Vel.</label>
      <input type="range" id="ttsRate" min="0.6" max="1.6" step="0.05" value="0.95" style="width:80px;accent-color:var(--accent);" oninput="document.getElementById('ttsRateVal').textContent=parseFloat(this.value).toFixed(2)+'x'">
      <span id="ttsRateVal" style="color:var(--text);font-weight:700;min-width:38px;font-size:.8rem;">0.95x</span>
      <label style="color:var(--text2);font-size:.78rem;text-transform:uppercase;letter-spacing:1px;">Tom</label>
      <input type="range" id="ttsPitch" min="0.5" max="1.8" step="0.05" value="0.88" style="width:80px;accent-color:var(--accent);" oninput="document.getElementById('ttsPitchVal').textContent=parseFloat(this.value).toFixed(2)">
      <span id="ttsPitchVal" style="color:var(--text);font-weight:700;min-width:32px;font-size:.8rem;">0.88</span>
    </div>
    <p style="color:var(--text3);font-size:.74rem;margin-top:8px;">Fala cada frase conforme aparece. Funciona offline, sem chave.</p>
  </div>
  <div id="ttsElevenOptions" style="display:none;">
    <p style="font-size:.78rem;color:var(--text3);margin-bottom:8px;">Chave em <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" style="color:#4da6ff;">elevenlabs.io</a> - Tier gratuito: 10.000 chars/mes.</p>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
      <input type="password" id="elevenApiKey" placeholder="sk_..." style="flex:1;min-width:200px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:Exo 2,sans-serif;font-size:.85rem;">
      <button class="btn-primary" onclick="saveElevenKey()">Salvar</button>
      <span id="elevenKeyStatus" style="font-size:.75rem;color:var(--text3);"></span>
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <label style="color:var(--text2);font-size:.78rem;text-transform:uppercase;letter-spacing:1px;">Voice ID</label>
      <input type="text" id="elevenVoiceId" placeholder="21m00Tcm4TlvDq8ikWAM (Rachel)" style="flex:1;min-width:200px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);font-family:Exo 2,sans-serif;font-size:.82rem;">
    </div>
    <p style="color:var(--text3);font-size:.72rem;margin-top:6px;">Narra o texto completo ao final da batalha.</p>
  </div>
</div>
<!-- ARENA -->
<div class="battle-arena">
  <!-- TEAM A -->
  <div class="battle-team battle-team-a">
    <div class="battle-team-title">‚öî TIME A</div>
    <div id="teamASlots"></div>
    <button class="battle-add-btn" id="addTeamABtn" onclick="openCharPicker('A')">Ôºã Adicionar Personagem</button>
  </div>

  <div class="battle-vs">VS</div>

  <!-- TEAM B -->
  <div class="battle-team battle-team-b">
    <div class="battle-team-title">üõ° TIME B</div>
    <div id="teamBSlots"></div>
    <button class="battle-add-btn" id="addTeamBBtn" onclick="openCharPicker('B')">Ôºã Adicionar Personagem</button>
  </div>
</div>

<!-- SCENARIO -->
<div id="battleScenarioWrap" style="background:var(--card-bg);border:1px solid var(--border2);border-radius:14px;padding:16px;margin-bottom:16px;">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
    <span style="font-size:1.1rem;">üåç</span>
    <h3 style="margin:0;font-size:.85rem;letter-spacing:2px;">CENARIO DA BATALHA</h3>
    <span style="font-size:.7rem;color:var(--text3);margin-left:auto;font-style:italic;">opcional</span>
  </div>
  <textarea id="battleScenario" placeholder="Descreva onde a batalha acontece... Ex: Uma floresta negra encantada, ruinas de uma cidade flutuante, o interior de uma estrela colapsando..." style="width:100%;height:80px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:.85rem;resize:vertical;transition:border-color .2s;"></textarea>
  <div style="display:flex;gap:7px;flex-wrap:wrap;margin-top:9px;">
    <span style="font-size:.7rem;color:var(--text3);align-self:center;">Sugestoes:</span>
    <button onclick="setScenario(this)" style="font-size:.72rem;padding:4px 10px;margin:2px;">Vulcao ativo</button>
    <button onclick="setScenario(this)" style="font-size:.72rem;padding:4px 10px;margin:2px;">Fundo do oceano</button>
    <button onclick="setScenario(this)" style="font-size:.72rem;padding:4px 10px;margin:2px;">Espaco sideral</button>
    <button onclick="setScenario(this)" style="font-size:.72rem;padding:4px 10px;margin:2px;">Arena medieval</button>
    <button onclick="setScenario(this)" style="font-size:.72rem;padding:4px 10px;margin:2px;">Dimensao do caos</button>
    <button onclick="setScenario(this)" style="font-size:.72rem;padding:4px 10px;margin:2px;">Cidade cyberpunk</button>
  </div>
</div>

<div style="display:flex;gap:10px;margin-bottom:20px;">
  <button class="battle-start-btn" id="battleStartBtn" onclick="startBattle()" disabled style="margin-bottom:0;flex:1;">INICIAR BATALHA</button>
  <button id="battleStopBtn" onclick="stopBattle()" style="display:none;padding:16px 20px;border-radius:14px;border:1px solid #ff4422;background:rgba(180,30,30,.2);color:#ff6655;font-family:'Cinzel Decorative',serif;font-size:.75rem;letter-spacing:2px;cursor:pointer;white-space:nowrap;">PARAR</button>
</div>
<div id="battleResult">
  <div class="battle-result-box" id="battleResultBox"></div>
</div>

</div><!-- end tab-batalha -->

<div id="rarityQPickerOverlay" onclick="if(event.target===this)closeRarityQPicker()">
  <div id="rarityQPicker" class="rarity-qpicker"></div>
</div>

<!-- FINALIZACAO OVERLAY -->
<div id="finalizacaoOverlay" class="finalizacao-overlay">
  <div id="finalizacaoTitle"></div>
  <div id="finalizacaoSub"></div>
</div>

</div><!-- end shakeInner -->
</div><!-- end shakeWrapper -->

<!-- CHAR PICKER MODAL -->
<div class="modal-overlay" id="charPickerOverlay">
  <div class="modal-box" style="max-width:480px;max-height:85vh;overflow-y:auto;">
    <div class="modal-title">üë§ Selecionar Personagem</div>
    <p style="font-size:.78rem;color:var(--text3);">Escolha um personagem gerado para adicionar ao time.</p>
    <div id="charPickerList"></div>
    <div class="modal-actions" style="margin-top:14px;">
      <button onclick="closeModal('charPickerOverlay')">Cancelar</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsOverlay">
  <div class="modal-box" id="settingsModal">
    <div class="modal-title">‚öô Configura√ß√µes</div>
    <h4 style="margin-bottom:8px;color:var(--text2);">Tema</h4>
    <div class="theme-picker">
      <div class="theme-option dark" onclick="setTheme('dark',this)"><div style="font-size:1.2rem;margin-bottom:4px;">üåë</div>Dark</div>
      <div class="theme-option midnight" onclick="setTheme('midnight',this)"><div style="font-size:1.2rem;margin-bottom:4px;">üåå</div>Midnight</div>
      <div class="theme-option light" onclick="setTheme('light',this)"><div style="font-size:1.2rem;margin-bottom:4px;">‚òÄÔ∏è</div>Light</div>
    </div>
    <hr style="margin:14px 0;">
    <h4 style="margin-bottom:8px;color:var(--text2);">Roleta</h4>
    <div style="display:flex;flex-direction:column;gap:9px;">
      <div class="rc-row"><label>‚è± Dura√ß√£o</label><input type="range" id="rcDuration" min="1500" max="10000" value="4500" step="100" oninput="document.getElementById('rcDurationVal').innerText=(this.value/1000).toFixed(1)+'s'"><span id="rcDurationVal">4.5s</span></div>
      <div class="rc-row"><label>üîÑ Voltas m√≠n.</label><input type="range" id="rcSpins" min="2" max="20" value="8" step="1" oninput="document.getElementById('rcSpinsVal').innerText=this.value+'√ó'"><span id="rcSpinsVal">8√ó</span></div>
    </div>
    <hr style="margin:14px 0;">
    <h4 style="margin-bottom:8px;color:var(--text2);">Anima√ß√µes</h4>
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;">
      <span style="color:var(--text);font-size:.88rem;">‚ú® Cutscenes de raridade</span>
      <div id="cutsceneToggle" onclick="toggleCutscenes()" style="width:44px;height:24px;border-radius:12px;background:var(--accent);cursor:pointer;position:relative;transition:background .25s;flex-shrink:0;">
        <div id="cutsceneToggleKnob" style="position:absolute;top:3px;left:23px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .25s;box-shadow:0 1px 4px rgba(0,0,0,.4);"></div>
      </div>
    </div>
    <hr style="margin:14px 0;">
    <h4 style="margin-bottom:8px;color:var(--text2);">Dados</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button onclick="exportJSON()">üì§ Exportar JSON</button>
      <button onclick="document.getElementById('importFileInput').click()">üì• Importar JSON</button>
      <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="importFromFile(event)">
      <button class="btn-danger" onclick="confirmModal('Limpar tudo','Apagar todas as categorias? Isso n√£o pode ser desfeito.',()=>{categories=[];autoSave();renderCategories();showToast('üóë Categorias apagadas.');})">üóë Limpar tudo</button>
    </div>
    <div class="modal-actions" style="margin-top:16px;"><button class="btn-primary" onclick="closeModal('settingsOverlay')">Fechar</button></div>
  </div>
</div>

<!-- ROULETTE -->
<div id="rouletteOverlay" onclick="if(event.target===this&&!rouletteSpin)closeRoulette()">
  <div id="rouletteModal" onclick="event.stopPropagation()">
    <div id="rouletteFlash"></div>
    <div id="rouletteBigResult">
      <div id="rouletteBigGlow"></div>
      <div id="rouletteBigResultText"></div>
      <div id="rouletteBigResultSub"></div>
    </div>
    <h2 id="rouletteTitle">Roleta</h2>
    <div id="rouletteCanvasWrap" onclick="handleCanvasClick()">
      <div id="roulettePointer"></div>
      <canvas id="rouletteCanvas" width="290" height="290"></canvas>
      <div id="spinHint">‚ñ∂</div>
    </div>
    <div id="rouletteResult"></div>
    <button id="rouletteCloseBtn" onclick="closeRoulette()">‚úï Fechar</button>
  </div>
</div>

<!-- SKILL PICKER -->
<div class="modal-overlay" id="skillPickerOverlay" onclick="if(event.target===this)closeModal('skillPickerOverlay')">
  <div class="modal-box" id="skillPickerModal" onclick="event.stopPropagation()">
    <div class="modal-title" id="skillPickerTitle">‚ú¶ Escolher Habilidade</div>
    <div id="skillPickerCats" class="skill-picker-cats"></div>
    <div class="modal-actions" style="margin-top:12px;"><button onclick="closeModal('skillPickerOverlay')">Cancelar</button></div>
  </div>
</div>

<!-- RENAME MODAL -->
<div class="modal-overlay" id="renameOverlay">
  <div class="modal-box">
    <div class="modal-title" id="renameTitle">Renomear</div>
    <input class="modal-input" type="text" id="renameInput" placeholder="Novo nome...">
    <div class="modal-actions">
      <button onclick="closeModal('renameOverlay')">Cancelar</button>
      <button class="btn-primary" onclick="confirmRename()">Confirmar</button>
    </div>
  </div>
</div>

<!-- EDIT SUBCATEGORY -->
<div class="modal-overlay" id="editSubOverlay">
  <div class="modal-box" style="max-width:510px;max-height:80vh;overflow-y:auto;">
    <div class="modal-title" id="editSubTitle">Editar Subcategoria</div>
    <div id="editOptionsList" class="edit-options-list"></div>
    <div style="display:flex;gap:7px;margin-bottom:10px;">
      <input class="modal-input" type="text" id="newOptName" placeholder="Nome da op√ß√£o..." style="flex:1;margin:0;">
      <input class="modal-input" type="number" id="newOptWeight" placeholder="Peso" style="width:80px;margin:0;">
      <button onclick="addNewOption()" class="btn-primary" style="margin:0;">+</button>
    </div>
    <div class="modal-actions"><button onclick="closeModal('editSubOverlay')">Fechar</button></div>
  </div>
</div>

<!-- CONFIRM -->
<div class="modal-overlay" id="confirmOverlay">
  <div class="modal-box" style="max-width:360px;">
    <div class="modal-title" id="confirmTitle">Confirmar</div>
    <p id="confirmMsg" style="color:var(--text2);font-size:.86rem;margin-bottom:14px;line-height:1.5;"></p>
    <div class="modal-actions">
      <button onclick="closeModal('confirmOverlay')">Cancelar</button>
      <button class="btn-danger" id="confirmYesBtn">Confirmar</button>
    </div>
  </div>
</div>

<!-- MULTI SPIN OVERLAY -->
<div id="multiSpinOverlay">
  <div id="multiSpinInner">
    <div id="multiSpinTitle">üé∞ Girar Todas as Habilidades</div>
    <div style="text-align:center;margin-bottom:6px;display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;">
      <label style="color:var(--text2);font-size:.8rem;text-transform:uppercase;letter-spacing:1px;">Personagem:</label>
      <select id="multiSpinCharSelect" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:5px 9px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:.82rem;" onchange="onMultiSpinCharChange()"></select>
      <button id="multiSpinStartBtn" class="btn-primary" onclick="startMultiSpin()">‚ñ∂ Girar</button>
      <button id="multiSpinCloseBtn" onclick="closeMultiSpin()">‚úï Fechar</button>
    </div>
    <div id="multiSpinGrid"></div>
  </div>
</div>

<!-- GUARANTEE BADGE -->
<div id="guaranteePersistBadge" onclick="clearGuarantee()">
  <span id="guaranteeBadgeText">üéØ GARANTIDO: ‚Äî</span>
  <span style="opacity:.5;font-size:.65rem;">‚úï</span>
</div>

<!-- FX -->
<canvas id="particlesCanvas"></canvas>
<div id="omegaRitual">
  <canvas id="omegaBeamCanvas"></canvas>
  <div id="omegaRitualText">Œ©</div>
</div>
<div id="miticaOverlay">
  <canvas id="miticaCanvas"></canvas>
  <div id="miticaText">‚ú¶ M√çTICA ‚ú¶</div>
</div>
<div id="auroraOverlay">
  <canvas id="auroraCanvas"></canvas>
  <div id="auroraRevealText">‚ú¶ AURORA ‚ú¶</div>
</div>

<!-- RARITY REVEAL OVERLAY -->
<div id="rarityRevealOverlay">
  <div id="rarityRevealGlow"></div>
  <div id="rarityRevealText"></div>
  <div id="rarityRevealSub"></div>
</div>

<!-- BOSS GENERATOR MODAL -->
<div class="modal-overlay" id="bossGenOverlay">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-title" style="color:#ff4422;">üíÄ Gerador de Chef√£o</div>
    <p style="color:var(--text2);font-size:.8rem;margin-bottom:14px;line-height:1.6;">Gera um personagem com raridades for√ßadas conforme a dificuldade. Se uma subcategoria n√£o tiver op√ß√µes compat√≠veis, usa a mais rara dispon√≠vel.</p>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
      <div id="bossDiffFacil" class="boss-diff-btn" onclick="selectBossDiff('facil',this)">
        <span style="font-size:1.1rem;">üü¢</span>
        <div><div style="font-weight:700;color:#44ff88;letter-spacing:1px;">F√ÅCIL</div><div style="font-size:.74rem;color:var(--text2);">Comum ‚Üí Aurora (qualquer raridade)</div></div>
      </div>
      <div id="bossDiffMedio" class="boss-diff-btn" onclick="selectBossDiff('medio',this)">
        <span style="font-size:1.1rem;">üü°</span>
        <div><div style="font-weight:700;color:#ffcc44;letter-spacing:1px;">M√âDIO</div><div style="font-size:.74rem;color:var(--text2);">√âpico ‚Üí Aurora (m√≠n. √©pico)</div></div>
      </div>
      <div id="bossDiffDificil" class="boss-diff-btn" onclick="selectBossDiff('dificil',this)">
        <span style="font-size:1.1rem;">üî¥</span>
        <div><div style="font-weight:700;color:#ff4422;letter-spacing:1px;">DIF√çCIL</div><div style="font-size:.74rem;color:var(--text2);">M√≠tico ‚Üí Aurora (m√≠n. m√≠tico)</div></div>
      </div>
    </div>
    <div class="modal-actions">
      <button onclick="closeModal('bossGenOverlay')">Cancelar</button>
      <button id="bossGenBtn" class="btn-primary" style="background:linear-gradient(135deg,#3d0000,#6d0000);border-color:#ff2200;box-shadow:0 0 18px rgba(255,34,0,.3);" onclick="generateBoss()" disabled>üíÄ Gerar Chef√£o</button>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="saveIndicator">üíæ salvo</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RARIDADES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getRarity(p){
  if(p<=0.3)return'aurora';if(p<=1)return'omega';if(p<=3)return'mitica';
  if(p<=10)return'lendaria';if(p<=20)return'epica';if(p<=40)return'rara';
  if(p<=70)return'incomum';return'comum';
}
const RS={
  aurora:{bg:'linear-gradient(135deg,#08001a,#120030,#08001a)',border:'#ff0080',tc:'#ffffff',fill:'#0a0018',label:'AURORA',glow:'rgba(255,0,128,.7)',isAurora:true},
  omega:{bg:'linear-gradient(135deg,#000,#111,#000)',border:'#ffffff',tc:'#ffffff',fill:'#0a0a0a',label:'OMEGA',glow:'rgba(255,255,255,.6)'},
  mitica:{bg:'linear-gradient(135deg,#1a0000,#3d0000,#1a0000)',border:'#ff2200',tc:'#ff8888',fill:'#2a0000',label:'M√çTICA',glow:'rgba(255,0,0,.6)'},
  lendaria:{bg:'linear-gradient(135deg,#1a1000,#3d2800,#1a1000)',border:'#e8a020',tc:'#ffd080',fill:'#3d2800',label:'LEND√ÅRIA',glow:null},
  epica:{bg:'linear-gradient(135deg,#0d0020,#2a0060,#0d0020)',border:'#9b45d0',tc:'#cc88ff',fill:'#2a0060',label:'√âPICA',glow:null},
  rara:{bg:'linear-gradient(135deg,#00081a,#001a50,#00081a)',border:'#2266dd',tc:'#88aaff',fill:'#001a50',label:'RARA',glow:null},
  incomum:{bg:'linear-gradient(135deg,#001a08,#003a18,#001a08)',border:'#22aa55',tc:'#66ff99',fill:'#003a18',label:'INCOMUM',glow:null},
  comum:{bg:'linear-gradient(135deg,#111118,#1a1a25,#111118)',border:'#404055',tc:'#8888a0',fill:'#141420',label:'COMUM',glow:null},
};
function applyRarityToEl(el,p){
  const r=getRarity(p),s=RS[r];
  el.style.background=s.bg;el.style.border='1px solid '+s.border;el.style.color=s.tc;
  el.style.backgroundSize='';el.style.animation='none';el.classList.remove('rarity-aurora');
  if(r==='aurora')el.classList.add('rarity-aurora');
  else if(r==='omega')el.style.animation='tremorOmega .55s infinite, neonOmega 1.5s ease-in-out infinite';
  else if(r==='mitica')el.style.animation='tremorMitica .5s infinite, neonMitica 1.2s ease-in-out infinite';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THEME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setTheme(t,el){
  document.documentElement.setAttribute('data-theme',t);localStorage.setItem('gs-theme',t);
  document.querySelectorAll('.theme-option').forEach(o=>o.classList.remove('active'));
  if(el)el.classList.add('active');
}
(()=>{const s=localStorage.getItem('gs-theme')||'dark';document.documentElement.setAttribute('data-theme',s);const o=document.querySelector('.theme-option.'+s);if(o)o.classList.add('active');})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTOSAVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const AUTOSAVE_KEY='gs-autosave';
const PINNED_KEY='gs-pinned';
let _saveTimer=null;

function serializePinnedChars(){
  const pinned=[];
  document.querySelectorAll('.character.pinned').forEach(char=>{
    const nm=char.querySelector('.char-name');
    const isBoss=char.querySelector('.char-skills-col p.boss-skill')!==null;
    const skills=[];
    char.querySelectorAll('p.skill-item').forEach(p=>{
      skills.push({
        sub:p.dataset.sub||'',
        catName:p.dataset.catName||'',
        percent:p.dataset.percent||'',
        resultName:p.dataset.resultName||'',
        desc:p.dataset.desc||'',
        locked:p.classList.contains('locked'),
        style:p.getAttribute('style')||'',
        classList:[...p.classList],
        isBoss:p.classList.contains('boss-skill'),
      });
    });
    /* boss badge */
    const badge=char.querySelector('.charHeader span[style*="border-radius:20px"]');
    pinned.push({
      name:nm?nm.innerText:'Personagem',
      nameColor:nm?nm.style.color:'',
      isBoss,
      bossBadge:badge?badge.innerText:'',
      bossColor:badge?badge.style.color:'',
      charStyle:char.getAttribute('style')||'',
      skills,
    });
  });
  return pinned;
}

function restorePinnedChars(data){
  if(!data||!data.length)return;
  data.forEach(cd=>{
    const char=document.createElement('div');char.className='character pinned';
    char._lockedRarities={};
    if(cd.charStyle)char.setAttribute('style',cd.charStyle);
    const hdr=document.createElement('div');hdr.className='charHeader';
    const nm=document.createElement('span');nm.className='char-name';nm.innerText=cd.name;
    if(cd.nameColor)nm.style.color=cd.nameColor;
    nm.onclick=()=>promptModal('Renomear Personagem',nm.innerText,v=>{nm.innerText=v;nm.style.color='';savePinned();});
    hdr.appendChild(nm);
    if(cd.isBoss){
      [{i:'üìå',t:'Fixar',f:()=>{char.classList.toggle('pinned');savePinned();showToast(char.classList.contains('pinned')?'üìå Fixado.':'Desafixado.');}},{i:'üóë',t:'Deletar',f:()=>{if(!char.classList.contains('pinned'))char.remove();savePinned();}},{i:'üìã',t:'Copiar',f:()=>copyChar(char)}].forEach(({i,t,f})=>{const s=document.createElement('span');s.className='icon-btn';s.innerText=i;s.title=t;s.onclick=f;hdr.appendChild(s);});
      if(cd.bossBadge){const badge=document.createElement('span');badge.style.cssText='font-size:.65rem;font-weight:700;padding:2px 9px;border-radius:20px;letter-spacing:1px;border:1px solid '+cd.bossColor+';color:'+cd.bossColor+';background:'+cd.bossColor+'18;';badge.innerText=cd.bossBadge;hdr.appendChild(badge);}
    } else {
      const lockAllBtn=document.createElement('span');lockAllBtn.className='icon-btn lock-all-btn';lockAllBtn.innerText='üîí';lockAllBtn.title='Fixar/Desfixar todas as raridades';lockAllBtn.onclick=()=>toggleLockAll(char,lockAllBtn);hdr.appendChild(lockAllBtn);
      [{i:'‚ûï',t:'Adicionar',f:()=>openSkillPicker(char,null,null)},{i:'üìå',t:'Fixar Personagem',f:()=>{char.classList.toggle('pinned');savePinned();showToast(char.classList.contains('pinned')?'üìå Fixado.':'Desafixado.');}},{i:'üóë',t:'Deletar',f:()=>{if(!char.classList.contains('pinned'))char.remove();}},{i:'üìã',t:'Copiar',f:()=>copyChar(char)}].forEach(({i,t,f})=>{const s=document.createElement('span');s.className='icon-btn';s.innerText=i;s.title=t;s.onclick=f;hdr.appendChild(s);});
    }
    char.appendChild(hdr);
    const contentWrap=document.createElement('div');contentWrap.className='char-with-desc';
    const skillsCol=document.createElement('div');skillsCol.className='char-skills-col';
    const descPanel=document.createElement('div');descPanel.className='char-desc-panel';descPanel.style.display='none';
    contentWrap.appendChild(skillsCol);contentWrap.appendChild(descPanel);
    char.appendChild(contentWrap);
    char._descPanel=descPanel;char._skillsCol=skillsCol;
    /* category headers + skills */
    let lastCat='';
    cd.skills.forEach(sk=>{
      if(sk.catName&&sk.catName!==lastCat){lastCat=sk.catName;const ct=document.createElement('h4');ct.innerText='‚Äî '+sk.catName+' ‚Äî';ct.style.marginTop='9px';skillsCol.appendChild(ct);}
      const p=document.createElement('p');
      p.className='skill-item'+(sk.isBoss?' boss-skill':'');
      p.dataset.sub=sk.sub;p.dataset.catName=sk.catName;
      p.dataset.percent=sk.percent;p.dataset.resultName=sk.resultName;p.dataset.desc=sk.desc;
      if(!sk.isBoss){
        const clearBtn=document.createElement('span');clearBtn.className='skill-clear-btn';clearBtn.innerText='‚úï';clearBtn.title='Limpar resultado';
        const lockBtn=document.createElement('span');lockBtn.className='skill-lock-btn';lockBtn.innerText='üîí';lockBtn.title='Fixar raridade';
        const subRef=categories.flatMap(c=>c.subcategories).find(s=>s.name===sk.sub)||{name:sk.sub,options:[]};
        clearBtn.onclick=(e)=>{e.stopPropagation();clearSkill(p,char,subRef);savePinned();};
        lockBtn.onclick=(e)=>{e.stopPropagation();toggleSkillLock(p,char,subRef);savePinned();};
        p.appendChild(clearBtn);p.appendChild(lockBtn);
      }
      const isEmpty=!sk.percent;
      const textNode=document.createTextNode(isEmpty?sk.sub+': ‚Äî (clique para girar)':sk.sub+': '+sk.resultName+' ('+parseFloat(sk.percent).toFixed(2)+'%)');
      const firstBtn=p.querySelector('.skill-clear-btn')||null;
      p.insertBefore(textNode,firstBtn);
      if(isEmpty){p.classList.add('empty-slot');p.style.cssText='background:var(--bg3);border:1px solid var(--border2);color:var(--text3);animation:none;';}
      else{
        if(sk.style)p.setAttribute('style',sk.style);
        sk.classList.forEach(c=>{if(c!=='skill-item'&&c!=='boss-skill')p.classList.add(c);});
        if(sk.locked){p.classList.add('locked');char._lockedRarities[sk.sub]=getRarity(parseFloat(sk.percent));}
      }
      if(!sk.isBoss){
        const subRef=categories.flatMap(c=>c.subcategories).find(s=>s.name===sk.sub)||{name:sk.sub,options:[]};
        attachSkillClick(p,subRef,char);
      }
      skillsCol.appendChild(p);
    });
    document.getElementById('characters').appendChild(char);
    charCount++;
    updateCharDescPanel(char);
  });
}

function savePinned(){
  try{localStorage.setItem(PINNED_KEY,JSON.stringify(serializePinnedChars()));}catch(e){}
}

function autoSave(){
  clearTimeout(_saveTimer);
  _saveTimer=setTimeout(()=>{
    try{
      localStorage.setItem(AUTOSAVE_KEY,JSON.stringify(categories));
      savePinned();
      const ind=document.getElementById('saveIndicator');
      ind.classList.add('flash');clearTimeout(ind._t);ind._t=setTimeout(()=>ind.classList.remove('flash'),1200);
    }catch(e){showToast('‚ö† Falha ao salvar (localStorage cheio?)');}
  },600);
}
function loadAutoSave(){
  try{const d=localStorage.getItem(AUTOSAVE_KEY);if(d){categories=JSON.parse(d);renderCategories();}}
  catch(e){}
  try{const p=localStorage.getItem(PINNED_KEY);if(p){restorePinnedChars(JSON.parse(p));}}
  catch(e){}
}
function exportJSON(){
  if(!categories.length){showToast('‚ö† Nenhuma categoria para exportar!');return;}
  const b=new Blob([JSON.stringify({name:'Gerador Supremo',ts:new Date().toISOString(),categories},null,2)],{type:'application/json'});
  const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='gerador-supremo-'+Date.now()+'.json';a.click();URL.revokeObjectURL(u);
  showToast('üì§ JSON exportado!');
}
function importFromFile(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    try{
      const p=JSON.parse(ev.target.result);
      let d=Array.isArray(p)?p:p.categories;
      if(!d||!d.length){showToast('‚ö† JSON inv√°lido!');return;}
      confirmModal('Importar JSON','Substituir√° categorias atuais. Continuar?',()=>{categories=d;autoSave();renderCategories();showToast('üì• '+d.length+' categoria(s) importada(s)!');});
    }catch{showToast('‚ö† Erro ao ler JSON!');}
  };r.readAsText(f);e.target.value='';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let renameCallback=null;
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function promptModal(title,val,cb){
  document.getElementById('renameTitle').innerText=title;
  document.getElementById('renameInput').value=val||'';
  renameCallback=cb;openModal('renameOverlay');
  setTimeout(()=>document.getElementById('renameInput').focus(),80);
}
function confirmRename(){
  const v=document.getElementById('renameInput').value.trim();
  if(v&&renameCallback)renameCallback(v);
  closeModal('renameOverlay');renameCallback=null;
}
document.getElementById('renameInput').addEventListener('keydown',e=>{if(e.key==='Enter')confirmRename();});
function confirmModal(title,msg,cb){
  document.getElementById('confirmTitle').innerText=title;
  document.getElementById('confirmMsg').innerText=msg;
  document.getElementById('confirmYesBtn').onclick=()=>{closeModal('confirmOverlay');cb();};
  openModal('confirmOverlay');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showToast(msg,dur=2000){
  const t=document.getElementById('toast');t.innerText=msg;t.classList.add('show');
  clearTimeout(t._tid);t._tid=setTimeout(()=>t.classList.remove('show'),dur);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COPY TO CLIPBOARD ‚Äî fallback robusto + feedback visual ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function copyToClipboard(text,successMsg){
  function flashGreen(){
    const fl=document.createElement('div');
    fl.style.cssText='position:fixed;inset:0;background:rgba(34,200,90,.15);z-index:9999;pointer-events:none;border:3px solid #22c85a;transition:opacity .5s;opacity:1;';
    document.body.appendChild(fl);
    requestAnimationFrame(()=>requestAnimationFrame(()=>{fl.style.opacity='0';setTimeout(()=>fl.remove(),500);}));
  }
  function onSuccess(){showToast(successMsg||'üìã Copiado!',2500);flashGreen();}
  function onFail(e){console.error('Clipboard:',e);showToast('‚ö† Falha ao copiar.',3000);}
  function execFallback(){
    try{
      const ta=document.createElement('textarea');
      ta.value=text;ta.style.cssText='position:fixed;top:-9999px;left:-9999px;opacity:0;';
      document.body.appendChild(ta);ta.focus();ta.select();
      const ok=document.execCommand('copy');
      document.body.removeChild(ta);
      ok?onSuccess():onFail('execCommand=false');
    }catch(e2){onFail(e2);}
  }
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(onSuccess).catch(execFallback);
  } else {
    execFallback();
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LUCK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchLuckTab(tab,el){
  document.querySelectorAll('.luck-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.luck-section').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');document.getElementById('luck-tab-'+tab).classList.add('active');
}
function updateLuckTag(){
  const r=document.getElementById('luckTargetRarity').value,m=parseFloat(document.getElementById('luckMultiplier').value)||1;
  const tag=document.getElementById('luckActiveTag');
  if(r&&m>1){const s=RS[r];tag.style.cssText='background:rgba(0,0,0,.4);border:1px solid '+s.border+';color:'+s.tc+';opacity:1;display:inline-block;padding:3px 11px;border-radius:20px;font-size:.7rem;font-weight:700;letter-spacing:1px;margin-top:5px;';tag.innerText='‚ú¶ SORTE: '+s.label+' √ó'+m;tag.classList.add('on');}
  else tag.classList.remove('on');
}
function updateGuaranteeTag(){
  const r=document.getElementById('guaranteeRarity').value;
  const tag=document.getElementById('guaranteeActiveTag'),badge=document.getElementById('guaranteePersistBadge'),bt=document.getElementById('guaranteeBadgeText');
  if(r){
    const s=RS[r];
    tag.style.cssText='background:rgba(0,0,0,.4);border:1px solid '+s.border+';color:'+s.tc+';opacity:1;display:inline-block;padding:3px 11px;border-radius:20px;font-size:.7rem;font-weight:700;letter-spacing:1px;margin-top:5px;';
    tag.innerText='üéØ GARANTIDO: '+s.label;tag.classList.add('on');
    badge.style.cssText='background:rgba(0,0,0,.85);border:1px solid '+s.border+';color:'+s.tc+';box-shadow:0 0 20px '+s.border+'55;display:flex;align-items:center;gap:8px;padding:6px 16px 6px 10px;border-radius:20px;font-size:.74rem;font-weight:700;letter-spacing:1px;font-family:Exo 2,sans-serif;cursor:pointer;transition:all .2s;white-space:nowrap;position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:500;';
    bt.innerText='üéØ GARANTIDO: '+s.label;badge.classList.add('visible');
  }else{tag.classList.remove('on');badge.classList.remove('visible');badge.style.display='none';}
}
function getLuck(){return{r:document.getElementById('luckTargetRarity').value,m:parseFloat(document.getElementById('luckMultiplier').value)||1};}
function getGuarantee(){return document.getElementById('guaranteeRarity').value||null;}
function clearGuarantee(){document.getElementById('guaranteeRarity').value='';updateGuaranteeTag();showToast('üéØ Garantia cancelada.');}

function normalize(opts){const tot=opts.reduce((s,o)=>s+o.weight,0);return opts.map(o=>({name:o.name,percent:(o.weight/tot)*100,desc:o.desc||''}));}
function sortOptions(o){o.sort((a,b)=>b.weight-a.weight);}
function applyLuck(n){
  const{r,m}=getLuck();if(!r||m===1)return n;
  const b=n.map(o=>({...o,lw:(getRarity(o.percent)===r?o.percent*m:o.percent)}));
  const tot=b.reduce((s,o)=>s+o.lw,0);return b.map(o=>({...o,percent:(o.lw/tot)*100}));
}
function rollFromNormalized(n,guarantee){
  if(guarantee){
    const matching=n.filter(o=>getRarity(o.percent)===guarantee);
    if(matching.length){const tot=matching.reduce((s,o)=>s+o.percent,0);let r=Math.random()*tot;for(const o of matching){if(r<o.percent)return o;r-=o.percent;}return matching[0];}
  }
  const ln=applyLuck(n);let r=Math.random()*100;
  for(let i=0;i<ln.length;i++){if(r<ln[i].percent)return n[i];r-=ln[i].percent;}return n[n.length-1];
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CATEGORIES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let categories=[],charCount=1;

function importCategory(){
  const text=document.getElementById('importBox').value.trim();if(!text)return;
  const lines=text.split('\n'),name=lines[0].trim();
  const newCat={name,subcategories:[],collapsed:false};let cur=null;
  for(let i=1;i<lines.length;i++){
    const line=lines[i].trim();if(!line)continue;
    const parts=line.split(' '),w=parseFloat(parts[parts.length-1]);
    if(!isNaN(w)&&parts.length>1){
      parts.pop();
      let optName=parts.join(' ');
      let desc='';
      const descMatch=optName.match(/^(.*?)\s*\(([^)]+)\)\s*$/);
      if(descMatch){optName=descMatch[1].trim();desc=descMatch[2].trim();}
      if(cur)cur.options.push({name:optName,weight:w,desc});
    }
    else{cur={name:line,options:[],collapsed:false};newCat.subcategories.push(cur);}
  }
  newCat.subcategories.forEach(s=>sortOptions(s.options));
  categories.push(newCat);document.getElementById('importBox').value='';
  autoSave();renderCategories();showToast('‚ú¶ Categoria "'+name+'" importada!');
}
function createBlankCategory(){
  promptModal('Nome da Categoria','',v=>{
    if(!v)return;
    categories.push({name:v,subcategories:[],collapsed:false});
    autoSave();renderCategories();showToast('‚ú¶ Categoria "'+v+'" criada!');
  });
}
function addSubToCategory(ci){
  promptModal('Nome da Subcategoria','',v=>{
    if(!v)return;
    categories[ci].subcategories.push({name:v,options:[],collapsed:false});
    autoSave();renderCategories();showToast('Sub "'+v+'" adicionada!');
  });
}
function moveCat(i,dir){
  const j=i+dir;if(j<0||j>=categories.length)return;
  [categories[i],categories[j]]=[categories[j],categories[i]];autoSave();renderCategories();
}
function moveSub(ci,si,dir){
  const subs=categories[ci].subcategories;const j=si+dir;if(j<0||j>=subs.length)return;
  [subs[si],subs[j]]=[subs[j],subs[si]];autoSave();renderCategories();
}
function toggleCategory(i){categories[i].collapsed=!categories[i].collapsed;renderCategories(true);}
function toggleSub(ci,si){categories[ci].subcategories[si].collapsed=!categories[ci].subcategories[si].collapsed;renderCategories(true);}
function deleteCategory(i){confirmModal('Deletar Categoria','Deletar "'+categories[i].name+'"?',()=>{categories.splice(i,1);autoSave();renderCategories();});}
function deleteSub(ci,si){confirmModal('Deletar Sub','Deletar "'+categories[ci].subcategories[si].name+'"?',()=>{categories[ci].subcategories.splice(si,1);autoSave();renderCategories();});}

let _editSub=null;
function openEditSub(ci,si){_editSub={ci,si};document.getElementById('editSubTitle').innerText='Editar ‚Äî '+categories[ci].subcategories[si].name;renderEditList();openModal('editSubOverlay');}
function renderEditList(){
  if(!_editSub)return;const sub=categories[_editSub.ci].subcategories[_editSub.si];const norm=normalize(sub.options);
  const c=document.getElementById('editOptionsList');c.innerHTML='';
  sub.options.forEach((opt,k)=>{
    const r=getRarity(norm[k].percent),s=RS[r];
    const row=document.createElement('div');row.className='edit-option-row';row.style.borderColor=s.border;
    const dot=document.createElement('span');dot.style.cssText='width:7px;height:7px;border-radius:50%;background:'+s.border+';flex-shrink:0;';
    const nm=document.createElement('span');nm.className='eor-name';nm.innerText=opt.name;nm.style.color=s.tc;
    const pc=document.createElement('span');pc.className='eor-pct';pc.innerText=norm[k].percent.toFixed(2)+'%';pc.style.color=s.tc;
    const wi=document.createElement('input');wi.type='number';wi.value=opt.weight;wi.min='.001';wi.step='.001';wi.style.width='74px';wi.title='Peso';
    function applyWeight(){
      const newW=parseFloat(wi.value);
      if(!newW||newW<=0){wi.value=opt.weight;return;}
      opt.weight=newW;
      sortOptions(sub.options);autoSave();
      /* atualiza % inline sem re-renderizar lista (mant√©m foco) */
      const norm2=normalize(sub.options);
      const idx2=sub.options.findIndex(o=>o===opt);
      if(idx2>=0){const rr2=getRarity(norm2[idx2].percent),ss2=RS[rr2];pc.innerText=norm2[idx2].percent.toFixed(2)+'%';pc.style.color=ss2.tc;dot.style.background=ss2.border;nm.style.color=ss2.tc;row.style.borderColor=ss2.border;}
      renderCategories();
    }
    wi.onblur=applyWeight;
    wi.onkeydown=(e)=>{if(e.key==='Enter'){e.preventDefault();applyWeight();wi.blur();}};
    const di=document.createElement('input');di.type='text';di.value=opt.desc||'';di.placeholder='descri√ß√£o...';di.style.cssText='flex:1;min-width:80px;max-width:130px;font-size:.7rem;';di.title='Descri√ß√£o';
    di.oninput=()=>{opt.desc=di.value;autoSave();};
    const nb=document.createElement('button');nb.innerText='‚úè';nb.style.cssText='padding:3px 6px;margin:0;font-size:.72rem;';
    /* open rename without closing edit modal */
    nb.onclick=()=>{
      const overlay=document.getElementById('renameOverlay');
      document.getElementById('renameTitle').innerText='Renomear Op√ß√£o';
      document.getElementById('renameInput').value=opt.name;
      renameCallback=v=>{opt.name=v;autoSave();renderEditList();renderCategories();};
      overlay.classList.add('open');
      setTimeout(()=>document.getElementById('renameInput').focus(),80);
    };
    const db=document.createElement('button');db.innerText='üóë';db.className='btn-danger';db.style.cssText='padding:3px 6px;margin:0;font-size:.72rem;';
    db.onclick=()=>{sub.options.splice(k,1);autoSave();renderEditList();renderCategories();};
    row.appendChild(dot);row.appendChild(nm);row.appendChild(pc);row.appendChild(wi);row.appendChild(di);row.appendChild(nb);row.appendChild(db);c.appendChild(row);
  });
}
function addNewOption(){
  if(!_editSub)return;const sub=categories[_editSub.ci].subcategories[_editSub.si];
  const n=document.getElementById('newOptName').value.trim(),w=parseFloat(document.getElementById('newOptWeight').value);
  if(!n||isNaN(w)||w<=0){showToast('‚ö† Nome e peso v√°lidos necess√°rios.');return;}
  let optName=n,desc='';
  const dm=n.match(/^(.*?)\s*\(([^)]+)\)\s*$/);if(dm){optName=dm[1].trim();desc=dm[2].trim();}
  sub.options.push({name:optName,weight:w,desc});sortOptions(sub.options);
  document.getElementById('newOptName').value='';document.getElementById('newOptWeight').value='';
  autoSave();renderEditList();renderCategories();showToast('Op√ß√£o "'+optName+'" adicionada!');
}
function renderCategories(skipSync){
  const div=document.getElementById('categories');div.innerHTML='';
  const mkBtn=(txt,onclick,extra='')=>{const b=document.createElement('button');b.innerText=txt;b.style.cssText='margin:0;padding:3px 7px;font-size:.7rem;'+extra;b.onclick=onclick;return b;};
  for(let i=0;i<categories.length;i++){
    const cat=categories[i],box=document.createElement('div');box.className='category';
    const hr=document.createElement('div');hr.style.cssText='display:flex;align-items:center;gap:5px;margin-bottom:9px;flex-wrap:wrap;';
    const tit=document.createElement('h3');tit.innerText=cat.name;tit.style.cssText='flex:1;margin:0;min-width:80px;';
    /* reorder arrows */
    const upCat=mkBtn('‚ñ≤',()=>moveCat(i,-1));
    const dnCat=mkBtn('‚ñº',()=>moveCat(i,1));
    const mb=mkBtn(cat.collapsed?'‚Üì':'‚Üë',()=>toggleCategory(i));
    const eb=mkBtn('‚úè',()=>promptModal('Renomear Categoria',cat.name,v=>{cat.name=v;autoSave();renderCategories();}));
    const addSub=mkBtn('+ Sub',()=>addSubToCategory(i),'background:rgba(85,136,255,.12);border-color:#3344aa;color:#88aaff;');
    const cpb=mkBtn('üìã',()=>{
      let txt=cat.name+'\n';
      cat.subcategories.forEach(s=>{txt+=s.name+'\n';s.options.forEach(o=>{const desc=o.desc?` (${o.desc})`:'';txt+=o.name+desc+' '+o.weight+'\n';});});
      copyToClipboard(txt.trim(),'üìã Categoria "'+cat.name+'" copiada!');
    });
    const db=mkBtn('üóë',()=>deleteCategory(i),'');db.className='btn-danger';db.style.cssText+='margin:0;padding:3px 7px;';
    hr.appendChild(tit);hr.appendChild(upCat);hr.appendChild(dnCat);hr.appendChild(mb);hr.appendChild(eb);hr.appendChild(addSub);hr.appendChild(cpb);hr.appendChild(db);box.appendChild(hr);
    if(!cat.collapsed){
      for(let j=0;j<cat.subcategories.length;j++){
        const sub=cat.subcategories[j],sd=document.createElement('div');sd.className='subcategory';
        const sh=document.createElement('div');sh.style.cssText='display:flex;align-items:center;gap:5px;margin-bottom:7px;flex-wrap:wrap;';
        const st=document.createElement('h4');st.innerText=sub.name;st.style.cssText='flex:1;margin:0;min-width:60px;';
        /* reorder sub arrows */
        const upSub=mkBtn('‚ñ≤',()=>moveSub(i,j,-1));
        const dnSub=mkBtn('‚ñº',()=>moveSub(i,j,1));
        const smb=mkBtn(sub.collapsed?'‚Üì':'‚Üë',()=>toggleSub(i,j));
        const seb=mkBtn('‚úè Editar',()=>openEditSub(i,j));
        const snm=mkBtn('‚úè Nome',()=>promptModal('Renomear Sub',sub.name,v=>{sub.name=v;autoSave();renderCategories();}));
        const scpb=mkBtn('üìã',(()=>{const _cat=cat,_sub=sub;return()=>{let txt=_cat.name+'\n'+_sub.name+'\n';_sub.options.forEach(o=>{const desc=o.desc?` (${o.desc})`:'';txt+=o.name+desc+' '+o.weight+'\n';});copyToClipboard(txt.trim(),'üìã Sub "'+_sub.name+'" copiada!');}})());
        const sdb=mkBtn('üóë',()=>deleteSub(i,j),'');sdb.className='btn-danger';sdb.style.cssText+='margin:0;padding:2px 6px;';
        sh.appendChild(st);sh.appendChild(upSub);sh.appendChild(dnSub);sh.appendChild(smb);sh.appendChild(seb);sh.appendChild(snm);sh.appendChild(scpb);sh.appendChild(sdb);sd.appendChild(sh);
        if(!sub.collapsed){const ul=document.createElement('ul');ul.style.paddingLeft='0';normalize(sub.options).forEach(o=>{const li=document.createElement('li');const rr=getRarity(o.percent);const ss=RS[rr];li.style.color=ss.tc;applyRarityToEl(li,o.percent);let txt=o.name+' ‚Äî '+o.percent.toFixed(2)+'%';if(o.desc)txt+=' ('+o.desc+')';li.innerText=txt;ul.appendChild(li);});sd.appendChild(ul);}
        box.appendChild(sd);
      }
    }
    div.appendChild(box);
  }
  /* sync personagens existentes com nova estrutura de categorias */
  if(!skipSync) syncCharactersToCategories();
}
let _spTarget=null;
function openSkillPicker(char,pEl,subRef){
  _spTarget={char,pEl,subRef};const c=document.getElementById('skillPickerCats');c.innerHTML='';
  document.getElementById('skillPickerTitle').innerText=pEl&&pEl.dataset.sub?'‚ú¶ Substituir: '+pEl.dataset.sub:'‚ú¶ Adicionar Habilidade';
  for(let ci=0;ci<categories.length;ci++){
    const cat=categories[ci],cd=document.createElement('div');
    const ct=document.createElement('div');ct.className='sp-cat-title';ct.innerText=cat.name;cd.appendChild(ct);
    for(let si=0;si<cat.subcategories.length;si++){
      const sub=cat.subcategories[si],st=document.createElement('div');st.className='sp-sub-title';st.innerText=sub.name;cd.appendChild(st);
      const grid=document.createElement('div');grid.className='sp-options-grid';
      normalize(sub.options).forEach(opt=>{
        const r=getRarity(opt.percent),s=RS[r],btn=document.createElement('div');btn.className='sp-option';
        if(r==='aurora'){btn.className+=' sp-option-aurora';btn.style.background=s.bg;btn.style.color=s.tc;}
        else{btn.style.background=s.bg;btn.style.border='1px solid '+s.border;btn.style.color=s.tc;}
        btn.innerText=sub.name+': '+opt.name+' ('+opt.percent.toFixed(2)+'%)';
        btn.onclick=(()=>{const _o=opt,_s=sub;return()=>{_applySkillFromPicker(_o,_s);closeModal('skillPickerOverlay');}})();
        grid.appendChild(btn);
      });cd.appendChild(grid);
    }c.appendChild(cd);
  }openModal('skillPickerOverlay');
}
function applySkillToChar(result,subRef,char){
  if(!_spTarget&&!char)return;const tChar=char||(_spTarget?_spTarget.char:null);const pEl=_spTarget?_spTarget.pEl:null;let target=pEl;
  if(!target){const ps=tChar?tChar.getElementsByTagName('p'):[];for(const p of ps){if(p.dataset.sub===subRef.name){target=p;break;}}if(!target){target=document.createElement('p');target.className='skill-item';target.dataset.sub=subRef.name;attachSkillClick(target,subRef,tChar);if(tChar._skillsCol)tChar._skillsCol.appendChild(target);else tChar.appendChild(target);}}
  Array.from(target.childNodes).filter(n=>n.nodeType===3).forEach(n=>n.remove());
  const lockBtn=target.querySelector('.skill-lock-btn');
  const textNode=document.createTextNode(subRef.name+': '+result.name+' ('+result.percent.toFixed(2)+'%)');
  target.insertBefore(textNode,lockBtn||null);
  target.dataset.percent=result.percent;target.dataset.resultName=result.name;
  const catData=categories.find(c=>c.subcategories.some(s=>s.name===subRef.name));
  const subData=catData?catData.subcategories.find(s=>s.name===subRef.name):null;
  const optData=subData?subData.options.find(o=>o.name===result.name):null;
  target.dataset.desc=optData&&optData.desc?optData.desc:'';
  applyRarityToEl(target,result.percent);target.classList.remove('empty-slot');
  updateRarityBadge(target);
  if(tChar)updateCharDescPanel(tChar);
  if(tChar&&tChar.classList.contains('pinned'))savePinned();
  const r=getRarity(result.percent);
  if(r==='aurora')triggerAuroraAnim(result.name);else if(r==='omega')triggerOmegaAnim(result.name);else if(r==='mitica')triggerMiticaAnim(result.name);
}
function _applySkillFromPicker(result,subRef){applySkillToChar(result,subRef,null);}
function attachSkillClick(pEl, subRef, char) {
  // Add rarity badge
  addRarityBadge(pEl, subRef, char);

  pEl.onclick = function(e) {
    if (e.target.classList.contains('skill-lock-btn')) return;
    if (e.target.classList.contains('skill-rarity-badge')) return;
    if (char.classList.contains('pinned')) return;
    if (pEl.classList.contains('locked')) {
      showToast('üîí Raridade fixada! Clique no üîí para desfixar antes de girar.');
      return;
    }
    var lockedRar = char._lockedRarities && char._lockedRarities[subRef.name] ? char._lockedRarities[subRef.name] : null;
    var guarantee = lockedRar || getGuarantee();
    openRoulette(subRef.name, subRef.options, function(r) {
      Array.from(pEl.childNodes).filter(function(n){return n.nodeType===3;}).forEach(function(n){n.remove();});
      var lockBtn = pEl.querySelector('.skill-lock-btn');
      var textNode = document.createTextNode(subRef.name + ': ' + r.name + ' (' + r.percent.toFixed(2) + '%)');
      pEl.insertBefore(textNode, lockBtn || null);
      pEl.dataset.percent = r.percent; pEl.dataset.resultName = r.name;
      var catData = categories.find(function(c){return c.subcategories.some(function(s){return s.name===subRef.name;});});
      var subData = catData ? catData.subcategories.find(function(s){return s.name===subRef.name;}) : null;
      var optData = subData ? subData.options.find(function(o){return o.name===r.name;}) : null;
      pEl.dataset.desc = optData && optData.desc ? optData.desc : '';
      applyRarityToEl(pEl, r.percent); pEl.classList.remove('empty-slot');
      updateCharDescPanel(char);
      updateRarityBadge(pEl);
      if (char.classList.contains('pinned')) savePinned();
    }, guarantee);
  };
  pEl.ondblclick = function(e) {
    if (e.target.classList.contains('skill-lock-btn') || e.target.classList.contains('skill-rarity-badge') || e.target.classList.contains('skill-clear-btn')) return;
    var name = pEl.dataset.resultName;
    if (name) { copyToClipboard(name, 'üìã "'+name+'" copiado!'); }
  };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROULETTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let rouletteOpts=null,rouletteCB=null,rouletteSpin=false,rouletteAngle=0,rouletteIdleRAF=null,auroraHue=0,rouletteGuaranteeOverride=null;
let _rouletteVisCache=null; /* pr√©-computado quando norm muda */
let _spinCooldown=false; /* cooldown de 2s entre giros */

function _buildRouletteVisCache(norm){
  const MIN_VIS=2;
  const raw=norm.map(o=>Math.max(o.percent,MIN_VIS));
  const total=raw.reduce((s,v)=>s+v,0);
  return raw.map(v=>(v/total)*Math.PI*2);
}

function setRouletteNeon(state){
  const canvas=document.getElementById('rouletteCanvas');
  canvas.classList.remove('neon-omega','neon-aurora');
  if(state==='omega')canvas.classList.add('neon-omega');
  else if(state==='aurora')canvas.classList.add('neon-aurora');
}
function stopRouletteNeon(){document.getElementById('rouletteCanvas').classList.remove('neon-omega','neon-aurora');}

function drawRoulette(norm,hi){
  const canvas=document.getElementById('rouletteCanvas'),ctx=canvas.getContext('2d');
  const W=canvas.width,cx=W/2,r=W/2-3;
  ctx.clearRect(0,0,W,W);
  auroraHue=(auroraHue+1.5)%360;
  const vis=_rouletteVisCache||_buildRouletteVisCache(norm);
  let ang=rouletteAngle;

  /* paleta aleat√≥ria pra roletas com s√≥ 2 op√ß√µes */
  const isBinary=norm.length===2;
  if(isBinary&&!canvas._binaryColors){
    const palettes=[
      ['#e63946','#457b9d'],['#f4a261','#2a9d8f'],['#e76f51','#264653'],
      ['#9b5de5','#f15bb5'],['#00bbf9','#fee440'],['#06d6a0','#ef476f'],
      ['#ff6b6b','#4ecdc4'],['#ffd166','#06aed5'],['#c77dff','#48cae4'],
    ];
    const p=palettes[Math.floor(Math.random()*palettes.length)];
    canvas._binaryColors=[{fill:p[0],border:p[0],tc:'#fff'},{fill:p[1],border:p[1],tc:'#fff'}];
  }
  if(!isBinary)canvas._binaryColors=null;

  /* ‚îÄ‚îÄ fatias ‚îÄ‚îÄ */
  for(let i=0;i<norm.length;i++){
    const sl=vis[i],rar=getRarity(norm[i].percent),s=canvas._binaryColors?canvas._binaryColors[i]:RS[rar];
    ctx.beginPath();ctx.moveTo(cx,cx);ctx.arc(cx,cx,r,ang,ang+sl);ctx.closePath();
    if(hi===i){
      /* fatia destacada: branco puro com borda luminosa */
      ctx.fillStyle='#ffffff';
    } else if(!canvas._binaryColors&&rar==='aurora'){
      const h0=(auroraHue+i*55)%360;
      const g=ctx.createLinearGradient(
        cx+Math.cos(ang+sl*.25)*r*.6,cx+Math.sin(ang+sl*.25)*r*.6,
        cx+Math.cos(ang+sl*.75)*r*.6,cx+Math.sin(ang+sl*.75)*r*.6
      );
      g.addColorStop(0,`hsl(${h0},100%,52%)`);
      g.addColorStop(.5,`hsl(${(h0+90)%360},100%,58%)`);
      g.addColorStop(1,`hsl(${(h0+180)%360},100%,52%)`);
      ctx.fillStyle=g;
    } else {
      ctx.fillStyle=s.fill;
    }
    ctx.fill();

    /* bordas entre fatias */
    ctx.strokeStyle=hi===i?'rgba(255,255,255,.9)':s.border;
    ctx.lineWidth=hi===i?2.5:1;
    ctx.stroke();

    /* label */
    if(sl>0.045){
      const fs=Math.min(14,Math.max(7,sl*r*0.19));
      ctx.save();ctx.translate(cx,cx);ctx.rotate(ang+sl/2);ctx.textAlign='right';
      ctx.fillStyle=hi===i?'#111':s.tc;
      ctx.font='bold '+fs+'px Rajdhani,sans-serif';
      let lbl=norm[i].name;
      const maxC=Math.max(2,Math.floor(sl*r/fs*1.65));
      if(lbl.length>maxC)lbl=lbl.slice(0,maxC-1)+'‚Ä¶';
      ctx.fillText(lbl,r-8,fs*.38);
      ctx.restore();
    }
    ang+=sl;
  }

  /* ‚îÄ‚îÄ aro externo met√°lico (3 camadas sem shadowBlur) ‚îÄ‚îÄ */
  ctx.beginPath();ctx.arc(cx,cx,r,0,Math.PI*2);
  ctx.strokeStyle='rgba(255,255,255,.04)';ctx.lineWidth=8;ctx.stroke();
  ctx.strokeStyle='rgba(255,255,255,.09)';ctx.lineWidth=4;ctx.stroke();
  ctx.strokeStyle='#1a1a30';ctx.lineWidth=1.5;ctx.stroke();

  /* ‚îÄ‚îÄ hub central premium ‚îÄ‚îÄ */
  const hubR=28;
  const hg=ctx.createRadialGradient(cx-4,cx-4,0,cx,cx,hubR);
  hg.addColorStop(0,'#3a3a60');hg.addColorStop(.5,'#1a1a35');hg.addColorStop(1,'#08080f');
  ctx.beginPath();ctx.arc(cx,cx,hubR,0,Math.PI*2);ctx.fillStyle=hg;ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,.12)';ctx.lineWidth=2;ctx.stroke();
  ctx.strokeStyle='rgba(0,0,0,.5)';ctx.lineWidth=1;ctx.stroke();
  /* ponto central brilhante */
  const pg=ctx.createRadialGradient(cx,cx,0,cx,cx,6);
  pg.addColorStop(0,'#88aaff');pg.addColorStop(1,'#2244aa');
  ctx.beginPath();ctx.arc(cx,cx,6,0,Math.PI*2);ctx.fillStyle=pg;ctx.fill();
}
function idleLoop(){if(!document.getElementById('rouletteOverlay').classList.contains('visible')||rouletteSpin)return;rouletteAngle+=0.0015;drawRoulette(rouletteOpts,-1);rouletteIdleRAF=requestAnimationFrame(idleLoop);}
function openRoulette(sub,opts,cb,guaranteeOverride){
  rouletteOpts=normalize(opts);rouletteCB=cb;rouletteSpin=false;rouletteAngle=-Math.PI/2;stopRouletteNeon();
  _rouletteVisCache=_buildRouletteVisCache(rouletteOpts); /* cache vis */
  document.getElementById('rouletteCanvas')._binaryColors=null; /* reset binary colors */
  _spinCooldown=false;
  rouletteGuaranteeOverride=guaranteeOverride||null;
  document.getElementById('rouletteTitle').innerText=sub;
  const res=document.getElementById('rouletteResult');res.innerText='';res.style.cssText='';res.classList.remove('shown');
  const big=document.getElementById('rouletteBigResult');big.style.opacity='0';big.style.display='flex';
  document.getElementById('rouletteFlash').style.opacity='0';
  document.getElementById('spinHint').innerText='‚ñ∂';document.getElementById('spinHint').style.opacity='.8';
  document.getElementById('rouletteCloseBtn').style.visibility='visible';
  document.getElementById('rouletteCloseBtn').style.opacity='1';
  document.getElementById('rouletteOverlay').classList.add('visible');
  drawRoulette(rouletteOpts,-1);rouletteIdleRAF=requestAnimationFrame(idleLoop);
}
function closeRoulette(){
  document.getElementById('rouletteOverlay').classList.remove('visible');
  cancelAnimationFrame(rouletteIdleRAF);stopRouletteNeon();stopParticles();
  document.getElementById('rouletteCanvasWrap').classList.remove('omega-bg-glow');
  document.getElementById('rouletteCloseBtn').style.visibility='visible';
  document.getElementById('rouletteCloseBtn').style.opacity='1';
}
function handleCanvasClick(){if(!rouletteSpin&&!_spinCooldown)spinRoulette();else if(_spinCooldown)showToast('‚è≥ Aguarde...',800);}
function spinRoulette(){
  if(rouletteSpin)return;rouletteSpin=true;cancelAnimationFrame(rouletteIdleRAF);stopRouletteNeon();
  document.getElementById('spinHint').innerText='';document.getElementById('rouletteResult').classList.remove('shown');
  document.getElementById('rouletteCloseBtn').style.visibility='hidden';
  document.getElementById('rouletteCloseBtn').style.opacity='0';
  const norm=rouletteOpts,guarantee=rouletteGuaranteeOverride||getGuarantee();
  let result=rollFromNormalized(norm,guarantee);
  let ri=norm.findIndex(o=>o.name===result.name);if(ri<0)ri=0;
  const rar=getRarity(result.percent);
  const wrap=document.getElementById('rouletteCanvasWrap');
  /* vis cache */
  const vis=_rouletteVisCache||_buildRouletteVisCache(norm);
  let tAng=0;for(let i=0;i<ri;i++)tAng+=vis[i];
  const sl=vis[ri]||0.05;
  const finalAng=-Math.PI/2-(tAng+(Math.random()*.8+.1)*sl);
  const dur=parseInt(document.getElementById('rcDuration').value)||4500;
  const spins=parseInt(document.getElementById('rcSpins').value)||8;
  const total=finalAng+(spins+Math.floor(Math.random()*3))*Math.PI*2;
  const start=rouletteAngle;let t0=null,sHue=0;
  const canvas=document.getElementById('rouletteCanvas');
  function ease(t){if(t<.07)return t*1.6;const t2=(t-.07)/.93;return .112+.888*(1-Math.pow(1-t2,4));}
  function frame(ts){
    if(!t0)t0=ts;const t=Math.min((ts-t0)/dur,1);rouletteAngle=start+(total-start)*ease(t);
    drawRoulette(norm,-1);
    /* frame-synced neon on the canvas during spin for omega/aurora */
    if(rar==='omega'){
      sHue=(sHue+4)%360;
      const pulse=0.5+0.5*Math.sin(ts*0.01);
      canvas.style.boxShadow=`0 0 0 3px rgba(255,255,255,${.15+.25*pulse}),0 0 ${20+20*pulse}px ${6+8*pulse}px rgba(200,230,255,${.25+.2*pulse}),0 0 ${50+30*pulse}px ${15+15*pulse}px rgba(150,200,255,${.1+.1*pulse})`;
    } else if(rar==='aurora'){
      sHue=(sHue+3)%360;
      document.getElementById('rouletteModal').style.boxShadow=`0 0 40px hsl(${sHue},100%,50%),0 0 80px hsl(${(sHue+120)%360},100%,35%)`;
      canvas.style.boxShadow=`0 0 0 3px hsl(${sHue},100%,60%,.6),0 0 25px 8px hsl(${(sHue+60)%360},100%,50%,.3)`;
    }
    if(t<1)requestAnimationFrame(frame);
    else{
      rouletteAngle=finalAng;drawRoulette(norm,ri);
      rouletteSpin=false;
      _spinCooldown=true;setTimeout(()=>{_spinCooldown=false;},2000);
      document.getElementById('rouletteModal').style.boxShadow='';
      canvas.style.boxShadow='';
      wrap.classList.remove('omega-bg-glow');
      onRouletteResult(result);
      setTimeout(()=>{rouletteIdleRAF=requestAnimationFrame(idleLoop);},3500);
    }
  }requestAnimationFrame(frame);
}
function onRouletteResult(res){
  const r=getRarity(res.percent),s=RS[r];
  document.getElementById('spinHint').style.opacity='.35';document.getElementById('spinHint').innerText='‚ñ∂';
  if(r==='omega')setRouletteNeon('omega');else if(r==='aurora')setRouletteNeon('aurora');else stopRouletteNeon();
  /* ‚îÄ‚îÄ FIX 2: show close button again after result ‚îÄ‚îÄ */
  document.getElementById('rouletteCloseBtn').style.visibility='visible';
  document.getElementById('rouletteCloseBtn').style.opacity='1';
  flashModal(s.border,r);setTimeout(()=>showBigResult(res,r,s),120);
}
function flashModal(color,rar){
  const f=document.getElementById('rouletteFlash');
  f.style.background=rar==='aurora'?'linear-gradient(270deg,#ff0080,#ff8800,#aaff00,#00ff88,#00cfff,#aa44ff)':color;
  f.style.opacity=rar==='aurora'?'.75':rar==='omega'?'.6':rar==='mitica'?'.45':'.28';
  setTimeout(()=>{f.style.transition='opacity .3s';f.style.opacity='0';setTimeout(()=>f.style.transition='',350);},80);
}
function showBigResult(res,rar,s){
  const big=document.getElementById('rouletteBigResult'),txt=document.getElementById('rouletteBigResultText'),sub=document.getElementById('rouletteBigResultSub'),glow=document.getElementById('rouletteBigGlow');
  /* for special rarities, the rarityRevealOverlay handles the big name ‚Äî skip the small roulette one */
  const isSpecial=rar==='aurora'||rar==='omega'||rar==='mitica';
  if(!isSpecial){
    txt.innerText=res.name;
    txt.style.cssText='font-family:Cinzel Decorative,serif;font-size:1.6rem;font-weight:700;text-align:center;padding:0 20px;line-height:1.25;color:'+s.tc+';text-shadow:0 0 20px '+s.tc+';position:relative;z-index:2;';
    sub.innerText=s.label+' ¬∑ '+res.percent.toFixed(2)+'%';sub.style.color=s.border;
    /* glow blob behind text, cor da raridade */
    glow.style.background=s.border;glow.style.opacity='0.55';
    big.style.display='flex';big.style.transition='none';big.style.opacity='0';void big.offsetHeight;big.style.transition='opacity .3s';big.style.opacity='1';
    setTimeout(()=>{big.style.transition='opacity .6s';big.style.opacity='0';setTimeout(()=>{big.style.display='none';glow.style.opacity='0';txt.style.cssText='';showBottomResult(res,rar,s);if(rouletteCB)rouletteCB(res);},650);},2800);
  } else {
    big.style.display='none';glow.style.opacity='0';
    if(rar==='aurora')triggerAuroraAnim(res.name);else if(rar==='omega')triggerOmegaAnim(res.name);else if(rar==='mitica')triggerMiticaAnim(res.name);
    setTimeout(()=>{showBottomResult(res,rar,s);if(rouletteCB)rouletteCB(res);},3200);
  }
  if(!isSpecial) startParticles(s.border);
}
function showBottomResult(res,rar,s){
  const r=document.getElementById('rouletteResult');
  r.innerText=res.name+' ('+res.percent.toFixed(2)+'%) ‚Äî '+s.label;
  if(rar==='aurora')r.style.cssText='background-image:linear-gradient(270deg,#ff0080,#ff8800,#aaff00,#00ff88,#00cfff,#aa44ff,#ff0080);background-size:300% 100%;animation:auroraShift 2s linear infinite;color:#fff;border:1px solid transparent;font-size:.9rem;font-weight:700;text-align:center;padding:6px 16px;border-radius:9px;opacity:1;font-family:Rajdhani,sans-serif;';
  else r.style.cssText='background:'+s.bg+';border:1px solid '+s.border+';color:'+s.tc+';font-size:.9rem;font-weight:700;text-align:center;padding:6px 16px;border-radius:9px;opacity:1;font-family:Rajdhani,sans-serif;';
  r.classList.add('shown');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARTICLES ‚Äî pooled, cap 80, batched draw ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let pActive=false,pList=[],pRAF=null;
function startParticles(color){
  const c=document.getElementById('particlesCanvas');
  c.width=innerWidth;c.height=innerHeight;
  c.classList.add('active');pActive=true;pList=[];
  for(let i=0;i<20;i++)spawnP(c,color,true);
  let spawnTick=0;
  function tick(){
    if(!pActive)return;
    const ctx=c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    spawnTick++;
    if(spawnTick%3===0&&pList.length<80)spawnP(c,color,false);
    // batch by color for fewer state changes
    ctx.beginPath();
    for(let i=pList.length-1;i>=0;i--){
      const p=pList[i];
      p.x+=p.vx;p.y+=p.vy;p.vy-=.06;p.vx*=.99;p.a-=.011/p.life;
      if(p.a<=0){pList.splice(i,1);continue;}
      ctx.globalAlpha=p.a;
      ctx.fillStyle=p.color;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    }
    ctx.globalAlpha=1;
    pRAF=requestAnimationFrame(tick);
  }
  pRAF=requestAnimationFrame(tick);
  setTimeout(()=>stopParticles(),3200);
}
function spawnP(c,color,bot){
  if(pList.length>=80)return;
  const ang=bot?(Math.random()*Math.PI-.5*Math.PI):Math.random()*Math.PI*2;
  const spd=bot?Math.random()*6+3:Math.random()*4+1;
  pList.push({
    x:bot?Math.random()*c.width:c.width/2+(Math.random()-.5)*c.width*.6,
    y:bot?c.height+10:Math.random()*c.height,
    vx:Math.cos(ang)*spd,vy:bot?-(Math.random()*8+4):Math.sin(ang)*spd,
    r:Math.random()*5+2,a:1,color,life:Math.random()*.6+.5
  });
}
function stopParticles(){
  pActive=false;if(pRAF)cancelAnimationFrame(pRAF);pRAF=null;
  const c=document.getElementById('particlesCanvas');
  c.classList.remove('active');
  c.getContext('2d').clearRect(0,0,c.width,c.height);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AURORA ‚Äî STELLAR BIRTH
   Tela escurece ‚Üí estrela pequena aparece no centro ‚Üí
   raios coloridos a atacam ‚Üí ela cresce e gira cada vez mais
   r√°pido ‚Üí explode ‚Üí beams saindo do centro pra fora da tela
   ‚Üí nome aparece no centro
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let auroraAnimRAF=null,auroraAnimActive=false;
function triggerAuroraAnim(name){
  if(!cutsceneEnabled) return;
  const overlay=document.getElementById('auroraOverlay');
  const canvas=document.getElementById('auroraCanvas');
  overlay.classList.add('active');overlay.style.opacity='1';
  canvas.width=innerWidth;canvas.height=innerHeight;
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2,DIAG=Math.hypot(W,H);
  auroraAnimActive=true;

  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let startTS=null;
  let phase='grow'; // grow ‚Üí explode ‚Üí beams ‚Üí done
  let starR=4,starRot=0,starSpd=0.015;
  let globalHue=0;
  const incomingRays=[]; // raios atacando a estrela
  let exploded=false;
  const expBeams=[]; // beams p√≥s-explos√£o
  const expRings=[];
  const expOrbs=[];
  let flashAlpha=0;
  let bgAlpha=0;

  // Gera raio de fora vindo pra estrela
  function spawnRay(){
    const angle=Math.random()*Math.PI*2;
    const dist=DIAG*.55+Math.random()*DIAG*.15;
    const hue=Math.random()*360;
    const pts=[];
    const sx=cx+Math.cos(angle)*dist,sy=cy+Math.sin(angle)*dist;
    const segs=4+Math.floor(Math.random()*4);
    pts.push({x:sx,y:sy});
    for(let i=1;i<segs;i++){
      const t=i/segs;
      pts.push({x:sx+(cx-sx)*t+(Math.random()-.5)*90*(1-t),y:sy+(cy-sy)*t+(Math.random()-.5)*90*(1-t)});
    }
    pts.push({x:cx,y:cy});
    incomingRays.push({pts,a:1,hue,w:1+Math.random()*2.5,dec:.04+Math.random()*.03});
  }

  function doExplosion(){
    exploded=true;phase='explode';
    // flash
    flashAlpha=1;
    // screen shake
    const el=document.getElementById('shakeInner');let sf=0;
    const siv=setInterval(()=>{sf++;const m=22*(1-sf/28);el.style.transform=`translate(${(Math.random()-.5)*m*2}px,${(Math.random()-.5)*m*2}px)`;if(sf>=28){clearInterval(siv);el.style.transform='';}},16);
    // 16 beams saindo do centro
    for(let i=0;i<16;i++){
      const angle=(i/16)*Math.PI*2;
      expBeams.push({angle,len:0,maxLen:DIAG*.9,spd:28+Math.random()*20,hue:(i/16)*360,w:4+Math.random()*18,a:1,dec:.006+Math.random()*.003});
    }
    // rings
    for(let i=0;i<6;i++)expRings.push({r:i*5,spd:22+i*8,a:1,w:4,hue:(i/6)*360,delay:i*30});
    // orbs
    for(let i=0;i<80;i++){
      const a=Math.random()*Math.PI*2,spd=8+Math.random()*38,h=(i/80)*360;
      expOrbs.push({x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:2+Math.random()*6,a:1,hue:h,trail:[]});
    }
    setTimeout(()=>showRarityReveal(name,'aurora'),300);
  }

  // ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let rayTimer=0,rayInterval=180,rayCount=0;
  function frame(ts){
    if(!auroraAnimActive)return;
    if(!startTS)startTS=ts;
    const elapsed=ts-startTS;
    globalHue=(globalHue+3)%360;
    ctx.clearRect(0,0,W,H);

    // background
    bgAlpha=Math.min(.98,elapsed/280);
    ctx.fillStyle=`rgba(0,0,0,${bgAlpha})`;ctx.fillRect(0,0,W,H);

    if(!exploded){
      // spawn incoming rays progressively
      if(elapsed>rayTimer&&rayCount<22){
        spawnRay();rayTimer+=rayInterval;rayInterval=Math.max(45,rayInterval*.82);rayCount++;
      }

      // star grows and spins faster with each ray
      const growTarget=12+rayCount*7;
      starR+=(growTarget-starR)*.035;
      starSpd=Math.min(0.38,0.015+rayCount*0.016);
      starRot+=starSpd;

      // draw incoming rays first (behind star)
      ctx.save();
      for(let i=incomingRays.length-1;i>=0;i--){
        const r=incomingRays[i];r.a-=r.dec;
        if(r.a<=0){incomingRays.splice(i,1);continue;}
        ctx.strokeStyle=`hsl(${r.hue},100%,70%)`;
        ctx.globalAlpha=r.a*.08;ctx.lineWidth=r.w+14;drawBoltPath(ctx,r.pts);ctx.stroke();
        ctx.globalAlpha=r.a*.18;ctx.lineWidth=r.w+5;drawBoltPath(ctx,r.pts);ctx.stroke();
        ctx.globalAlpha=r.a;ctx.lineWidth=r.w;drawBoltPath(ctx,r.pts);ctx.stroke();
        ctx.strokeStyle='#fff';ctx.globalAlpha=r.a*.55;ctx.lineWidth=r.w*.22;drawBoltPath(ctx,r.pts);ctx.stroke();
      }
      ctx.restore();

      // draw spinning star (spiky polygon)
      ctx.save();ctx.translate(cx,cy);ctx.rotate(starRot);
      const spikes=8;
      const innerR=starR*.45;
      // glow layers
      for(let g=3;g>=1;g--){
        const gr=ctx.createRadialGradient(0,0,0,0,0,starR*g*1.8);
        gr.addColorStop(0,`hsla(${globalHue},100%,85%,${.18/g})`);
        gr.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle=gr;ctx.beginPath();ctx.arc(0,0,starR*g*1.8,0,Math.PI*2);ctx.globalAlpha=1;ctx.fill();
      }
      // star shape
      ctx.beginPath();
      for(let i=0;i<spikes*2;i++){
        const a=(i/spikes)*Math.PI;
        const r2=i%2===0?starR:innerR;
        i===0?ctx.moveTo(Math.cos(a)*r2,Math.sin(a)*r2):ctx.lineTo(Math.cos(a)*r2,Math.sin(a)*r2);
      }
      ctx.closePath();
      const sg=ctx.createRadialGradient(0,0,0,0,0,starR);
      sg.addColorStop(0,'#ffffff');
      sg.addColorStop(.4,`hsl(${globalHue},100%,80%)`);
      sg.addColorStop(1,`hsl(${(globalHue+120)%360},100%,55%)`);
      ctx.fillStyle=sg;ctx.globalAlpha=1;ctx.fill();
      ctx.restore();

      // explode when star is big enough
      if(starR>90&&!exploded)doExplosion();

    } else {
      // ‚îÄ‚îÄ POST-EXPLOSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // flash fade
      if(flashAlpha>0){
        ctx.fillStyle=`rgba(255,255,255,${flashAlpha})`;ctx.fillRect(0,0,W,H);
        flashAlpha=Math.max(0,flashAlpha-.065);
      }

      // beams from center outward
      ctx.save();
      let now=elapsed;
      for(let i=expBeams.length-1;i>=0;i--){
        const b=expBeams[i];
        b.len=Math.min(b.len+b.spd,b.maxLen);
        b.a-=b.dec;
        if(b.a<=0){expBeams.splice(i,1);continue;}
        const ex=cx+Math.cos(b.angle)*b.len,ey=cy+Math.sin(b.angle)*b.len;
        const hsl=`hsl(${b.hue},100%,65%)`;
        ctx.strokeStyle=hsl;ctx.globalAlpha=b.a*.06;ctx.lineWidth=b.w+22;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(ex,ey);ctx.stroke();
        ctx.globalAlpha=b.a*.15;ctx.lineWidth=b.w+8;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(ex,ey);ctx.stroke();
        ctx.globalAlpha=b.a*.8;ctx.lineWidth=b.w*.4;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(ex,ey);ctx.stroke();
        ctx.strokeStyle='#fff';ctx.globalAlpha=b.a*.5;ctx.lineWidth=b.w*.12;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(ex,ey);ctx.stroke();
      }
      ctx.restore();

      // rings
      ctx.save();
      for(let i=expRings.length-1;i>=0;i--){
        const ring=expRings[i];if(elapsed<ring.delay){continue;}
        ring.r+=ring.spd;ring.spd*=.93;ring.a-=.018;ring.hue=(ring.hue+4)%360;
        if(ring.a<=0){expRings.splice(i,1);continue;}
        ctx.strokeStyle=`hsl(${ring.hue},100%,70%)`;
        ctx.globalAlpha=ring.a*.1;ctx.lineWidth=ring.w+14;ctx.beginPath();ctx.arc(cx,cy,ring.r,0,Math.PI*2);ctx.stroke();
        ctx.globalAlpha=ring.a*.65;ctx.lineWidth=ring.w*.38;ctx.beginPath();ctx.arc(cx,cy,ring.r,0,Math.PI*2);ctx.stroke();
      }
      ctx.restore();

      // orbs with rainbow trails
      ctx.save();
      for(let i=expOrbs.length-1;i>=0;i--){
        const o=expOrbs[i];
        o.trail.push({x:o.x,y:o.y});if(o.trail.length>8)o.trail.shift();
        o.x+=o.vx;o.y+=o.vy;o.vy+=.18;o.vx*=.985;
        o.a-=.016;o.r*=.985;o.hue=(o.hue+4)%360;
        if(o.a<=0||o.r<.4){expOrbs.splice(i,1);continue;}
        for(let j=0;j<o.trail.length;j++){ctx.globalAlpha=o.a*(j/o.trail.length)*.28;ctx.fillStyle=`hsl(${(o.hue+j*15)%360},100%,65%)`;ctx.beginPath();ctx.arc(o.trail[j].x,o.trail[j].y,o.r*(j/o.trail.length)*.8,0,Math.PI*2);ctx.fill();}
        ctx.fillStyle=`hsl(${o.hue},100%,88%)`;ctx.globalAlpha=o.a;ctx.beginPath();ctx.arc(o.x,o.y,o.r,0,Math.PI*2);ctx.fill();
      }
      ctx.restore();

      // center glow pulse
      const pulse=.5+.5*Math.sin(elapsed*.025);
      ctx.save();ctx.globalAlpha=.18*pulse;
      const g=ctx.createRadialGradient(cx,cy,0,cx,cy,100);
      g.addColorStop(0,`hsl(${globalHue},100%,95%)`);g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g;ctx.beginPath();ctx.arc(cx,cy,100,0,Math.PI*2);ctx.fill();ctx.restore();
    }

    auroraAnimRAF=requestAnimationFrame(frame);
  }
  auroraAnimRAF=requestAnimationFrame(frame);

  // fade out
  setTimeout(()=>{
    auroraAnimActive=false;
    let t1=null;
    (function fo(ts){
      if(!t1)t1=ts;const p=Math.min((ts-t1)/900,1),e=1-Math.pow(1-p,3);
      overlay.style.opacity=String(1-e);
      if(p<1)requestAnimationFrame(fo);
      else{overlay.classList.remove('active');overlay.style.opacity='';ctx.clearRect(0,0,W,H);}
    })();
  },3200);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   OMEGA ‚Äî VOID RIFT
   Espa√ßo escurece ‚Üí fissura dimensional rasgando o ar
   ‚Üí v√≥rtice de energia branca spiralando ‚Üí raios el√©tricos
   ‚Üí singularidade explode em onda de choque cristalina
   ‚Üí nome revela no v√°cuo
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let omegaRAF=null,omegaActive=false;
function triggerOmegaAnim(name){
  if(!cutsceneEnabled) return;
  const ov=document.getElementById('omegaRitual');
  const tx=document.getElementById('omegaRitualText');
  const bc=document.getElementById('omegaBeamCanvas');
  tx.innerText='Œ©  '+name.toUpperCase()+'  Œ©';
  tx.style.cssText='font-family:Cinzel Decorative,serif;font-size:clamp(1.4rem,4vw,3rem);color:#fff;letter-spacing:8px;text-align:center;position:relative;z-index:10;text-shadow:0 0 25px #fff,0 0 60px rgba(180,220,255,.9);opacity:0;pointer-events:none;transform:scale(3.2);';
  ov.classList.add('active');ov.style.opacity='1';
  bc.width=innerWidth;bc.height=innerHeight;
  const ctx=bc.getContext('2d');
  const W=bc.width,H=bc.height,cx=W/2,cy=H/2,DIAG=Math.hypot(W,H);
  omegaActive=true;

  let startTS=null,bgAlpha=0,exploded=false,flashA=0;

  // 4 rifts ‚Äî one from each edge, converging to center
  // Each rift is a jagged crack growing inward
  function makeRift(fromX,fromY,toX,toY){
    const segs=10;const pts=[{x:fromX,y:fromY}];
    for(let i=1;i<segs;i++){
      const t=i/segs;
      const bx=fromX+(toX-fromX)*t,by=fromY+(toY-fromY)*t;
      // perpendicular jitter
      const dx=toX-fromX,dy=toY-fromY;
      const len=Math.hypot(dx,dy);
      const px=-dy/len,py=dx/len;
      const jitter=(Math.random()-.5)*70*(Math.sin(t*Math.PI));
      pts.push({x:bx+px*jitter,y:by+py*jitter});
    }
    pts.push({x:toX,y:toY});
    return pts;
  }
  const rifts=[
    {pts:makeRift(cx,0,cx,cy),progress:0,width:0,delay:0},      // top
    {pts:makeRift(W,cy,cx,cy),progress:0,width:0,delay:80},     // right
    {pts:makeRift(cx,H,cx,cy),progress:0,width:0,delay:160},    // bottom
    {pts:makeRift(0,cy,cx,cy),progress:0,width:0,delay:240},    // left
  ];

  // Black hole grows at center once rifts arrive
  let bhRadius=0;
  let bhSpin=0;
  const diskPs=[]; // accretion disk particles spiraling in
  for(let i=0;i<180;i++){
    const a=Math.random()*Math.PI*2;
    const dist=30+Math.random()*Math.min(W,H)*.42;
    diskPs.push({angle:a,dist,baseSpd:.02+Math.random()*.04,r:1+Math.random()*3,opacity:.7+Math.random()*.3});
  }

  // post-explosion
  const arcs=[],rings=[],crystalShards=[];
  function spawnArc(){
    const a=Math.random()*Math.PI*2,dist=DIAG*.5;
    const sx=cx+Math.cos(a)*dist,sy=cy+Math.sin(a)*dist;
    const pts=[{x:sx,y:sy}];
    const segs=3+Math.floor(Math.random()*5);
    for(let i=1;i<segs;i++){const t=i/segs;pts.push({x:sx+(cx-sx)*t+(Math.random()-.5)*80*(1-t),y:sy+(cy-sy)*t+(Math.random()-.5)*80*(1-t)});}
    pts.push({x:cx+(Math.random()-.5)*20,y:cy+(Math.random()-.5)*20});
    arcs.push({pts,a:1,dec:.05+Math.random()*.04,w:.8+Math.random()*2});
  }
  function doExplosion(){
    exploded=true;flashA=1;
    for(let i=0;i<14;i++)spawnArc();
    for(let i=0;i<8;i++)rings.push({r:i*4,spd:22+i*10,a:1,w:4,delay:i*20});
    for(let i=0;i<70;i++){
      const a=Math.random()*Math.PI*2,spd=6+Math.random()*32;
      crystalShards.push({x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,len:3+Math.random()*16,angle:Math.random()*Math.PI,a:1,dec:.013+Math.random()*.011});
    }
    const el=document.getElementById('shakeInner');let sf=0;
    const siv=setInterval(()=>{sf++;const m=22*(1-sf/28);el.style.transform=`translate(${(Math.random()-.5)*m*2}px,${(Math.random()-.5)*m*2}px)`;if(sf>=28){clearInterval(siv);el.style.transform='';}},16);
    setTimeout(()=>{let t0=null;(function pi(ts){if(!t0)t0=ts;const p=Math.min((ts-t0)/500,1),e=1-Math.pow(1-p,3);tx.style.opacity=Math.min(e*2,1);tx.style.transform='scale('+(3.2-2.2*e)+')';if(p<1)requestAnimationFrame(pi);else tx.style.transform='scale(1)';})();},100);
    setTimeout(()=>{for(let i=0;i<10;i++)setTimeout(spawnArc,i*100);},180);
    setTimeout(()=>showRarityReveal(name,'omega'),260);
  }

  // explosion triggers when black hole reaches full size
  setTimeout(()=>doExplosion(),1800);
  setTimeout(()=>{
    omegaActive=false;
    let t1=null;(function fo(ts){if(!t1)t1=ts;const p=Math.min((ts-t1)/700,1),e=1-Math.pow(1-p,3);
      tx.style.opacity=1-e;ov.style.opacity=1-e;
      if(p<1)requestAnimationFrame(fo);
      else{cancelAnimationFrame(omegaRAF);ov.classList.remove('active');ov.style.opacity='';tx.style.opacity='';tx.style.transform='';ctx.clearRect(0,0,W,H);}
    })();
  },4200);

  function frame(ts){
    if(!omegaActive)return;
    if(!startTS)startTS=ts;
    const elapsed=ts-startTS;
    ctx.clearRect(0,0,W,H);

    bgAlpha=Math.min(.98,elapsed/250);
    ctx.fillStyle=`rgba(0,0,4,${bgAlpha})`;ctx.fillRect(0,0,W,H);
    ov.style.opacity=String(Math.min(bgAlpha,1));

    if(!exploded){
      // Draw 4 rifts growing inward
      ctx.save();
      for(const rift of rifts){
        if(elapsed<rift.delay)continue;
        const t=(elapsed-rift.delay)/700;
        rift.progress=Math.min(1,t);
        rift.width=Math.min(18,t*28);
        const visSegs=Math.floor(rift.progress*(rift.pts.length-1));
        if(visSegs<1)continue;
        ctx.beginPath();ctx.moveTo(rift.pts[0].x,rift.pts[0].y);
        for(let i=1;i<=visSegs;i++)ctx.lineTo(rift.pts[i].x,rift.pts[i].y);
        // outer glow
        ctx.strokeStyle='rgba(180,220,255,0.05)';ctx.lineWidth=rift.width+36;ctx.stroke();
        ctx.strokeStyle='rgba(200,230,255,0.12)';ctx.lineWidth=rift.width+14;ctx.stroke();
        // dark void
        ctx.strokeStyle='#000004';ctx.lineWidth=rift.width*.8;ctx.stroke();
        // white edge
        ctx.strokeStyle='rgba(255,255,255,0.85)';ctx.lineWidth=Math.max(1.2,rift.width*.1);ctx.stroke();
      }
      ctx.restore();

      // Black hole grows as rifts converge
      const riftsDone=rifts.filter(r=>r.progress>=0.85).length;
      const bhTarget=riftsDone*22+Math.max(0,elapsed-800)*.05;
      bhRadius+=(bhTarget-bhRadius)*.04;
      bhSpin+=0.025+bhRadius*.001;

      if(bhRadius>3){
        // draw black hole ‚Äî black circle with gravitational lensing ring
        ctx.save();

        // lensing glow rings (multiple layers)
        const lensR=bhRadius*1.8;
        for(let g=4;g>=1;g--){
          const gr=ctx.createRadialGradient(cx,cy,bhRadius*.7,cx,cy,lensR*g*.55);
          gr.addColorStop(0,`rgba(200,230,255,${.06/g})`);
          gr.addColorStop(.5,`rgba(150,200,255,${.12/g})`);
          gr.addColorStop(1,'rgba(0,0,0,0)');
          ctx.fillStyle=gr;ctx.globalAlpha=1;
          ctx.beginPath();ctx.arc(cx,cy,lensR*g*.55,0,Math.PI*2);ctx.fill();
        }
        // photon ring ‚Äî bright white arc
        ctx.strokeStyle='rgba(255,255,255,0.9)';ctx.lineWidth=2.5;ctx.globalAlpha=0.85;
        ctx.beginPath();ctx.arc(cx,cy,bhRadius*1.3,0,Math.PI*2);ctx.stroke();
        ctx.strokeStyle='rgba(180,220,255,0.5)';ctx.lineWidth=6;ctx.globalAlpha=0.4;
        ctx.beginPath();ctx.arc(cx,cy,bhRadius*1.3,0,Math.PI*2);ctx.stroke();
        // black interior
        ctx.fillStyle='#000000';ctx.globalAlpha=1;
        ctx.beginPath();ctx.arc(cx,cy,bhRadius,0,Math.PI*2);ctx.fill();
        ctx.restore();

        // accretion disk ‚Äî particles spiraling in
        ctx.save();
        for(const p of diskPs){
          const pullFactor=1+bhRadius*.012;
          p.angle+=p.baseSpd*pullFactor*(1+2*(1-Math.min(p.dist,200)/200));
          p.dist=Math.max(bhRadius+1,p.dist-(.8+bhRadius*.04));
          if(p.dist<=bhRadius+2){p.dist=80+Math.random()*Math.min(W,H)*.38;p.angle=Math.random()*Math.PI*2;}
          const px=cx+Math.cos(p.angle)*p.dist,py=cy+Math.sin(p.angle)*p.dist*.38; // flattened disk
          const distFrac=Math.max(0,Math.min(1,(p.dist-bhRadius)/(Math.min(W,H)*.4)));
          const hue=200+distFrac*30;
          ctx.globalAlpha=p.opacity*(1-distFrac*.3)*.75;
          ctx.fillStyle=`hsl(${hue},70%,${80-distFrac*30}%)`;
          ctx.beginPath();ctx.arc(px,py,p.r*(1-distFrac*.4),0,Math.PI*2);ctx.fill();
        }
        ctx.restore();
      }

    } else {
      // EXPLOSION PHASE
      if(flashA>0){ctx.fillStyle=`rgba(240,248,255,${flashA})`;ctx.fillRect(0,0,W,H);flashA=Math.max(0,flashA-.05);}
      // rings
      ctx.save();
      for(let i=rings.length-1;i>=0;i--){
        const r=rings[i];if(elapsed<r.delay+1800)continue;
        r.r+=r.spd;r.spd*=.92;r.a-=.015;
        if(r.a<=0){rings.splice(i,1);continue;}
        ctx.strokeStyle='rgba(200,230,255,1)';ctx.globalAlpha=r.a*.1;ctx.lineWidth=r.w+16;ctx.beginPath();ctx.arc(cx,cy,r.r,0,Math.PI*2);ctx.stroke();
        ctx.globalAlpha=r.a*.65;ctx.lineWidth=r.w*.4;ctx.beginPath();ctx.arc(cx,cy,r.r,0,Math.PI*2);ctx.stroke();
      }ctx.restore();
      // shards
      ctx.save();
      for(let i=crystalShards.length-1;i>=0;i--){
        const s=crystalShards[i];s.x+=s.vx;s.y+=s.vy;s.vy+=.12;s.vx*=.985;s.angle+=.07;s.a-=s.dec;
        if(s.a<=0){crystalShards.splice(i,1);continue;}
        ctx.save();ctx.translate(s.x,s.y);ctx.rotate(s.angle);ctx.globalAlpha=s.a;
        ctx.strokeStyle='rgba(210,240,255,0.95)';ctx.lineWidth=1.8;
        ctx.beginPath();ctx.moveTo(-s.len*.5,0);ctx.lineTo(s.len*.5,0);ctx.stroke();
        ctx.beginPath();ctx.moveTo(0,-s.len*.32);ctx.lineTo(0,s.len*.32);ctx.stroke();
        ctx.restore();
      }ctx.restore();
      // arcs
      ctx.save();
      for(let i=arcs.length-1;i>=0;i--){
        const b=arcs[i];b.a-=b.dec;if(b.a<=0){arcs.splice(i,1);continue;}
        ctx.strokeStyle='#aaeeff';ctx.globalAlpha=b.a*.1;ctx.lineWidth=b.w+8;drawBoltPath(ctx,b.pts);ctx.stroke();
        ctx.globalAlpha=b.a*.25;ctx.lineWidth=b.w+2;drawBoltPath(ctx,b.pts);ctx.stroke();
        ctx.strokeStyle='#ffffff';ctx.globalAlpha=b.a*.9;ctx.lineWidth=b.w;drawBoltPath(ctx,b.pts);ctx.stroke();
      }ctx.restore();
      // residual void glow
      const vp=.5+.5*Math.sin(elapsed*.018);
      ctx.save();const vg=ctx.createRadialGradient(cx,cy,0,cx,cy,90);
      vg.addColorStop(0,`rgba(255,255,255,${.22*vp})`);vg.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=vg;ctx.globalAlpha=1;ctx.beginPath();ctx.arc(cx,cy,90,0,Math.PI*2);ctx.fill();ctx.restore();
    }
    omegaRAF=requestAnimationFrame(frame);
  }
  omegaRAF=requestAnimationFrame(frame);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   M√çTICA ‚Äî LAVA BREACH
   Terra racha ‚Üí fissuras de lava se abrem pelo ch√£o
   ‚Üí colunas de magma jorram ‚Üí tudo pega fogo ‚Üí
   explos√£o de plasma carmesim ‚Üí nome em brasa
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let miticaRAF=null,miticaActive=false;
function triggerMiticaAnim(name){
  if(!cutsceneEnabled) return;
  const ov=document.getElementById('miticaOverlay'),tx=document.getElementById('miticaText'),c=document.getElementById('miticaCanvas');
  tx.innerText='‚ú¶  '+name.toUpperCase()+'  ‚ú¶';
  tx.style.cssText='font-family:Cinzel Decorative,serif;font-size:clamp(1.2rem,3.5vw,2.5rem);color:#ff6633;letter-spacing:5px;text-align:center;position:relative;z-index:10;text-shadow:0 0 20px #ff2200,0 0 50px #ff440066;opacity:0;pointer-events:none;transform:scale(2.5);';
  ov.classList.add('active');ov.style.opacity='1';
  c.width=innerWidth;c.height=innerHeight;
  const ctx=c.getContext('2d');
  const W=c.width,H=c.height,cx=W/2,cy=H/2,DIAG=Math.hypot(W,H);

  // screen flash red
  document.body.style.background='#1a0000';setTimeout(()=>document.body.style.background='',120);
  // rumble shake
  const el=document.getElementById('shakeInner');let st=0;
  const siv=setInterval(()=>{st++;const m=st<10?10:5;el.style.transform=`translate(${(Math.random()-.5)*m}px,${(Math.random()-.5)*m}px)`;if(st>22){clearInterval(siv);el.style.transform='';}},32);

  // cracks: polylines from center outward
  const cracks=[];
  const numCracks=7;
  for(let i=0;i<numCracks;i++){
    const baseAngle=(i/numCracks)*Math.PI*2+Math.random()*.4;
    const pts=[{x:cx,y:cy}];
    let ax=cx,ay=cy,angle=baseAngle;
    const segs=6+Math.floor(Math.random()*5);
    const totalLen=DIAG*.45+Math.random()*DIAG*.2;
    const segLen=totalLen/segs;
    for(let s=0;s<segs;s++){
      angle+=((Math.random()-.5)*.7);
      ax+=Math.cos(angle)*segLen;ay+=Math.sin(angle)*segLen;
      pts.push({x:ax,y:ay});
    }
    cracks.push({pts,progress:0,spd:.04+Math.random()*.03,width:2+Math.random()*5,lavaA:0,delay:i*80});
  }

  // lava jets from cracks
  const lavaPs=[];
  function spawnLava(x,y,n){
    for(let i=0;i<n;i++){
      const a=-Math.PI*.5+(Math.random()-.5)*Math.PI*.7;
      const spd=4+Math.random()*16;
      lavaPs.push({x,y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:3+Math.random()*10,a:1,h:Math.random()*22,dec:.012+Math.random()*.012});
    }
  }

  // sparks
  const sparks2=[];
  for(let i=0;i<60;i++){
    const a=Math.random()*Math.PI*2,spd=5+Math.random()*20;
    sparks2.push({x:cx+(Math.random()-.5)*120,y:cy+(Math.random()-.5)*120,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-(8+Math.random()*5),r:1.2+Math.random()*4,a:1,h:Math.random()*25,tr:[]});
  }

  // name reveal
  setTimeout(()=>{
    let t0=null;(function fi(ts){if(!t0)t0=ts;const p=Math.min((ts-t0)/500,1),e=1-Math.pow(1-p,3);tx.style.opacity=e;tx.style.transform='scale('+(2.5-1.5*e)+')';if(p<1)requestAnimationFrame(fi);else tx.style.transform='scale(1)';})();
  },350);
  setTimeout(()=>showRarityReveal(name,'mitica'),420);

  miticaActive=true;let startTS2=null;
  function miticaFrame(ts){
    if(!miticaActive)return;
    if(!startTS2)startTS2=ts;const elapsed=ts-startTS2;
    ctx.clearRect(0,0,W,H);
    // dark bg with red tint
    const bgA=Math.min(.94,elapsed/200);
    ctx.fillStyle=`rgba(8,0,0,${bgA})`;ctx.fillRect(0,0,W,H);

    // draw cracks
    ctx.save();
    for(const crack of cracks){
      if(elapsed<crack.delay)continue;
      crack.progress=Math.min(1,crack.progress+crack.spd);
      crack.lavaA=Math.min(1,crack.lavaA+.025);
      const visSegs=Math.floor(crack.progress*(crack.pts.length-1));
      if(visSegs<1)continue;
      // spawn lava particles at tip
      if(crack.progress<1&&Math.random()<.4){
        const tip=crack.pts[Math.min(visSegs,crack.pts.length-1)];
        spawnLava(tip.x,tip.y,2);
      }
      // crack glow
      ctx.strokeStyle=`rgba(255,80,0,${crack.lavaA*.15})`;ctx.lineWidth=crack.width+16;
      ctx.beginPath();ctx.moveTo(crack.pts[0].x,crack.pts[0].y);
      for(let i=1;i<=visSegs;i++)ctx.lineTo(crack.pts[i].x,crack.pts[i].y);
      ctx.stroke();
      // lava glow inside
      ctx.strokeStyle=`rgba(255,140,0,${crack.lavaA*.5})`;ctx.lineWidth=crack.width+4;ctx.stroke();
      // dark crack line
      ctx.strokeStyle='#0a0000';ctx.lineWidth=crack.width*.5;ctx.stroke();
      // bright core
      ctx.strokeStyle=`rgba(255,240,120,${crack.lavaA*.9})`;ctx.lineWidth=Math.max(1,crack.width*.18);ctx.stroke();
    }
    ctx.restore();

    // lava particles
    ctx.save();
    for(let i=lavaPs.length-1;i>=0;i--){
      const p=lavaPs[i];p.x+=p.vx;p.y+=p.vy;p.vy+=.35;p.vx*=.97;p.r*=.97;p.a-=p.dec;p.h=Math.min(p.h+.8,30);
      if(p.a<=0||p.r<.5){lavaPs.splice(i,1);continue;}
      ctx.fillStyle=`hsl(${p.h},100%,50%)`;ctx.globalAlpha=p.a*.14;ctx.beginPath();ctx.arc(p.x,p.y,p.r+8,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=`hsl(${p.h+8},100%,62%)`;ctx.globalAlpha=p.a*.35;ctx.beginPath();ctx.arc(p.x,p.y,p.r+2,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=`hsl(${p.h+16},100%,78%)`;ctx.globalAlpha=p.a;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    }ctx.restore();

    // sparks
    ctx.save();
    for(let i=sparks2.length-1;i>=0;i--){
      const s=sparks2[i];s.tr.push({x:s.x,y:s.y});if(s.tr.length>7)s.tr.shift();
      s.x+=s.vx;s.y+=s.vy;s.vy+=.28;s.vx*=.98;s.a-=.022;s.r*=.977;
      if(s.a<=0){sparks2.splice(i,1);continue;}
      for(let j=0;j<s.tr.length;j++){ctx.globalAlpha=s.a*(j/s.tr.length)*.35;ctx.fillStyle=`hsl(${s.h+j*3},100%,70%)`;ctx.beginPath();ctx.arc(s.tr[j].x,s.tr[j].y,s.r*(j/s.tr.length)*.8,0,Math.PI*2);ctx.fill();}
      ctx.fillStyle=`hsl(${s.h+10},100%,88%)`;ctx.globalAlpha=s.a;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
    }ctx.restore();

    // heat shimmer glow from center
    const heat=.3+.3*Math.abs(Math.sin(elapsed*.012));
    ctx.save();const hg=ctx.createRadialGradient(cx,cy,0,cx,cy,160);
    hg.addColorStop(0,`rgba(255,60,0,${heat*.18})`);hg.addColorStop(.5,`rgba(255,30,0,${heat*.06})`);hg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=hg;ctx.globalAlpha=1;ctx.beginPath();ctx.arc(cx,cy,160,0,Math.PI*2);ctx.fill();ctx.restore();

    ctx.globalAlpha=1;
    miticaRAF=requestAnimationFrame(miticaFrame);
  }
  miticaRAF=requestAnimationFrame(miticaFrame);

  setTimeout(()=>{
    miticaActive=false;let t1=null;
    (function fo(ts){if(!t1)t1=ts;const p=Math.min((ts-t1)/700,1),e=1-Math.pow(1-p,3);
      tx.style.opacity=1-e;ov.style.opacity=1-e;
      if(p<1)requestAnimationFrame(fo);
      else{ov.classList.remove('active');ov.style.opacity='';tx.style.opacity='';tx.style.transform='';ctx.clearRect(0,0,W,H);}
    })();
  },3000);
}
function shakeBody(i){const el=document.getElementById('shakeInner');let t=0;const iv=setInterval(()=>{t++;const m=i*(1-t/16);el.style.transform=`translate(${(Math.random()-.5)*m*2}px,${(Math.random()-.5)*m*2}px)`;if(t>=16){clearInterval(iv);el.style.transform='';}},30);}
function drawBoltPath(ctx,pts){ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i].x,pts[i].y);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RARITY REVEAL ‚Äî nome grande em destaque ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _revealTO=null;
let cutsceneEnabled = localStorage.getItem('cutsceneEnabled') !== 'false';
function toggleCutscenes(){
  cutsceneEnabled = !cutsceneEnabled;
  localStorage.setItem('cutsceneEnabled', cutsceneEnabled);
  const knob = document.getElementById('cutsceneToggleKnob');
  const track = document.getElementById('cutsceneToggle');
  if(cutsceneEnabled){
    track.style.background='var(--accent)';
    knob.style.left='23px';
  } else {
    track.style.background='var(--text3)';
    knob.style.left='3px';
  }
}
function initCutsceneToggle(){
  const track = document.getElementById('cutsceneToggle');
  const knob = document.getElementById('cutsceneToggleKnob');
  if(cutsceneEnabled){
    if(track) track.style.background='var(--accent)';
    if(knob) knob.style.left='23px';
  } else {
    if(track) track.style.background='var(--text3)';
    if(knob) knob.style.left='3px';
  }
}

function showRarityReveal(name,rarity){
  if(!cutsceneEnabled) return;
  clearTimeout(_revealTO);
  const ov=document.getElementById('rarityRevealOverlay');
  const tx=document.getElementById('rarityRevealText');
  const sb=document.getElementById('rarityRevealSub');
  const glow=document.getElementById('rarityRevealGlow');
  const s=RS[rarity];
  /* style text based on rarity */
  if(rarity==='aurora'){
    tx.style.cssText='font-family:Cinzel Decorative,serif;font-size:clamp(2.5rem,7vw,6rem);font-weight:700;text-align:center;letter-spacing:8px;line-height:1.15;padding:20px 40px;background:linear-gradient(270deg,#ff0080,#ff8800,#aaff00,#00ff88,#00cfff,#aa44ff,#ff0080);background-size:300% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:auroraShift 1.2s linear infinite;filter:drop-shadow(0 0 30px #ff0080) drop-shadow(0 0 60px #00cfff);';
    sb.style.cssText='font-family:Rajdhani,sans-serif;font-size:1.4rem;font-weight:700;text-align:center;letter-spacing:5px;margin-top:8px;background:linear-gradient(270deg,#ff0080,#00cfff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;';
    ov.style.background='radial-gradient(ellipse at center, rgba(80,0,80,.85) 0%, rgba(0,0,30,.95) 100%)';
    glow.style.cssText='position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse at center, #ff008066 0%, #00cfff33 50%, transparent 80%);filter:blur(40px);opacity:1;';
  } else if(rarity==='omega'){
    tx.style.cssText='font-family:Cinzel Decorative,serif;font-size:clamp(2.5rem,7vw,6rem);font-weight:700;text-align:center;letter-spacing:8px;line-height:1.15;padding:20px 40px;color:#ffffff;text-shadow:0 0 30px #fff,0 0 60px #aaddff,0 0 100px rgba(180,220,255,.6);';
    sb.style.cssText='font-family:Rajdhani,sans-serif;font-size:1.4rem;font-weight:700;text-align:center;letter-spacing:5px;margin-top:8px;color:#aaddff;text-shadow:0 0 15px #aaddff;';
    ov.style.background='radial-gradient(ellipse at center, rgba(10,20,50,.88) 0%, rgba(0,0,20,.96) 100%)';
    glow.style.cssText='position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse at center, #aaddff55 0%, #4488ff22 50%, transparent 80%);filter:blur(40px);opacity:1;';
  } else if(rarity==='mitica'){
    tx.style.cssText='font-family:Cinzel Decorative,serif;font-size:clamp(2.5rem,7vw,6rem);font-weight:700;text-align:center;letter-spacing:8px;line-height:1.15;padding:20px 40px;color:#ff6633;text-shadow:0 0 25px #ff2200,0 0 55px #ff0000,0 0 90px rgba(255,0,0,.5);';
    sb.style.cssText='font-family:Rajdhani,sans-serif;font-size:1.4rem;font-weight:700;text-align:center;letter-spacing:5px;margin-top:8px;color:#ff4400;text-shadow:0 0 15px #ff0000;';
    ov.style.background='radial-gradient(ellipse at center, rgba(60,5,0,.88) 0%, rgba(20,0,0,.96) 100%)';
    glow.style.cssText='position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse at center, #ff220066 0%, #ff000033 50%, transparent 80%);filter:blur(40px);opacity:1;';
  } else {
    /* other rarities ‚Äî glow com cor da raridade */
    glow.style.cssText='position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse at center, '+s.border+'55 0%, '+s.border+'22 50%, transparent 80%);filter:blur(50px);opacity:1;';
  }
  tx.innerText=name.toUpperCase();
  sb.innerText='‚ú¶ '+s.label+' ‚ú¶';
  /* animate in */
  tx.style.animation=(tx.style.animation||'')+',rarityRevealIn .55s cubic-bezier(.34,1.56,.64,1) forwards';
  ov.style.opacity='1';
  ov.style.zIndex='1300';
  /* fade out ‚Äî glow fades with overlay */
  _revealTO=setTimeout(()=>{
    ov.style.transition='opacity .6s';ov.style.opacity='0';
    setTimeout(()=>{ov.style.transition='';ov.style.opacity='0';ov.style.zIndex='1200';glow.style.cssText='';},650);
  },2800);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARACTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function createCharacter(){
  const char=document.createElement('div');char.className='character';
  char._lockedRarities={};
  const hdr=document.createElement('div');hdr.className='charHeader';
  const nm=document.createElement('span');nm.className='char-name';nm.innerText='Personagem '+charCount;
  nm.onclick=()=>promptModal('Renomear Personagem',nm.innerText,v=>nm.innerText=v);
  hdr.appendChild(nm);
  /* lock-all button */
  const lockAllBtn=document.createElement('span');lockAllBtn.className='icon-btn lock-all-btn';lockAllBtn.innerText='üîí';lockAllBtn.title='Fixar/Desfixar todas as raridades';
  lockAllBtn.onclick=()=>toggleLockAll(char,lockAllBtn);
  hdr.appendChild(lockAllBtn);
  [{i:'‚ûï',t:'Adicionar',f:()=>openSkillPicker(char,null,null)},{i:'üìå',t:'Fixar Personagem',f:()=>{char.classList.toggle('pinned');savePinned();showToast(char.classList.contains('pinned')?'üìå Fixado.':'Desafixado.');}},{i:'üóë',t:'Deletar',f:()=>{if(!char.classList.contains('pinned'))char.remove();}},{i:'üìã',t:'Copiar',f:()=>copyChar(char)}].forEach(({i,t,f})=>{const s=document.createElement('span');s.className='icon-btn';s.innerText=i;s.title=t;s.onclick=f;hdr.appendChild(s);});
  char.appendChild(hdr);
  const contentWrap=document.createElement('div');contentWrap.className='char-with-desc';
  const skillsCol=document.createElement('div');skillsCol.className='char-skills-col';
  const descPanel=document.createElement('div');descPanel.className='char-desc-panel';
  descPanel.style.display='none';
  contentWrap.appendChild(skillsCol);contentWrap.appendChild(descPanel);
  char.appendChild(contentWrap);
  char._descPanel=descPanel;char._skillsCol=skillsCol;
  for(let i=0;i<categories.length;i++){
    const ct=document.createElement('h4');ct.innerText='‚Äî '+categories[i].name+' ‚Äî';ct.style.marginTop='9px';skillsCol.appendChild(ct);
    for(let j=0;j<categories[i].subcategories.length;j++){
      const sub=categories[i].subcategories[j],p=document.createElement('p');
      p.className='skill-item empty-slot';p.dataset.sub=sub.name;
      p.dataset.catName=categories[i].name;
      const lockBtn=document.createElement('span');lockBtn.className='skill-lock-btn';lockBtn.innerText='üîí';lockBtn.title='Fixar raridade';
      lockBtn.onclick=(e)=>{e.stopPropagation();toggleSkillLock(p,char,sub);};
      const clearBtn=document.createElement('span');clearBtn.className='skill-clear-btn';clearBtn.innerText='‚úï';clearBtn.title='Limpar resultado';
      clearBtn.onclick=(e)=>{e.stopPropagation();clearSkill(p,char,sub);};
      p.appendChild(clearBtn);p.appendChild(lockBtn);
      const textNode=document.createTextNode(sub.name+': ‚Äî (clique para girar)');p.insertBefore(textNode,clearBtn);
      p.style.cssText='background:var(--bg3);border:1px solid var(--border2);color:var(--text3);animation:none;';
      attachSkillClick(p,sub,char);skillsCol.appendChild(p);
    }
  }
  document.getElementById('characters').appendChild(char);charCount++;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Sync live: atualiza categorias/subs nos personagens j√° criados
   Mant√©m dados de habilidades giradas, s√≥ reorganiza a estrutura
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function syncCharactersToCategories(){
  document.querySelectorAll('.character').forEach(char=>{
    const skillsCol=char._skillsCol;if(!skillsCol)return;
    /* salva estado atual dos skill-items (sub ‚Üí {pEl data}) */
    const savedSkills={};
    skillsCol.querySelectorAll('p.skill-item').forEach(p=>{
      const key=p.dataset.sub;
      if(key) savedSkills[key]={
        percent:p.dataset.percent,
        resultName:p.dataset.resultName,
        desc:p.dataset.desc,
        locked:p.classList.contains('locked'),
        style:p.getAttribute('style'),
        classList:[...p.classList],
      };
    });
    /* limpa skillsCol e reconstr√≥i na nova ordem */
    skillsCol.innerHTML='';
    for(let i=0;i<categories.length;i++){
      const cat=categories[i];
      const ct=document.createElement('h4');
      ct.innerText='‚Äî '+cat.name+' ‚Äî';ct.style.marginTop='9px';
      skillsCol.appendChild(ct);
      for(let j=0;j<cat.subcategories.length;j++){
        const sub=cat.subcategories[j];
        const saved=savedSkills[sub.name];
        const p=document.createElement('p');
        p.className='skill-item';
        p.dataset.sub=sub.name;
        p.dataset.catName=cat.name;
        const lockBtn=document.createElement('span');lockBtn.className='skill-lock-btn';lockBtn.innerText='üîí';lockBtn.title='Fixar raridade';
        lockBtn.onclick=(e)=>{e.stopPropagation();toggleSkillLock(p,char,sub);};
        const clearBtn=document.createElement('span');clearBtn.className='skill-clear-btn';clearBtn.innerText='‚úï';clearBtn.title='Limpar resultado';
        clearBtn.onclick=(e)=>{e.stopPropagation();clearSkill(p,char,sub);};
        p.appendChild(clearBtn);p.appendChild(lockBtn);
        if(saved&&saved.percent){
          /* restaura dados girados */
          p.dataset.percent=saved.percent;
          p.dataset.resultName=saved.resultName;
          p.dataset.desc=saved.desc||'';
          if(saved.locked){p.classList.add('locked');if(!char._lockedRarities)char._lockedRarities={};char._lockedRarities[sub.name]=getRarity(parseFloat(saved.percent));}
          const textNode=document.createTextNode(sub.name+': '+saved.resultName+' ('+parseFloat(saved.percent).toFixed(2)+'%)');
          p.insertBefore(textNode,clearBtn);
          if(saved.style)p.setAttribute('style',saved.style);
          saved.classList.forEach(c=>{if(c!=='skill-item')p.classList.add(c);});
        } else {
          /* slot vazio */
          p.classList.add('empty-slot');
          const textNode=document.createTextNode(sub.name+': ‚Äî (clique para girar)');p.insertBefore(textNode,clearBtn);
          p.style.cssText='background:var(--bg3);border:1px solid var(--border2);color:var(--text3);animation:none;';
        }
        attachSkillClick(p,sub,char);
        skillsCol.appendChild(p);
      }
    }
  });
}

function toggleSkillLock(pEl,char,subRef){
  const r=getRarity(parseFloat(pEl.dataset.percent||'0'));
  if(!pEl.dataset.percent){showToast('‚ö† Gire primeiro para fixar!');return;}
  if(pEl.classList.contains('locked')){
    pEl.classList.remove('locked');delete char._lockedRarities[subRef.name];
    showToast('üîì Raridade desfixada.');
  }else{
    pEl.classList.add('locked');char._lockedRarities[subRef.name]=r;
    showToast('üîí Raridade "'+RS[r].label+'" fixada para '+subRef.name+'!');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   copyChar: s√≥ nome da op√ß√£o, sem raridade nem porcentagem
   Inclui descri√ß√£o das habilidades FIXADAS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function copyChar(char){
  const charName=char.querySelector('.char-name')?char.querySelector('.char-name').innerText:'Personagem';
  let t=charName+'\n';
  char.querySelectorAll('p.skill-item').forEach(p=>{
    const subName=p.dataset.sub||'HABILIDADE';
    if(p.dataset.percent&&p.dataset.resultName){
      let line=subName+': '+p.dataset.resultName;
      if(p.classList.contains('locked')&&p.dataset.desc&&p.dataset.desc.trim()){
        line+=' ‚Äî '+p.dataset.desc.trim();
      }
      t+=line+'\n';
    } else {
      t+=subName+': NENHUMA\n';
    }
  });
  copyToClipboard(t.trim(),'üìã '+charName+' copiado!');
}

function toggleLockAll(char,btn){
  const allSkills=Array.from(char.querySelectorAll('p.skill-item')).filter(p=>p.dataset.percent);
  if(!allSkills.length){showToast('‚ö† Gire primeiro para fixar!');return;}
  const anyUnlocked=allSkills.some(p=>!p.classList.contains('locked'));
  if(anyUnlocked){
    /* lock all */
    allSkills.forEach(p=>{
      if(!p.classList.contains('locked')){
        p.classList.add('locked');
        const subName=p.dataset.sub;
        const r=getRarity(parseFloat(p.dataset.percent));
        char._lockedRarities[subName]=r;
      }
    });
    btn.classList.add('all-locked');btn.title='Desfixar todas as raridades';
    showToast('üîí Todas as raridades fixadas!');
  }else{
    /* unlock all */
    allSkills.forEach(p=>{
      p.classList.remove('locked');
      const subName=p.dataset.sub;
      delete char._lockedRarities[subName];
    });
    btn.classList.remove('all-locked');btn.title='Fixar todas as raridades';
    showToast('üîì Todas as raridades desfixadas!');
  }
}

function clearSkill(pEl,char,sub){
  if(pEl.classList.contains('locked')){showToast('üîí Desfixe antes de limpar!');return;}
  Array.from(pEl.childNodes).filter(n=>n.nodeType===3).forEach(n=>n.remove());
  const clearBtn=pEl.querySelector('.skill-clear-btn');
  const lockBtn=pEl.querySelector('.skill-lock-btn');
  const textNode=document.createTextNode(sub.name+': ‚Äî (clique para girar)');
  pEl.insertBefore(textNode,clearBtn||lockBtn||null);
  pEl.dataset.percent='';pEl.dataset.resultName='';pEl.dataset.desc='';
  pEl.style.cssText='background:var(--bg3);border:1px solid var(--border2);color:var(--text3);animation:none;box-shadow:none;';
  pEl.classList.add('empty-slot');
  if(char)updateCharDescPanel(char);
}
function generateAll(){
  if(!categories.length){flashRed('‚ö† Nenhuma categoria!\nImporte ou crie categorias primeiro.');showToast('‚ö† Nenhuma categoria!');return;}
  const n=parseInt(document.getElementById('amount').value)||1;
  document.querySelectorAll('.character:not(.pinned)').forEach(c=>c.remove());
  for(let i=0;i<n;i++)createCharacter();
}
function generateOne(){
  if(!categories.length){flashRed('‚ö† Nenhuma categoria!\nImporte ou crie categorias primeiro.');showToast('‚ö† Nenhuma categoria!');return;}
  createCharacter();
}

function updateCharDescPanel(char){
  const panel=char._descPanel;if(!panel)return;
  panel.innerHTML='';let hasDesc=false;
  char.querySelectorAll('p.skill-item').forEach(p=>{
    if(!p.dataset.percent)return;
    const r=getRarity(parseFloat(p.dataset.percent));
    const s=RS[r];
    const desc=p.dataset.desc||'';
    if(desc){
      hasDesc=true;
      const item=document.createElement('div');item.className='desc-item';
      item.style.cssText='border-left-color:'+s.border+';background:'+s.fill+';';
      const nm=document.createElement('div');nm.className='desc-item-name';nm.style.color=s.tc;
      nm.innerText=p.dataset.sub;
      const tx=document.createElement('div');tx.className='desc-item-text';tx.innerText=desc;
      tx.style.color=s.tc+'cc';
      item.appendChild(nm);item.appendChild(tx);panel.appendChild(item);
    }
  });
  panel.style.display=hasDesc?'block':'none';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MULTI-SPIN ‚Äî RAF COMPARTILHADO
   Um √∫nico requestAnimationFrame para todas as roletas.
   drawMiniSlices usa cache pr√©-computado (vis nunca muda).
   Resultado: 20 roletas = custo de 1 RAF, n√£o de 20.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let multiSpinCanvases=[],multiSpinTargetChar=null;
let _msRAF=null,_msActive=false;

/* helper: pr√©-computa vis para um norm e guarda no objeto */
function _buildVisCache(norm){
  const MIN_VIS=2;
  const raw=norm.map(o=>Math.max(o.percent,MIN_VIS));
  const total=raw.reduce((s,v)=>s+v,0);
  return raw.map(v=>(v/total)*Math.PI*2);
}

/* gradient cache keyed by canvas size */
const _hubGradCache={};
function _drawMiniCanvas(cv,norm,visCache,angle,hi,isLocked){
  const ctx=cv.getContext('2d',{alpha:false});
  const W=cv.width,cx=W/2,rr=W/2-1.5;
  ctx.fillStyle='#070710';ctx.fillRect(0,0,W,W);
  let ang=angle;
  for(let i=0;i<norm.length;i++){
    const sl=visCache[i],s=RS[getRarity(norm[i].percent)];
    ctx.beginPath();ctx.moveTo(cx,cx);ctx.arc(cx,cx,rr,ang,ang+sl);ctx.closePath();
    ctx.fillStyle=hi===i?'#ffffff':s.fill;ctx.fill();
    if(norm.length<=60){/* only stroke borders for smaller wheels */
      ctx.strokeStyle=hi===i?'#ffffff':s.border;ctx.lineWidth=.8;ctx.stroke();
    }
    ang+=sl;
  }
  /* rim */
  ctx.beginPath();ctx.arc(cx,cx,rr,0,Math.PI*2);ctx.strokeStyle='#1a1a2e';ctx.lineWidth=2;ctx.stroke();
  /* hub ‚Äî cached gradient */
  const hub=Math.max(4,rr*.12);
  if(!_hubGradCache[W]){
    const hg=ctx.createRadialGradient(cx,cx,0,cx,cx,hub);
    hg.addColorStop(0,'#2a2a45');hg.addColorStop(1,'#0a0a15');
    _hubGradCache[W]=hg;
  }
  ctx.beginPath();ctx.arc(cx,cx,hub,0,Math.PI*2);ctx.fillStyle=_hubGradCache[W];ctx.fill();
  /* locked overlay */
  if(isLocked&&hi===-1){
    ctx.save();ctx.globalAlpha=.28;ctx.fillStyle='#000';ctx.beginPath();ctx.arc(cx,cx,rr,0,Math.PI*2);ctx.fill();ctx.restore();
    ctx.font='bold '+Math.max(14,Math.floor(rr*.45))+'px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('üîí',cx,cx);
  }
}

/* loop √∫nico ‚Äî roda durante idle E durante spin
   PERF: idle canvases s√≥ redesenham a cada 4 frames (~15fps) */
let _msIdleFrame=0;
function _msLoop(ts){
  if(!_msActive)return;
  _msIdleFrame++;
  const isIdleFrame=(_msIdleFrame%4===0); /* idle at ~15fps, spin at 60fps */
  let anySpinning=false;
  for(let i=0;i<multiSpinCanvases.length;i++){
    const mc=multiSpinCanvases[i];
    if(mc._spinDone)continue;
    if(mc._spinning){
      anySpinning=true;
      if(!mc._t0)mc._t0=ts;
      const t=Math.min((ts-mc._t0)/mc._dur,1);
      const t2=t<.07?t*1.6:(.112+.888*(1-Math.pow(1-(t-.07)/.93,4)));
      mc.angle=mc._startA+(mc._totalA-mc._startA)*t2;
      if(t>=1){
        mc.angle=mc._finalA;
        _drawMiniCanvas(mc.cv,mc.norm,mc.vis,mc._finalA,mc._ri,mc.isLocked);
        mc._spinning=false;mc._spinDone=true;
        const s=RS[mc._rr];mc.resultDiv.innerText=mc._result.name;
        if(mc._rr==='aurora')mc.resultDiv.style.cssText='animation:auroraShift 2s linear infinite;background-image:linear-gradient(270deg,#ff0080,#ff8800,#aaff00,#00ff88,#00cfff,#aa44ff,#ff0080);background-size:300% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:.7rem;font-weight:600;text-align:center;padding:1px 5px;border-radius:5px;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:Rajdhani,sans-serif;border:1px solid #ff0080;';
        else mc.resultDiv.style.cssText='background:'+s.bg+';border:1px solid '+s.border+';color:'+s.tc+';font-size:.7rem;font-weight:600;text-align:center;padding:1px 5px;border-radius:5px;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:Rajdhani,sans-serif;';
        mc._onDone&&mc._onDone();
        continue;
      }
      _drawMiniCanvas(mc.cv,mc.norm,mc.vis,mc.angle,-1,mc.isLocked);
    } else if(!mc.isLocked){
      /* idle: slow rotation, only redraw at 15fps to save CPU */
      mc.angle+=0.0009;
      if(isIdleFrame)_drawMiniCanvas(mc.cv,mc.norm,mc.vis,mc.angle,-1,mc.isLocked);
    }
  }
  /* if nothing spinning, slow down RAF to ~30fps using setTimeout trick */
  if(!anySpinning){
    setTimeout(()=>{_msRAF=requestAnimationFrame(_msLoop);},33);
  } else {
    _msRAF=requestAnimationFrame(_msLoop);
  }
}

function _startMsLoop(){
  if(_msActive)return;
  _msActive=true;_msRAF=requestAnimationFrame(_msLoop);
}
function _stopMsLoop(){
  _msActive=false;if(_msRAF)cancelAnimationFrame(_msRAF);_msRAF=null;
}

function openMultiSpin(){
  if(!categories.length){flashRed('‚ö† Nenhuma categoria!\nImporte ou crie categorias primeiro.');showToast('‚ö† Nenhuma categoria!');return;}
  const chars=Array.from(document.querySelectorAll('.character'));
  if(!chars.length){flashRed('‚ö† Nenhum personagem!\nGere um personagem primeiro.');showToast('‚ö† Nenhum personagem!');return;}
  /* reset state fully before reopening */
  _stopMsLoop();multiSpinCanvases=[];multiSpinTargetChar=null;
  /* reset button states */
  const startBtn=document.getElementById('multiSpinStartBtn');startBtn.disabled=false;
  const closeBtn=document.getElementById('multiSpinCloseBtn');closeBtn.style.visibility='visible';closeBtn.style.opacity='1';
  const sel=document.getElementById('multiSpinCharSelect');sel.innerHTML='';
  chars.forEach((c,idx)=>{
    const nm=c.querySelector('.char-name')?c.querySelector('.char-name').innerText:'Personagem '+(idx+1);
    const opt=document.createElement('option');opt.value=idx;opt.innerText=nm+(c.classList.contains('pinned')?'  üìå':'');
    sel.appendChild(opt);
  });
  const defIdx=chars.findIndex(c=>!c.classList.contains('pinned'));
  if(defIdx>=0)sel.value=defIdx;
  multiSpinTargetChar=chars[parseInt(sel.value)];
  _buildMultiSpinGrid();
  document.getElementById('multiSpinOverlay').classList.add('visible');
}
function onMultiSpinCharChange(){
  const chars=Array.from(document.querySelectorAll('.character'));
  multiSpinTargetChar=chars[parseInt(document.getElementById('multiSpinCharSelect').value)]||null;
  const nm=multiSpinTargetChar&&multiSpinTargetChar.querySelector('.char-name')?multiSpinTargetChar.querySelector('.char-name').innerText:'';
  document.getElementById('multiSpinTitle').innerText='üé∞ Girar Todas'+(nm?' ‚Äî '+nm:'');
  /* reset start btn and rebuild grid for new char */
  const startBtn=document.getElementById('multiSpinStartBtn');startBtn.disabled=false;
  const closeBtn=document.getElementById('multiSpinCloseBtn');closeBtn.style.visibility='visible';closeBtn.style.opacity='1';
  _buildMultiSpinGrid();
}
function _buildMultiSpinGrid(){
  _stopMsLoop();
  const grid=document.getElementById('multiSpinGrid');grid.innerHTML='';
  multiSpinCanvases=[];
  const charName=multiSpinTargetChar&&multiSpinTargetChar.querySelector('.char-name')?multiSpinTargetChar.querySelector('.char-name').innerText:'';
  document.getElementById('multiSpinTitle').innerText='üé∞ Girar Todas'+(charName?' ‚Äî '+charName:'');
  const allSubs=[];categories.forEach(c=>c.subcategories.forEach(s=>{if(s.options.length)allSubs.push({cat:c.name,sub:s});}));
  const count=allSubs.length;if(!count)return;
  const GAP=8,availW=Math.min(window.innerWidth-28,1400),availH=window.innerHeight-130;
  const MIN_SZ=52,MAX_SZ=150;
  let bestCols=1,bestSz=MIN_SZ;
  for(let cols=Math.min(count,Math.ceil(Math.sqrt(count*1.6)));cols>=1;cols--){
    const rows=Math.ceil(count/cols);
    const sz=Math.min(Math.floor((availW-GAP*(cols-1))/cols),Math.floor((availH-GAP*(rows-1)-64*rows)/rows),MAX_SZ);
    if(sz>=MIN_SZ){bestCols=cols;bestSz=sz;break;}
  }
  grid.style.cssText='display:grid;grid-template-columns:repeat('+bestCols+','+bestSz+'px);gap:'+GAP+'px;justify-content:center;justify-items:center;align-items:start;';

  allSubs.forEach(({cat,sub})=>{
    const isLocked=!!(multiSpinTargetChar&&multiSpinTargetChar._lockedRarities&&multiSpinTargetChar._lockedRarities[sub.name]);
    const pElLocked=isLocked&&multiSpinTargetChar?multiSpinTargetChar.querySelector('p.skill-item[data-sub="'+sub.name.replace(/"/g,'&quot;')+'"]'):null;
    const wrap=document.createElement('div');wrap.className='mini-roulette-wrap';wrap.style.width=bestSz+'px';
    const catLbl=document.createElement('div');catLbl.className='mini-roulette-cat';catLbl.innerText=cat;catLbl.style.maxWidth=bestSz+'px';
    const subLbl=document.createElement('div');subLbl.className='mini-roulette-subname';subLbl.innerText=sub.name;subLbl.style.maxWidth=bestSz+'px';
    if(isLocked){subLbl.style.color='#ffcc00';subLbl.style.textShadow='0 0 6px #ffaa00';}
    const ptrSize=Math.max(6,Math.floor(bestSz*.09));
    const cvWrap=document.createElement('div');cvWrap.style.cssText='position:relative;width:'+bestSz+'px;height:'+(bestSz+ptrSize+2)+'px;flex-shrink:0;';
    const ptrColor=isLocked?'#ffcc00':'rgba(255,255,255,.75)';
    const ptr=document.createElement('div');
    ptr.style.cssText='position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:0;border-left:'+ptrSize+'px solid transparent;border-right:'+ptrSize+'px solid transparent;border-top:'+(ptrSize+4)+'px solid '+ptrColor+';z-index:2;filter:drop-shadow(0 1px 4px #000a);';
    const cv=document.createElement('canvas');cv.width=bestSz;cv.height=bestSz;
    cv.style.cssText='border-radius:50%;display:block;position:absolute;bottom:0;left:50%;transform:translateX(-50%);';
    if(isLocked)cv.classList.add('mini-cv-locked');
    cvWrap.appendChild(ptr);cvWrap.appendChild(cv);
    const resultDiv=document.createElement('div');resultDiv.className='mini-roulette-result';resultDiv.style.maxWidth=bestSz+'px';
    if(isLocked&&pElLocked&&pElLocked.dataset.resultName){
      resultDiv.innerText='üîí '+pElLocked.dataset.resultName;
      resultDiv.style.cssText='border:1px solid #ffcc00;color:#ffcc00;background:rgba(255,204,0,.06);font-size:.7rem;font-weight:600;text-align:center;padding:1px 5px;border-radius:5px;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:Rajdhani,sans-serif;';
    }
    wrap.appendChild(catLbl);wrap.appendChild(subLbl);wrap.appendChild(cvWrap);wrap.appendChild(resultDiv);
    grid.appendChild(wrap);

    const norm=normalize(sub.options);
    const vis=_buildVisCache(norm); /* ‚Üê pr√©-computado uma vez */
    const mc={cv,norm,vis,sub,cat,resultDiv,isLocked,angle:-Math.PI/2,_spinning:false,_spinDone:false};
    _drawMiniCanvas(cv,norm,vis,-Math.PI/2,-1,isLocked);
    multiSpinCanvases.push(mc);
  });

  _startMsLoop();
}

function closeMultiSpin(){
  document.getElementById('multiSpinOverlay').classList.remove('visible');
  _stopMsLoop();multiSpinCanvases=[];multiSpinTargetChar=null;
}

function flashRed(msg){
  /* red screen flash for warnings */
  const fl=document.createElement('div');
  fl.style.cssText='position:fixed;inset:0;background:rgba(180,0,0,.35);z-index:9999;pointer-events:none;border:3px solid #cc0000;transition:opacity .5s;opacity:1;display:flex;align-items:center;justify-content:center;';
  if(msg){const tx=document.createElement('div');tx.style.cssText='font-family:Cinzel Decorative,serif;color:#ff6666;font-size:1.1rem;letter-spacing:3px;text-shadow:0 0 20px #ff0000;padding:20px;text-align:center;';tx.innerText=msg;fl.appendChild(tx);}
  document.body.appendChild(fl);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{fl.style.opacity='0';setTimeout(()=>fl.remove(),550);}));
}

function startMultiSpin(){
  if(!multiSpinCanvases.length)return;
  const btn=document.getElementById('multiSpinStartBtn');
  const closeBtn=document.getElementById('multiSpinCloseBtn');
  const toSpin=multiSpinCanvases.filter(mc=>!mc.isLocked);

  /* all locked ‚Äî warn and abort */
  if(toSpin.length===0){
    flashRed('‚ö† Todas as habilidades est√£o fixadas!\nDesfixe ao menos uma para girar.');
    showToast('‚ö† Nenhuma habilidade para girar ‚Äî todas fixadas!',3000);
    return;
  }

  btn.disabled=true;
  closeBtn.style.visibility='hidden';closeBtn.style.opacity='0';
  const dur=parseInt(document.getElementById('rcDuration').value)||4500;
  const spins=parseInt(document.getElementById('rcSpins').value)||8;
  const guarantee=getGuarantee();
  const rarOrder=['comum','incomum','rara','epica','lendaria','mitica','omega','aurora'];
  let highestRarity='comum';
  const allResults=[];
  /* collect locked rarities for climax check ‚Äî but DON'T trigger anim for them */
  multiSpinCanvases.filter(mc=>mc.isLocked).forEach(mc=>{
    const pEl=multiSpinTargetChar?multiSpinTargetChar.querySelector('p.skill-item[data-sub="'+mc.sub.name.replace(/"/g,'&quot;')+'"]'):null;
    /* locked items don't raise highestRarity for reveal ‚Äî only spun items do */
  });
  let finishedCount=0;
  toSpin.forEach(mc=>{
    const norm=mc.norm,vis=mc.vis;
    const result=rollFromNormalized(norm,guarantee);
    const rr=getRarity(result.percent);
    if(rarOrder.indexOf(rr)>rarOrder.indexOf(highestRarity))highestRarity=rr;
    allResults.push({mc,result,rr});
    const ri=Math.max(0,norm.findIndex(o=>o.name===result.name));
    let tAng=0;for(let i=0;i<ri;i++)tAng+=vis[i];
    const sl=vis[ri]||0.1;
    const finalA=-Math.PI/2-(tAng+(Math.random()*.8+.1)*sl);
    const totalA=finalA+(spins+Math.floor(Math.random()*3))*Math.PI*2;
    mc._spinning=true;mc._spinDone=false;mc._t0=null;
    mc._startA=mc.angle;mc._finalA=finalA;mc._totalA=totalA;
    mc._dur=dur;mc._ri=ri;mc._rr=rr;mc._result=result;
    mc._onDone=()=>{
      finishedCount++;
      if(finishedCount>=toSpin.length){
        applyMultiSpinResults(allResults,highestRarity);
        btn.disabled=false;
        const cb2=document.getElementById('multiSpinCloseBtn');cb2.style.visibility='visible';cb2.style.opacity='1';
      }
    };
  });
}
function applyMultiSpinResults(allResults,highestRarity){
  if(!multiSpinTargetChar)return;
  const char=multiSpinTargetChar;
  allResults.forEach(({mc,result,rr})=>{
    const pEl=char.querySelector('p.skill-item[data-sub="'+mc.sub.name.replace(/"/g,'&quot;')+'"]');
    if(!pEl)return;
    if(pEl.classList.contains('locked'))return;
    Array.from(pEl.childNodes).filter(n=>n.nodeType===3).forEach(n=>n.remove());
    const lockBtn=pEl.querySelector('.skill-lock-btn');
    const textNode=document.createTextNode(mc.sub.name+': '+result.name+' ('+result.percent.toFixed(2)+'%)');
    pEl.insertBefore(textNode,lockBtn||null);
    pEl.dataset.percent=result.percent;pEl.dataset.resultName=result.name;
    const catData=categories.find(c=>c.subcategories.some(s=>s.name===mc.sub.name));
    const subData=catData?catData.subcategories.find(s=>s.name===mc.sub.name):null;
    const optData=subData?subData.options.find(o=>o.name===result.name):null;
    pEl.dataset.desc=optData&&optData.desc?optData.desc:'';
    applyRarityToEl(pEl,result.percent);pEl.classList.remove('empty-slot');
  });
  updateCharDescPanel(char);
  const rarOrder=['comum','incomum','rara','epica','lendaria','mitica','omega','aurora'];
  /* count how many of highest rarity were rolled */
  if(rarOrder.indexOf(highestRarity)>=rarOrder.indexOf('mitica')){
    const highCount=allResults.filter(({rr})=>rr===highestRarity).length;
    const s=RS[highestRarity];
    /* show single reveal with rarity label + count if multiple */
    const revealName=highCount>1?highCount+'√ó '+s.label:s.label;
    setTimeout(()=>{
      if(highestRarity==='aurora')triggerAuroraAnim(revealName);
      else if(highestRarity==='omega')triggerOmegaAnim(revealName);
      else if(highestRarity==='mitica')triggerMiticaAnim(revealName);
    },300);
  }
  showToast('‚úÖ Resultado aplicado a '+char.querySelector('.char-name').innerText+'!');
}
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));
    closeRoulette();closeMultiSpin();closeRarityQPicker();
  }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOSS GENERATOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _bossDiff=null;
const BOSS_DIFF={
  facil: {label:'F√ÅCIL',minRar:'comum',color:'#44ff88',minIdx:0},
  medio: {label:'M√âDIO',minRar:'epica',color:'#ffcc44',minIdx:4},
  dificil:{label:'DIF√çCIL',minRar:'mitica',color:'#ff4422',minIdx:5},
};
const RAR_ORDER=['comum','incomum','rara','epica','lendaria','mitica','omega','aurora'];

function openBossGen(){
  if(!categories.length){flashRed('‚ö† Nenhuma categoria!\nImporte ou crie categorias primeiro.');return;}
  _bossDiff=null;
  document.querySelectorAll('.boss-diff-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('bossGenBtn').disabled=true;
  openModal('bossGenOverlay');
}
function selectBossDiff(diff,el){
  _bossDiff=diff;
  document.querySelectorAll('.boss-diff-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('bossGenBtn').disabled=false;
}
function rollBossOption(norm,minIdx){
  const eligible=norm.filter(o=>RAR_ORDER.indexOf(getRarity(o.percent))>=minIdx);
  /* sem compat√≠vel ‚Üí sorteia qualquer um aleatoriamente */
  const pool=eligible.length?eligible:norm;
  const tot=pool.reduce((s,o)=>s+o.percent,0);
  let r=Math.random()*tot;
  for(const o of pool){if(r<o.percent)return o;r-=o.percent;}
  return pool[pool.length-1];
}
function generateBoss(){
  if(!_bossDiff||!categories.length)return;
  closeModal('bossGenOverlay');
  const diff=BOSS_DIFF[_bossDiff];
  const minIdx=diff.minIdx;
  const char=document.createElement('div');char.className='character';
  char._lockedRarities={};
  const hdr=document.createElement('div');hdr.className='charHeader';
  const nm=document.createElement('span');nm.className='char-name';
  nm.innerText='üíÄ Chef√£o '+diff.label;
  nm.style.color=diff.color;
  nm.onclick=()=>promptModal('Renomear Personagem',nm.innerText,v=>{nm.innerText=v;nm.style.color='';});
  hdr.appendChild(nm);
  [{i:'üìå',t:'Fixar',f:()=>{char.classList.toggle('pinned');savePinned();showToast(char.classList.contains('pinned')?'üìå Fixado.':'Desafixado.');}},{i:'üóë',t:'Deletar',f:()=>{if(!char.classList.contains('pinned'))char.remove();}},{i:'üìã',t:'Copiar',f:()=>copyChar(char)}].forEach(({i,t,f})=>{const s=document.createElement('span');s.className='icon-btn';s.innerText=i;s.title=t;s.onclick=f;hdr.appendChild(s);});
  const badge=document.createElement('span');
  badge.style.cssText='font-size:.65rem;font-weight:700;padding:2px 9px;border-radius:20px;letter-spacing:1px;border:1px solid '+diff.color+';color:'+diff.color+';background:'+diff.color+'18;';
  badge.innerText=diff.label;hdr.appendChild(badge);
  char.appendChild(hdr);
  char.style.cssText='border-color:'+diff.color+'66;box-shadow:0 0 20px '+diff.color+'22,inset 0 0 15px '+diff.color+'0a;';
  const contentWrap=document.createElement('div');contentWrap.className='char-with-desc';
  const skillsCol=document.createElement('div');skillsCol.className='char-skills-col';
  const descPanel=document.createElement('div');descPanel.className='char-desc-panel';
  descPanel.style.display='none';
  contentWrap.appendChild(skillsCol);contentWrap.appendChild(descPanel);
  char.appendChild(contentWrap);
  char._descPanel=descPanel;char._skillsCol=skillsCol;
  for(let i=0;i<categories.length;i++){
    const cat=categories[i];
    const ct=document.createElement('h4');ct.innerText='‚Äî '+cat.name+' ‚Äî';ct.style.marginTop='9px';skillsCol.appendChild(ct);
    for(let j=0;j<cat.subcategories.length;j++){
      const sub=cat.subcategories[j];
      const norm=normalize(sub.options);
      const result=rollBossOption(norm,minIdx);
      const p=document.createElement('p');p.className='skill-item boss-skill';p.dataset.sub=sub.name;p.dataset.catName=cat.name;
      const textNode=document.createTextNode(sub.name+': '+result.name+' ('+result.percent.toFixed(2)+'%)');
      p.appendChild(textNode);
      /* remove o ::after (√≠cone de refresh) */
      p.style.paddingRight='13px';
      p.dataset.percent=result.percent;p.dataset.resultName=result.name;
      const optData=sub.options.find(o=>o.name===result.name);
      p.dataset.desc=optData&&optData.desc?optData.desc:'';
      applyRarityToEl(p,result.percent);p.classList.remove('empty-slot');
      skillsCol.appendChild(p);
    }
  }
  document.getElementById('characters').appendChild(char);
  charCount++;
  updateCharDescPanel(char);
  showToast('üíÄ Chef√£o '+diff.label+' gerado!',2500);
}

loadAutoSave();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN TAB SWITCHER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchMainTab(id, el) {
  document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  el.classList.add('active');
  if (id === 'batalha') refreshBattleApiKeyStatus();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RARITY QUICK-PICKER
   Click on the rarity badge of a skill item ‚Üí dropdown with
   all options from that subcategory, grouped by rarity
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var _qpCloseHandler = null; // kept for safety

function openRarityQPicker(e, pEl, subRef, char) {
  e.stopPropagation();
  var qp = document.getElementById('rarityQPicker');
  var ov = document.getElementById('rarityQPickerOverlay');

  // Toggle if already open for same element
  if (qp._targetEl === pEl && ov.classList.contains('open')) {
    closeRarityQPicker(); return;
  }
  closeRarityQPicker();

  if (!subRef.options || !subRef.options.length) {
    showToast('‚ö† Nenhuma op√ß√£o nesta subcategoria.'); return;
  }

  qp._targetEl = pEl;
  var norm = normalize(subRef.options);

  // Group by rarity
  var rarOrder = ['aurora','omega','mitica','lendaria','epica','rara','incomum','comum'];
  var groups = {};
  norm.forEach(function(opt) {
    var r = getRarity(opt.percent);
    if (!groups[r]) groups[r] = [];
    groups[r].push(opt);
  });

  // Build HTML
  var html = '<div class="rarity-qpicker-title">‚ú¶ ' + subRef.name + '</div>';
  rarOrder.forEach(function(r) {
    if (!groups[r]) return;
    var s = RS[r];
    html += '<div class="rarity-qpicker-group">';
    html += '<span class="rarity-qpicker-group-label" style="background:' + s.fill + ';color:' + s.tc + ';border-color:' + s.border + ';">' + s.label + '</span>';
    groups[r].forEach(function(opt) {
      var desc = opt.desc ? ' <span style="opacity:.5;font-size:.72rem;">‚Äî '+opt.desc+'</span>' : '';
      html += '<div class="rarity-qpicker-item" style="background:' + s.bg + ';border-color:' + s.border + '55;color:' + s.tc + ';" data-opt-name="' + opt.name.replace(/"/g,'&quot;') + '" data-opt-pct="' + opt.percent + '">'
        + '<span>' + opt.name + desc + '</span>'
        + '<span class="qp-pct">' + opt.percent.toFixed(2) + '%</span>'
        + '</div>';
    });
    html += '</div>';
  });
  html += '<button class="rarity-qpicker-close">‚úï Fechar</button>';
  qp.innerHTML = html;

  // Attach click handlers to items
  qp.querySelectorAll('.rarity-qpicker-item').forEach(function(item) {
    item.addEventListener('click', function() {
      var optName = item.dataset.optName;
      var optPct  = parseFloat(item.dataset.optPct);
      var found = norm.find(function(o) { return o.name === optName; });
      if (!found) return;
      found.percent = optPct;

      // Apply to skill item
      Array.from(pEl.childNodes).filter(function(n){return n.nodeType===3;}).forEach(function(n){n.remove();});
      var lockBtn = pEl.querySelector('.skill-lock-btn');
      var clearBtn = pEl.querySelector('.skill-clear-btn');
      var textNode = document.createTextNode(subRef.name + ': ' + found.name + ' (' + found.percent.toFixed(2) + '%)');
      pEl.insertBefore(textNode, clearBtn || lockBtn || null);
      pEl.dataset.percent = found.percent;
      pEl.dataset.resultName = found.name;
      var origOpt = subRef.options.find(function(o){return o.name===found.name;});
      pEl.dataset.desc = origOpt && origOpt.desc ? origOpt.desc : '';
      applyRarityToEl(pEl, found.percent);
      pEl.classList.remove('empty-slot');
      updateCharDescPanel(char);
      if (char.classList.contains('pinned')) savePinned();

      var r2 = getRarity(found.percent);
      if (r2==='aurora') triggerAuroraAnim(found.name);
      else if (r2==='omega') triggerOmegaAnim(found.name);
      else if (r2==='mitica') triggerMiticaAnim(found.name);

      closeRarityQPicker();
    });
  });

  qp.querySelector('.rarity-qpicker-close').addEventListener('click', closeRarityQPicker);

  // Open overlay
  ov.classList.add('open');
}

function closeRarityQPicker() {
  var ov = document.getElementById('rarityQPickerOverlay');
  var qp = document.getElementById('rarityQPicker');
  if (ov) ov.classList.remove('open');
  if (qp) qp._targetEl = null;
}

/* Add rarity badge to a skill-item pEl */
function addRarityBadge(pEl, subRef, char) {
  var old = pEl.querySelector('.skill-rarity-badge');
  if (old) old.remove();

  var badge = document.createElement('span');
  badge.className = 'skill-rarity-badge';
  badge.textContent = '+';
  badge.title = 'Escolher raridade de ' + subRef.name;
  badge.addEventListener('click', function(e) {
    if (char.classList.contains('pinned')) { showToast('üìå Personagem fixado ‚Äî desafixe para editar.'); return; }
    openRarityQPicker(e, pEl, subRef, char);
  });
  pEl.appendChild(badge);
  return badge;
}

/* Badge is now always '+', nothing to update */
function updateRarityBadge(pEl) {}


var _ttsEngine = 'web'; // 'web' | 'eleven' | 'off'
var _ttsSentenceBuffer = '';
var _ttsQueue = [];
var _ttsSpeaking = false;
var _ttsSynth = window.speechSynthesis || null;
var _ttsVoices = [];

// Load voices (async on some browsers)
function _loadVoices() {
  if (!_ttsSynth) return;
  _ttsVoices = _ttsSynth.getVoices();
  var sel = document.getElementById('ttsVoiceSelect');
  if (!sel) return;
  sel.innerHTML = '';
  var ptVoices = _ttsVoices.filter(function(v){ return v.lang.indexOf('pt') !== -1; });
  var others   = _ttsVoices.filter(function(v){ return v.lang.indexOf('pt') === -1; });
  var groups = [{label:'Portugu√™s', voices:ptVoices},{label:'Outros', voices:others}];
  groups.forEach(function(g){
    if (!g.voices.length) return;
    var og = document.createElement('optgroup');
    og.label = g.label;
    g.voices.forEach(function(v){
      var o = document.createElement('option');
      o.value = v.name;
      o.textContent = v.name + ' (' + v.lang + ')';
      if (v.lang === 'pt-BR') o.selected = true;
      og.appendChild(o);
    });
    sel.appendChild(og);
  });
}
if (_ttsSynth) {
  _ttsSynth.onvoiceschanged = _loadVoices;
  _loadVoices();
}

function setTtsEngine(engine) {
  _ttsEngine = engine;
  // Stop any ongoing speech
  if (_ttsSynth) _ttsSynth.cancel();
  _ttsQueue = []; _ttsSpeaking = false; _ttsSentenceBuffer = '';
  // Update buttons
  ['web','eleven','off'].forEach(function(e){
    var btn = document.getElementById('ttsEngine' + e.charAt(0).toUpperCase() + e.slice(1));
    if (btn) btn.classList.toggle('active', e === engine);
  });
  document.getElementById('ttsWebOptions').style.display    = engine === 'web'    ? 'block' : 'none';
  document.getElementById('ttsElevenOptions').style.display = engine === 'eleven' ? 'block' : 'none';
}

function saveElevenKey() {
  var val = document.getElementById('elevenApiKey').value.trim();
  if (!val) { showToast('‚ö† Chave vazia!'); return; }
  localStorage.setItem('gs-eleven-key', val);
  var st = document.getElementById('elevenKeyStatus');
  if (st) { st.textContent = '‚úÖ Salva'; st.style.color = '#44cc88'; }
  showToast('üéô Chave ElevenLabs salva!');
}

// Load saved ElevenLabs key on init
(function(){
  var k = localStorage.getItem('gs-eleven-key');
  var inp = document.getElementById('elevenApiKey');
  var st  = document.getElementById('elevenKeyStatus');
  if (k && inp) {
    inp.value = k;
    if (st) { st.textContent = '‚úÖ Salva'; st.style.color = '#44cc88'; }
  }
})();

// ‚îÄ‚îÄ Web Speech: speak a sentence ‚îÄ‚îÄ
function _webSpeak(text) {
  if (!_ttsSynth || !text.trim()) return;
  var utt = new SpeechSynthesisUtterance(text.trim());
  // Pick voice
  var sel = document.getElementById('ttsVoiceSelect');
  if (sel && sel.value) {
    var v = _ttsVoices.find(function(x){ return x.name === sel.value; });
    if (v) utt.voice = v;
  }
  utt.lang  = 'pt-BR';
  utt.rate  = parseFloat(document.getElementById('ttsRate').value  || 0.95);
  utt.pitch = parseFloat(document.getElementById('ttsPitch').value || 0.88);
  utt.volume = 1;
  _ttsSynth.speak(utt);
}

// Called by typewriter for each character added ‚Äî buffers until sentence end
function ttsTypeChar(ch) {
  if (_ttsEngine !== 'web') return;
  _ttsSentenceBuffer += ch;
  // Speak on sentence boundary: . ! ? followed by space or newline
  if ((ch === '.' || ch === '!' || ch === '?') && _ttsSentenceBuffer.trim().length > 8) {
    _webSpeak(_ttsSentenceBuffer);
    _ttsSentenceBuffer = '';
  }
}

// Flush any remaining buffer (end of battle)
function ttsFlushBuffer() {
  if (_ttsEngine === 'web' && _ttsSentenceBuffer.trim()) {
    _webSpeak(_ttsSentenceBuffer);
    _ttsSentenceBuffer = '';
  }
}

// Stop TTS (called on stopBattle)
function ttsStop() {
  if (_ttsSynth) _ttsSynth.cancel();
  _ttsQueue = []; _ttsSpeaking = false; _ttsSentenceBuffer = '';
  elevenStopAll(); _elevenSentenceBuffer = '';
}

// ‚îÄ‚îÄ ElevenLabs: fila de senten√ßas ‚Äî narra junto com o typewriter ‚îÄ‚îÄ
var _elevenQueue = [];
var _elevenBusy = false;

async function _elevenPlayNext() {
  if (_elevenBusy || !_elevenQueue.length) return;
  _elevenBusy = true;
  var text = _elevenQueue.shift();
  var key     = localStorage.getItem('gs-eleven-key');
  var voiceId = (document.getElementById('elevenVoiceId').value.trim()) || '21m00Tcm4TlvDq8ikWAM';
  if (!key) { _elevenBusy = false; _elevenPlayNext(); return; }
  try {
    var resp = await fetch('https://api.elevenlabs.io/v1/text-to-speech/' + voiceId + '/stream', {
      method:'POST',
      headers:{'Content-Type':'application/json','xi-api-key': key},
      body: JSON.stringify({
        text: text,
        model_id: 'eleven_monolingual_v1',
        voice_settings: { stability:0.45, similarity_boost:0.78, style:0.35, use_speaker_boost:true }
      })
    });
    if (!resp.ok) {
      var errBody = await resp.json().catch(function(){return {};});
      var msg = (errBody.detail && errBody.detail.message) || ('Erro ' + resp.status);
      showToast('‚ùå ElevenLabs: ' + msg);
      _elevenBusy = false; _elevenPlayNext(); return;
    }
    var blob = await resp.blob();
    var url  = URL.createObjectURL(blob);
    var audio = new Audio(url);
    audio.onended = function(){ URL.revokeObjectURL(url); _elevenBusy = false; _elevenPlayNext(); };
    audio.onerror = function(){ URL.revokeObjectURL(url); _elevenBusy = false; _elevenPlayNext(); };
    await audio.play();
  } catch(e) {
    showToast('‚ùå ElevenLabs: ' + e.message);
    _elevenBusy = false; _elevenPlayNext();
  }
}

function elevenQueueSentence(text) {
  if (!text.trim()) return;
  _elevenQueue.push(text.trim());
  _elevenPlayNext();
}

function elevenStopAll() {
  _elevenQueue = [];
  _elevenBusy = false;
}

// Called per character during typewriter ‚Äî buffers until sentence boundary
var _elevenSentenceBuffer = '';
function elevenTypeChar(ch) {
  if (_ttsEngine !== 'eleven') return;
  // Strip markup chars from TTS
  _elevenSentenceBuffer += ch;
  if ((ch === '.' || ch === '!' || ch === '?') && _elevenSentenceBuffer.trim().length > 8) {
    var clean = _elevenSentenceBuffer
      .replace(/@@([^@]+)@@/g,'$1').replace(/##([^#]+)##/g,'$1')
      .replace(/\^\^([^^]+)\^\^/g,'$1').replace(/~~([^~]+)~~/g,'$1')
      .replace(/\*\*([^*]+)\*\*/g,'$1').replace(/\*([^*]+)\*/g,'$1').trim();
    if (clean) elevenQueueSentence(clean);
    _elevenSentenceBuffer = '';
  }
}

function elevenFlushBuffer() {
  if (_ttsEngine !== 'eleven') return;
  var clean = _elevenSentenceBuffer
    .replace(/@@([^@]+)@@/g,'$1').replace(/##([^#]+)##/g,'$1')
    .replace(/\^\^([^^]+)\^\^/g,'$1').replace(/~~([^~]+)~~/g,'$1')
    .replace(/\*\*([^*]+)\*\*/g,'$1').replace(/\*([^*]+)\*/g,'$1').trim();
  if (clean) elevenQueueSentence(clean);
  _elevenSentenceBuffer = '';
}

// ‚îÄ‚îÄ ElevenLabs legacy full-text call (kept but no longer used for battle) ‚îÄ‚îÄ
async function elevenLabsNarrate(fullText) {
  // Now handled sentence-by-sentence via elevenTypeChar ‚Äî this is a no-op
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BATTLE SYSTEM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let battleTeamA = [];
let battleTeamB = [];
let _charPickerTarget = null;

const BATTLE_API_KEY = 'gs-battle-api-key';

function saveBattleApiKey() {
  const val = document.getElementById('battleApiKey').value.trim();
  if (!val) { showToast('‚ö† Chave vazia!'); return; }
  localStorage.setItem(BATTLE_API_KEY, val);
  refreshBattleApiKeyStatus();
  showToast('üîë Chave salva com sucesso!');
}

function refreshBattleApiKeyStatus() {
  const k = localStorage.getItem(BATTLE_API_KEY);
  const inp = document.getElementById('battleApiKey');
  const status = document.getElementById('apiKeyStatus');
  if (k) {
    inp.value = k;
    status.textContent = '‚úÖ Chave configurada';
    status.style.color = '#44cc88';
  } else {
    status.textContent = '‚ö† Nenhuma chave';
    status.style.color = '#ff8844';
  }
}

/* Extract character data from a .character DOM element */
function extractCharData(charEl) {
  const name = charEl.querySelector('.char-name')?.innerText || 'Personagem';
  const skills = [];
  charEl.querySelectorAll('p.skill-item').forEach(p => {
    const percent = parseFloat(p.dataset.percent) || 0;
    if (!percent) return;
    skills.push({
      sub: p.dataset.sub || '',
      name: p.dataset.resultName || '',
      percent,
      rarity: getRarity(percent),
      rarityLabel: RS[getRarity(percent)]?.label || '',
      desc: p.dataset.desc || ''
    });
  });
  return { name, skills };
}

/* Build the list of all generated characters */
function getAllChars() {
  return Array.from(document.querySelectorAll('#characters .character'));
}

/* Render team slots */
function renderBattleTeams() {
  renderTeamSlots('A', battleTeamA, 'teamASlots', 'addTeamABtn');
  renderTeamSlots('B', battleTeamB, 'teamBSlots', 'addTeamBBtn');
  const canFight = battleTeamA.length > 0 && battleTeamB.length > 0;
  document.getElementById('battleStartBtn').disabled = !canFight;
}

function renderTeamSlots(team, arr, slotsId, addBtnId) {
  var container = document.getElementById(slotsId);
  container.innerHTML = '';
  arr.forEach(function(charData, idx) {
    var slot = document.createElement('div');
    slot.className = 'battle-slot filled';
    var rarCounts = {};
    charData.skills.forEach(function(s){ rarCounts[s.rarity] = (rarCounts[s.rarity]||0)+1; });
    var topRar = ['aurora','omega','mitica','lendaria','epica','rara','incomum','comum'].find(function(r){ return rarCounts[r]; });
    var color = topRar ? RS[topRar].border : 'var(--border)';
    slot.style.borderColor = color;
    slot.style.background = topRar ? RS[topRar].fill : '';

    // Rarity dots row
    var rarDots = ['aurora','omega','mitica','lendaria','epica','rara','incomum','comum']
      .filter(function(r){ return rarCounts[r]; })
      .map(function(r){ return '<span title="'+RS[r].label+' √ó'+rarCounts[r]+'" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:'+RS[r].border+';margin:0 1px;" ></span>'; })
      .join('');

    // Skills mini list (show all on hover via title)
    var skillTitles = charData.skills.map(function(s){ return s.sub+': '+s.name+' ('+s.rarityLabel+')'; }).join('\n');

    slot.title = charData.name + '\n\n' + skillTitles;
    slot.innerHTML = '<span style="font-size:1rem;">'+(team==='A'?'üîµ':'üî¥')+'</span>'
      + '<div style="flex:1;min-width:0;">'
      +   '<div class="battle-slot-name" style="color:'+color+';">'+charData.name+'</div>'
      +   '<div style="margin-top:3px;">'+rarDots+'</div>'
      + '</div>'
      + '<span style="font-size:.68rem;color:var(--text3);align-self:flex-start;margin-top:2px;">'+charData.skills.length+' hab.</span>'
      + '<span class="battle-slot-remove" onclick="removeFromTeam(\''+team+'\','+idx+')" title="Remover">‚úï</span>';
    container.appendChild(slot);
  });
  var addBtn = document.getElementById(addBtnId);
  addBtn.disabled = arr.length >= 5;
}

function removeFromTeam(team, idx) {
  if (team === 'A') battleTeamA.splice(idx, 1);
  else battleTeamB.splice(idx, 1);
  renderBattleTeams();
}

/* Open char picker */
function openCharPicker(team) {
  _charPickerTarget = team;
  const chars = getAllChars();
  const list = document.getElementById('charPickerList');
  list.innerHTML = '';
  if (!chars.length) {
    list.innerHTML = '<p style="color:var(--text3);font-size:.84rem;text-align:center;padding:20px;">Nenhum personagem gerado ainda.<br>V√° para a aba Gerador e crie personagens primeiro.</p>';
  } else {
    chars.forEach(charEl => {
      const data = extractCharData(charEl);
      const inA = battleTeamA.some(c => c._el === charEl);
      const inB = battleTeamB.some(c => c._el === charEl);
      if ((team === 'A' && inA) || (team === 'B' && inB)) return;
      const item = document.createElement('div');
      item.className = 'char-picker-item';
      const skillPreview = data.skills.slice(0, 3).map(s => `${s.sub}: ${s.name} (${s.rarityLabel})`).join(' ¬∑ ');
      item.innerHTML = `<div class="cpi-name">${data.name}</div><div class="cpi-skills">${skillPreview}${data.skills.length > 3 ? ' ...' : ''}</div>`;
      item.onclick = () => {
        data._el = charEl;
        if (_charPickerTarget === 'A') battleTeamA.push(data);
        else battleTeamB.push(data);
        closeModal('charPickerOverlay');
        renderBattleTeams();
      };
      list.appendChild(item);
    });
    if (!list.children.length) {
      list.innerHTML = '<p style="color:var(--text3);font-size:.84rem;text-align:center;padding:20px;">Todos os personagens j√° foram adicionados ao time.</p>';
    }
  }
  openModal('charPickerOverlay');
}

function setScenario(btn) {
  document.getElementById('battleScenario').value = btn.innerText;
}

/* Build prompt for AI */
function buildBattlePrompt(teamA, teamB) {
  const rarPower = {aurora:1000,omega:600,mitica:350,lendaria:200,epica:120,rara:70,incomum:40,comum:20};

  // Deep skill interpreter: extracts unique combat mechanics from name+desc
  function interpretSkill(sub, name, desc, rarityLabel) {
    const nm = name.toLowerCase();
    const ds = (desc||'').toLowerCase();
    const combined = nm + ' ' + ds;

    // Derive unique visual + mechanical identity
    // Sub-category context clues
    const subCtx = sub.toLowerCase();

    let interpretation = `"${name}"`;
    if (desc) interpretation += ` (${desc})`;
    interpretation += ` [${rarityLabel}]`;

    // Add mechanical analysis hint so AI doesn't over-simplify
    const hints = [];

    // Movement/mobility ‚Äî only if genuinely about movement
    if (/teleport|warp|blink|fase|dimens√£o|espa√ßo|portal|void|instant|dimension/i.test(combined))
      hints.push('mobilidade dimensional ‚Äî ignora obst√°culos f√≠sicos, reposicionamento instant√¢neo');
    else if (/veloc|speed|rapid|flash|quick|ligeiro|s√∫bito|rel√¢mpag/i.test(combined))
      hints.push('velocidade f√≠sica superior ‚Äî reage mais r√°pido, golpes em s√©rie antes que o alvo responda');

    // Elemental
    if (/fogo|chama|flama|inferno|burn|ignit|pyro|calor|brasa|ember|blazing/i.test(combined))
      hints.push('elemento fogo ‚Äî chamas reais, queimaduras persistentes, √°rea de efeito expansiva');
    if (/gelo|ice|frost|congel|cryo|freeze|glacial|tundra|blizzard/i.test(combined))
      hints.push('elemento gelo ‚Äî imobiliza√ß√£o, redu√ß√£o de mobilidade do alvo, superf√≠cies escorregadias');
    if (/rel√¢mpago|raio|trov√£o|thunder|lightning|volt|el√©tric|storm|tempest/i.test(combined))
      hints.push('elemento el√©trico ‚Äî paralisia moment√¢nea, condu√ß√£o em superf√≠cies met√°licas/√∫midas');
    if (/terra|pedra|rocha|boulder|geo|granite|tect√¥nic|quake|earth/i.test(combined))
      hints.push('elemento terra ‚Äî impactos s√≠smicos, armadilhas no solo, escudos de pedra');
    if (/veneno|poison|toxic|acido|acid|corros|plague|miasma/i.test(combined))
      hints.push('veneno/√°cido ‚Äî dano cont√≠nuo ao longo do tempo, enfraquece o advers√°rio progressivamente');
    if (/sombra|shadow|dark|trevas|noite|umbra|void|abismo|obscur/i.test(combined))
      hints.push('poder sombrio ‚Äî manipula percep√ß√£o, ataques de √¢ngulos inesperados, drenar energia');
    if (/luz|light|holy|sagrado|divino|solar|radiante|celestial/i.test(combined))
      hints.push('energia divina/luz ‚Äî purifica√ß√£o, escudos luminosos, cegante');
    if (/sangue|blood|crimson|hemor|plasma|scarlet/i.test(combined))
      hints.push('manipula√ß√£o sangu√≠nea ‚Äî controla fluxo vital do advers√°rio, cura pr√≥pria a partir de dano');

    // Combat style
    if (/espada|sword|l√¢mina|blade|katana|sabre|slash|corte/i.test(combined))
      hints.push('combate com l√¢mina ‚Äî precis√£o cir√∫rgica, cortes que ignoram armadura');
    if (/punho|soco|berserk|berserker|rage|f√∫ria|frenesi|brutal|smash/i.test(combined))
      hints.push('combate corpo a corpo brutal ‚Äî impactos que fragmentam ossos, for√ßa bruta avassaladora');
    if (/escudo|shield|barrier|barreira|protect|aegis|ward|defend/i.test(combined))
      hints.push('defesa ativa ‚Äî bloqueia e reflete ataques, cria zonas de prote√ß√£o');
    if (/cura|heal|regenera|recover|restore|restore|vida|life/i.test(combined))
      hints.push('regenera√ß√£o ‚Äî recupera ferimentos em combate, dif√≠cil de derrotar por atrito');
    if (/clone|c√≥pia|copy|duplic|mirror|shadow clone|doppel/i.test(combined))
      hints.push('cria√ß√£o de c√≥pias ‚Äî confunde o advers√°rio, ataques simult√¢neos de m√∫ltiplas dire√ß√µes');
    if (/mente|mind|psych|psiqu|telep|ilus√£o|illus|hipnos|confus/i.test(combined))
      hints.push('poder mental ‚Äî manipula percep√ß√µes e decis√µes do advers√°rio, cria ilus√µes t√°ticas');
    if (/tempo|time|slow|para|stop|chrono|temporal|reverso/i.test(combined))
      hints.push('manipula√ß√£o temporal ‚Äî desacelera ou para o advers√°rio brevemente, reverte dano sofrido');
    if (/grav|peso|weight|pull|push|float|levit|orbit/i.test(combined))
      hints.push('gravita√ß√£o ‚Äî altera peso e trajet√≥ria, pode esmagar ou lan√ßar o advers√°rio');
    if (/invoc|summon|invocar|convocar|familiar|beast|criatura|monstro/i.test(combined))
      hints.push('invoca√ß√£o ‚Äî traz aliados para o campo, divide a aten√ß√£o do advers√°rio');

    // If no hints found, use category context
    if (hints.length === 0) {
      hints.push(`habilidade √∫nica de "${sub}" ‚Äî o narrador deve criar uma mec√¢nica visual e t√°tica original baseada exatamente no nome`);
    }

    return `${interpretation}\n    ‚Üí MEC√ÇNICA: ${hints.join(' + ')}`;
  }

  function teamSummary(team, teamLabel) {
    return `== ${teamLabel} ==\n` + team.map((c, i) => {
      const skills = c.skills.map(s =>
        `  - ${s.sub}:\n    ${interpretSkill(s.sub, s.name, s.desc, s.rarityLabel)}`
      ).join('\n');
      return `Personagem ${i+1}: ${c.name}\nHabilidades:\n${skills}`;
    }).join('\n\n');
  }

  function teamPower(team) {
    return team.reduce((sum, c) => sum + c.skills.reduce((s2, sk) => s2 + (rarPower[sk.rarity] || 20), 0), 0);
  }
  const pwrA = teamPower(teamA);
  const pwrB = teamPower(teamB);
  const totalPwr = pwrA + pwrB;
  const balance = Math.abs(pwrA - pwrB) / (totalPwr || 1);

  const minParas = totalPwr > 3000 ? 20 : totalPwr > 1500 ? 15 : 12;
  const hasAurora = [...teamA, ...teamB].some(c => c.skills.some(s => s.rarity === 'aurora'));
  const hasOmega  = [...teamA, ...teamB].some(c => c.skills.some(s => s.rarity === 'omega'));
  const lengthNote = hasAurora
    ? `BATALHA √âPICA SUPREMA: Com habilidades AURORA presentes, esta batalha deve ter NO M√çNIMO ${minParas} par√°grafos longos e cinematogr√°ficos. Cada t√©cnica Aurora deve ter sua pr√≥pria cena de impacto devastador.`
    : hasOmega
    ? `BATALHA √âPICA: Com habilidades OMEGA presentes, esta batalha deve ter NO M√çNIMO ${minParas} par√°grafos detalhados e dram√°ticos.`
    : `Esta batalha deve ter NO M√çNIMO ${minParas} par√°grafos ricos e cinematogr√°ficos.`;

  // Weighted outcome pool ‚Äî vit√≥ria normal √© muito mais comum
  // balance < 0.1 = equilibrado, balance > 0.4 = esmagamento
  const roll = Math.random();
  let chosenOutcome;
  if (balance > 0.5) {
    // Grande desequil√≠brio ‚Üí quase sempre vit√≥ria normal, raramente Brutality
    if (roll < 0.70)      chosenOutcome = 'vitoria';
    else if (roll < 0.88) chosenOutcome = 'brutality';
    else if (roll < 0.94) chosenOutcome = 'fatality';
    else                  chosenOutcome = 'vitoria'; // sem empate em esmagamento
  } else if (balance < 0.1) {
    // Muito equilibrado ‚Üí pode ser empate ou finaliza√ß√µes especiais
    if (roll < 0.45)      chosenOutcome = 'vitoria';
    else if (roll < 0.62) chosenOutcome = 'empate';
    else if (roll < 0.72) chosenOutcome = 'empate_desgaste';
    else if (roll < 0.82) chosenOutcome = 'piedade';
    else if (roll < 0.89) chosenOutcome = 'piedade_traicao';
    else if (roll < 0.94) chosenOutcome = 'fatality';
    else                  chosenOutcome = 'brutality';
  } else {
    // Desequil√≠brio moderado ‚Üí vit√≥ria na maioria, raramente especiais
    if (roll < 0.60)      chosenOutcome = 'vitoria';
    else if (roll < 0.74) chosenOutcome = 'piedade';
    else if (roll < 0.82) chosenOutcome = 'piedade_traicao';
    else if (roll < 0.89) chosenOutcome = 'brutality';
    else if (roll < 0.94) chosenOutcome = 'fatality';
    else                  chosenOutcome = 'empate';
  }

  const outcomeInstructions = {
    vitoria:
      `DESFECHO: VIT√ìRIA NORMAL. O vencedor derrota o advers√°rio numa batalha √©pica. Pode haver um golpe final dram√°tico, mas sem crueldade excessiva. Use [FINALIZACAO:vitoria-NomeVencedor] antes do ===RESULTADO===.`,
    empate:
      `DESFECHO: EMPATE DRAM√ÅTICO. Ambos os lados chegam ao limite ao mesmo tempo ‚Äî um √∫ltimo ataque simult√¢neo, uma explos√£o m√∫tua, ou simplesmente ambos caem exaustos. Ningu√©m vence. Use [FINALIZACAO:empate-Empate] antes do ===RESULTADO===.`,
    empate_desgaste:
      `DESFECHO: EMPATE POR DESGASTE. A batalha foi t√£o longa e brutal que ambos os lados ficaram sem for√ßas. Nenhum consegue mais se mover. Eles se encaram em sil√™ncio, reconhecendo o poder um do outro. Use [FINALIZACAO:empate-Empate] antes do ===RESULTADO===.`,
    piedade:
      `DESFECHO: PIEDADE. O vencedor tem o advers√°rio √† sua merc√™ ‚Äî poderia matar, mas ESCOLHE n√£o faz√™-lo. Ele abaixa a guarda, talvez diga algo significativo, e poupa o derrotado. Um momento de humanidade no caos. Use [FINALIZACAO:piedade-NomeVencedor] antes do ===RESULTADO===.`,
    piedade_traicao:
      `DESFECHO: PIEDADE COM TRAI√á√ÉO. O vencedor oferece miseric√≥rdia e se aproxima ‚Äî e nesse momento de distra√ß√£o, o "derrotado" ataca pelas costas com seu √∫ltimo f√¥lego! Uma trai√ß√£o brutal. O vencedor original sofre dano extra mas ainda prevalece (ou a batalha vira). Use [FINALIZACAO:piedade_traicao-NomeVencedorFinal] antes do ===RESULTADO===.`,
    fatality:
      `DESFECHO: FATALITY. O vencedor desfere um golpe final absolutamente devastador que elimina o advers√°rio de forma espetacular e definitiva. O ambiente ao redor √© destru√≠do pelo impacto. Uma execu√ß√£o √©pica digna de lendas. Use [FINALIZACAO:fatality-NomeVencedor] antes do ===RESULTADO===.`,
    brutality:
      `DESFECHO: BRUTALITY. O vencedor n√£o d√° chance ao advers√°rio ‚Äî uma sequ√™ncia implac√°vel de golpes, cada um mais brutal que o anterior, sem pausa, sem miseric√≥rdia, terminando num golpe final avassalador. Pura domin√¢ncia. Use [FINALIZACAO:brutality-NomeVencedor] antes do ===RESULTADO===.`,
  };

  const isTeam = teamA.length > 1 || teamB.length > 1;
  const scenario = document.getElementById('battleScenario').value.trim();
  const scenarioLine = scenario
    ? `CEN√ÅRIO: ${scenario}\nO cen√°rio influencia ativamente ‚Äî habilidades compat√≠veis com o ambiente t√™m vantagem. Descreva o ambiente vividamente.\n\n`
    : '';

  return `Voc√™ √© o narrador √©pico de batalhas de anime/mang√° de n√≠vel SUPREMO. Narre uma batalha cinematogr√°fica entre dois ${isTeam ? 'times' : 'personagens'}.

${scenarioLine}${lengthNote}

PODER CALCULADO ‚Äî Time A: ${pwrA} | Time B: ${pwrB} (use isso para calibrar quem leva vantagem em cada fase da luta)

${outcomeInstructions[chosenOutcome]}

REGRA CR√çTICA DE KO: Quando um personagem cai (HP zero), ele est√° ELIMINADO. N√£o pode mais atacar, defender, ser curado ou ter qualquer a√ß√£o. A luta continua apenas entre os personagens ainda de p√©. S√≥ finalize a batalha quando um time inteiro for eliminado (ou o desfecho determinado acima ocorrer).

REGRAS DA BATALHA:
1. CADA HABILIDADE √â √öNICA ‚Äî N√ÉO GENERALIZE. Se a habilidade se chama "Chama Negra", n√£o √© s√≥ fogo gen√©rico ‚Äî √© fogo corrompido que queima a alma, n√£o o corpo. Se se chama "Eco do Vazio", n√£o √© teleporte ‚Äî √© resson√¢ncia com o nada que distorce o espa√ßo ao redor. Trate cada nome como uma identidade √∫nica e invente a mec√¢nica espec√≠fica dessa t√©cnica.
2. Raridade = poder base: Aurora > Omega > M√≠tica > Lend√°ria > √âpica > Rara > Incomum > Comum. Habilidades mais raras devem ter efeitos VISIVELMENTE mais devastadores.
3. ESTRUTURA OBRIGAT√ìRIA em ${minParas}+ par√°grafos:
   - Abertura: descreva o cen√°rio e os combatentes se encarando
   - Fase 1 (explora√ß√£o): trocas iniciais, personagens testando limites
   - Fase 2 (escalada): habilidades mais poderosas, ambiente sendo destru√≠do
   - Fase 3 (cl√≠max): t√©cnicas definitivas, momento de virada dram√°tica
   - Fase 4 (resolu√ß√£o): desfecho emocional ‚Äî execute o desfecho determinado acima
4. Cada par√°grafo deve ter 4-6 frases ricas. N√ÉO encurte.
5. Use o NOME EXATO das t√©cnicas dentro de @@@@, ex: @@Chama Negra@@
6. Descreva o efeito visual √öNICO de cada t√©cnica ‚Äî cheiros, sons, sensa√ß√µes, como o ambiente reage
7. EMO√á√ïES E VOZ ‚Äî USE IT√ÅLICO E NEGRITO PARA DEMONSTRAR EMO√á√ÉO:
   - **palavras em negrito** = √™nfase intensa, grito, impacto, declara√ß√£o √©pica (a voz deve soar forte)
   - *palavras em it√°lico* = sussurro, pensamento interno, dor, hesita√ß√£o, ironia (a voz deve soar suave/emotiva)
   - Exemplos: "**NUNCA!**" ‚Äî "*ele sabia que era o fim*" ‚Äî "**Isso √© tudo que voc√™ tem?**" ‚Äî "*um fio de sangue escorreu pelo canto dos l√°bios*"
   - Use negrito/it√°lico pelo menos 3x por par√°grafo para dar ritmo e emo√ß√£o √† narra√ß√£o
8. PROFUNDIDADE PSICOL√ìGICA: explore o estado mental dos personagens ‚Äî medos, determina√ß√£o, mem√≥rias que surgem no calor da batalha. Deixe o leitor sentir a dor, o cansa√ßo, a adrenalina.
9. AMBIENTE REATIVO: o cen√°rio deve mudar e reagir √† batalha ‚Äî paredes racham, o ar vibra, o ch√£o afunda, animais fogem, o c√©u muda de cor com poderes absurdos.

${teamSummary(teamA, 'TIME A')}

${teamSummary(teamB, 'TIME B')}`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HP BAR SYSTEM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let hpState = {};
let battleAbortController = null;
let battleRunning = false;
let totalDamageA = 0;
let totalDamageB = 0;
let lastHitId = null; // tracks last bar that took damage, for visual effects

const rarW = {aurora:1000,omega:600,mitica:350,lendaria:200,epica:120,rara:70,incomum:40,comum:20};

function calcMaxHp(charData) {
  let base = 1000;
  charData.skills.forEach(s => { base += rarW[s.rarity] || 20; });
  return Math.round(base / 100) * 100;
}

function initHpBars(teamA, teamB) {
  hpState = {};
  totalDamageA = 0;
  totalDamageB = 0;
  lastHitId = null;
  _pendingSpecial = 'normal';
  const rowA = document.getElementById('hpRowA');
  const rowB = document.getElementById('hpRowB');
  rowA.innerHTML = '';
  rowB.innerHTML = '';

  function addBar(char, team, row, idx) {
    const maxHp = calcMaxHp(char);
    const id = team + idx;
    const barColor = team === 'A'
      ? 'linear-gradient(90deg,#1a44bb,#5588ff,#88aaff)'
      : 'linear-gradient(90deg,#aa1100,#ff4422,#ff7755)';
    const barGlow  = team === 'A' ? '#5588ff88' : '#ff442288';
    const wrap = document.createElement('div');
    wrap.className = 'hp-char-wrap ' + (team === 'A' ? 'team-a-wrap' : 'team-b-wrap');
    wrap.id = 'hpWrap_' + id;
    wrap.style.width = '100%';
    // For team A: name right-aligned, bar fills left-to-right from right side
    // For team B: name left-aligned, bar fills left-to-right normally
    wrap.innerHTML =
      '<div class="hp-char-name" id="hpName_' + id + '">' + char.name + '</div>' +
      '<div style="position:relative;">' +
        '<div class="hp-bar-track" id="hpTrack_' + id + '" style="' + (team==='A'?'direction:rtl;':'') + '">' +
          '<div id="hpFill_' + id + '" style="height:100%;width:100%;border-radius:6px;background:' + barColor + ';box-shadow:0 0 10px ' + barGlow + ';transition:width .5s cubic-bezier(.4,0,.2,1);"></div>' +
        '</div>' +
        '<span id="hpDmgFloat_' + id + '" style="display:none;"></span>' +
      '</div>' +
      '<div class="hp-val" id="hpVal_' + id + '">' + maxHp.toLocaleString() + ' HP</div>';
    row.appendChild(wrap);
    hpState[id] = { hp: maxHp, maxHp: maxHp, team: team, name: char.name.toLowerCase(), barColor: barColor, barGlow: barGlow };
  }

  teamA.forEach(function(c, i) { addBar(c, 'A', rowA, i); });
  teamB.forEach(function(c, i) { addBar(c, 'B', rowB, i); });
  document.getElementById('battleHpBars').classList.add('visible');
}

function setHp(id, newHp, event, dmgAmount) {
  var s = hpState[id];
  if (!s) return;
  var oldHp = s.hp;
  s.hp = Math.max(0, Math.min(s.maxHp, newHp));
  var fillEl  = document.getElementById('hpFill_'  + id);
  var valEl   = document.getElementById('hpVal_'   + id);
  var trackEl = document.getElementById('hpTrack_' + id);
  var wrapEl  = document.getElementById('hpWrap_'  + id);
  if (!fillEl || !valEl) return;
  var pct = (s.hp / s.maxHp) * 100;
  fillEl.style.width = pct + '%';
  valEl.textContent = Math.round(s.hp).toLocaleString() + ' HP';
  if (pct > 50) { fillEl.style.background = s.barColor; fillEl.style.boxShadow = '0 0 10px ' + s.barGlow; }
  else if (pct > 25) { fillEl.style.background = 'linear-gradient(90deg,#995500,#ffaa00,#ffcc44)'; fillEl.style.boxShadow = '0 0 10px #ffaa0088'; }
  else { fillEl.style.background = 'linear-gradient(90deg,#770000,#ff2200,#ff5533)'; fillEl.style.boxShadow = '0 0 12px #ff220099'; }

  // Focus scroll and highlight
  if (wrapEl) {
    wrapEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    wrapEl.style.transition = 'transform .15s';
    wrapEl.style.transform = 'scale(1.04)';
    setTimeout(function(){ wrapEl.style.transform = 'scale(1)'; }, 350);
  }

  // Damage/heal float number
  if (dmgAmount && trackEl) {
    var isHeal = event === 'heal';
    var floatEl = document.createElement('div');
    floatEl.className = 'dmg-float';
    var sign = isHeal ? '+' : '-';
    var color = isHeal ? '#00ff44' : (event === 'crit' ? '#ff2200' : (event === 'counter' ? '#ff6600' : '#ffcc44'));
    var offsetX = s.team === 'A' ? '-110px' : '110%';
    floatEl.style.cssText = 'color:' + color + ';text-shadow:0 0 10px '+color+';top:-8px;' + (s.team==='A' ? 'right:105%;' : 'left:105%;') + 'position:absolute;';
    floatEl.textContent = sign + Math.round(Math.abs(dmgAmount)).toLocaleString();
    var parentEl = trackEl.parentElement;
    if (parentEl) {
      parentEl.style.position = 'relative';
      parentEl.appendChild(floatEl);
      setTimeout(function(){ if(floatEl.parentNode) floatEl.parentNode.removeChild(floatEl); }, 1000);
    }
  }

  if (trackEl) {
    trackEl.classList.remove('anim-crit','anim-counter','anim-heal','anim-ultimate');
    void trackEl.offsetWidth;
    if (event === 'crit') trackEl.classList.add('anim-crit');
    else if (event === 'counter') trackEl.classList.add('anim-counter');
    else if (event === 'heal') trackEl.classList.add('anim-heal');
    else if (event === 'ultimate') trackEl.classList.add('anim-ultimate');
    setTimeout(function() { trackEl.classList.remove('anim-crit','anim-counter','anim-heal','anim-ultimate'); }, 1000);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BAR-SIDE EVENT CARD SYSTEM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Accumulates special event tags across chunks (since [CRITICO] and [DANO] may arrive in different chunks)
var _pendingSpecial = 'normal'; // 'normal' | 'crit' | 'counter' | 'ultimate'

function _positionCardByBar(targetId) {
  var wrap = document.getElementById('hpWrap_' + targetId);
  var card = document.getElementById('barEventCard');
  if (!wrap || !card) return;
  var rect = wrap.getBoundingClientRect();
  // Center card horizontally on the bar, place BELOW it
  var cardW = card.offsetWidth || 200;
  var left  = rect.left + rect.width / 2 - cardW / 2;
  left = Math.max(8, Math.min(window.innerWidth - cardW - 8, left));
  card.style.left  = left + 'px';
  card.style.right = 'auto';
  card.style.top   = (rect.bottom + 10) + 'px';
}

function showBarCard(opts, targetId, durationMs) {
  // opts: { type, typeColor, name, nameColor, amount, amountColor }
  return new Promise(function(resolve) {
    var dimmer  = document.getElementById('battleDimmer');
    var card    = document.getElementById('barEventCard');
    var cType   = document.getElementById('barEventCardType');
    var cName   = document.getElementById('barEventCardName');
    var cAmt    = document.getElementById('barEventCardAmount');
    var wrapEl  = targetId ? document.getElementById('hpWrap_' + targetId) : null;

    // Fill card content
    cType.textContent = opts.type || '';
    cType.style.color = opts.typeColor || '#fff';
    cType.style.textShadow = '0 0 20px ' + (opts.typeColor || '#fff') + ', 0 0 40px ' + (opts.typeColor || '#fff') + '88';
    cName.innerHTML = opts.name ? opts.name : '';
    cAmt.textContent  = opts.amount != null ? opts.amount : '';
    cAmt.style.color  = opts.amountColor || '#fff';
    cAmt.style.textShadow = '0 0 16px ' + (opts.amountColor || '#fff');
    card.style.borderColor = opts.typeColor || '#fff';
    card.style.boxShadow   = '0 0 30px ' + (opts.typeColor || '#fff') + '44, 0 0 60px ' + (opts.typeColor || '#fff') + '22';

    // Show dimmer
    dimmer.classList.add('active');

    // Focus the target bar
    if (wrapEl) {
      wrapEl.classList.add('bar-focused');
      wrapEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Show card positioned next to bar
    card.style.display = 'block';
    card.classList.remove('hide');
    void card.offsetWidth;
    _positionCardByBar(targetId);
    card.classList.add('show');

    setTimeout(function() {
      // Hide card
      card.classList.remove('show');
      card.classList.add('hide');
      dimmer.classList.remove('active');
      if (wrapEl) wrapEl.classList.remove('bar-focused');
      setTimeout(function() {
        card.style.display = 'none';
        card.classList.remove('hide');
        resolve();
      }, 280);
    }, durationMs || 2000);
  });
}

function showEventPopup(text, evClass) {
  var popup = document.getElementById('battleEventPopup');
  popup.textContent = text;
  popup.className = '';
  void popup.offsetWidth;
  popup.className = 'show ' + evClass;
  clearTimeout(popup._t);
  popup._t = setTimeout(function() {
    popup.className = 'hide ' + evClass;
    setTimeout(function() { popup.className = ''; }, 400);
  }, 1000);
}

/* ‚îÄ‚îÄ‚îÄ ULTIMATE TUNNEL ‚îÄ‚îÄ‚îÄ */
function playUltimateEffect(color) {
  return new Promise(function(resolve) {
    var canvas = document.getElementById('ultimateCanvas');
    var ctx = canvas.getContext('2d');
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.classList.add('active');
    var cx = canvas.width / 2, cy = canvas.height / 2;
    var beams = [], nb = 36;
    var col = color || '#ffcc00';
    for (var i = 0; i < nb; i++) {
      beams.push({ angle: (Math.PI*2/nb)*i + Math.random()*0.12, width: 3+Math.random()*20,
        length:0, maxLen: Math.max(canvas.width,canvas.height)*1.6, alpha:0.5+Math.random()*0.5 });
    }
    var t0 = performance.now(), dur = 2400;
    function ph(hex){ return parseInt(hex.slice(1,3),16)+','+parseInt(hex.slice(3,5),16)+','+parseInt(hex.slice(5,7),16); }
    var rgb = ph(col.match(/^#[0-9a-f]{6}$/i) ? col : '#ffcc00');
    function frame(now) {
      var t = (now-t0)/dur;
      if (t>1){ canvas.classList.remove('active'); ctx.clearRect(0,0,canvas.width,canvas.height); resolve(); return; }
      var ga = t<0.12 ? t/0.12 : t>0.75 ? 1-(t-0.75)/0.25 : 1;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      var gr = ctx.createRadialGradient(cx,cy,0,cx,cy,Math.max(canvas.width,canvas.height)*0.7);
      gr.addColorStop(0,'rgba(0,0,0,0.97)'); gr.addColorStop(0.6,'rgba(0,0,0,0.5)'); gr.addColorStop(1,'rgba(0,0,0,0)');
      ctx.globalAlpha=ga; ctx.fillStyle=gr; ctx.fillRect(0,0,canvas.width,canvas.height);
      beams.forEach(function(b){
        b.length=Math.min(b.length+b.maxLen*0.07*(1+t*3),b.maxLen);
        var bx=cx+Math.cos(b.angle)*b.length, by=cy+Math.sin(b.angle)*b.length;
        var bg=ctx.createLinearGradient(cx,cy,bx,by);
        bg.addColorStop(0,'rgba('+rgb+',0)'); bg.addColorStop(0.06,'rgba('+rgb+','+b.alpha+')'); bg.addColorStop(1,'rgba('+rgb+',0)');
        ctx.globalAlpha=ga; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(bx,by);
        ctx.strokeStyle=bg; ctx.lineWidth=b.width*(1-t*0.3); ctx.stroke();
      });
      var bR=15+t*200;
      var bG=ctx.createRadialGradient(cx,cy,0,cx,cy,bR);
      bG.addColorStop(0,'rgba('+rgb+',0.95)'); bG.addColorStop(0.5,'rgba('+rgb+',0.4)'); bG.addColorStop(1,'rgba('+rgb+',0)');
      ctx.globalAlpha=ga; ctx.fillStyle=bG; ctx.beginPath(); ctx.arc(cx,cy,bR,0,Math.PI*2); ctx.fill();
      for(var r=0;r<7;r++){
        var rR=(t*600+r*100)%600; ctx.globalAlpha=(1-rR/600)*0.4*ga;
        ctx.strokeStyle=col; ctx.lineWidth=2.5; ctx.beginPath(); ctx.arc(cx,cy,rR,0,Math.PI*2); ctx.stroke();
      }
      requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  });
}

/* ‚îÄ‚îÄ‚îÄ TRIGGER FUNCTIONS ‚îÄ‚îÄ‚îÄ */
function triggerDamagePause(targetId, dmgAmount, evType) {
  var s = hpState[targetId];
  if (!s) return Promise.resolve();
  var hpPct = s.hp / s.maxHp;
  var hpColor = hpPct > 0.5 ? '#5588ff' : hpPct > 0.25 ? '#ffaa00' : '#ff2200';
  var dispName = s.name.charAt(0).toUpperCase() + s.name.slice(1);
  var hpStr = Math.round(s.hp).toLocaleString() + ' HP';
  var nameHtml = '<span style="color:#fff;font-size:.85rem;font-family:\'Black Ops One\',sans-serif;letter-spacing:1px;">' + dispName + '</span>'
    + '<br><span style="color:' + hpColor + ';font-size:.72rem;font-family:\'Exo 2\',sans-serif;font-weight:600;">' + hpStr + ' restante</span>';

  if (evType === 'ultimate') {
    var tc = s.team === 'A' ? '#5588ff' : '#ff4422';
    return playUltimateEffect(tc).then(function() {
      showEventPopup('ULTIMATE!!', 'ev-ultimate');
      return showBarCard({ type:'‚ö° ULTIMATE ‚ö°', typeColor:'#ffcc00', name: nameHtml, amount: '-' + Math.round(dmgAmount).toLocaleString(), amountColor:'#ffcc00' }, targetId, 3200);
    });
  } else if (evType === 'crit') {
    showEventPopup('CR√çTICO!', 'ev-crit');
    return showBarCard({ type:'üí• CR√çTICO!', typeColor:'#ff2200', name: nameHtml, amount: '-' + Math.round(dmgAmount).toLocaleString(), amountColor:'#ff4444' }, targetId, 2500);
  } else if (evType === 'counter') {
    showEventPopup('COUNTER!', 'ev-counter');
    return showBarCard({ type:'üîÑ COUNTER!', typeColor:'#ff6600', name: nameHtml, amount: '-' + Math.round(dmgAmount).toLocaleString(), amountColor:'#ff8844' }, targetId, 2500);
  } else {
    return showBarCard({ type:'‚öî DANO', typeColor:'#ff4422', name: nameHtml, amount: '-' + Math.round(dmgAmount).toLocaleString(), amountColor:'#ff6655' }, targetId, 1600);
  }
}

function triggerHealPause(targetId, healAmount) {
  var s = hpState[targetId];
  if (!s) return Promise.resolve();
  var dispName = s.name.charAt(0).toUpperCase() + s.name.slice(1);
  var hpStr = Math.round(s.hp).toLocaleString() + ' HP';
  var nameHtml = '<span style="color:#fff;font-size:.85rem;font-family:\'Black Ops One\',sans-serif;letter-spacing:1px;">' + dispName + '</span>'
    + '<br><span style="color:#00ff88;font-size:.72rem;font-family:\'Exo 2\',sans-serif;font-weight:600;">' + hpStr + ' atual</span>';
  showEventPopup('CURA!', 'ev-heal');
  return showBarCard({ type:'üíö CURA!', typeColor:'#00ff88', name: nameHtml, amount: '+' + Math.round(healAmount).toLocaleString(), amountColor:'#00ff88' }, targetId, 2000);
}

function triggerKOPause(targetId) {
  var s = hpState[targetId];
  var dispName = s ? (s.name.charAt(0).toUpperCase() + s.name.slice(1)) : '';
  var nameHtml = '<span style="color:#888;font-size:.85rem;font-family:\'Black Ops One\',sans-serif;text-decoration:line-through;">' + dispName + '</span>';
  return showBarCard({ type:'üíÄ K.O.!', typeColor:'#ff2200', name: nameHtml, amount: '0 HP', amountColor:'#555' }, targetId, 2500);
}

function triggerFinalizacao(tipo, nome) {
  return new Promise(function(resolve) {
    var overlay = document.getElementById('finalizacaoOverlay');
    var titleEl = document.getElementById('finalizacaoTitle');
    var subEl   = document.getElementById('finalizacaoSub');
    if (!overlay || !titleEl || !subEl) { resolve(); return; }

    var cfg = {
      vitoria:        { title: 'VIT√ìRIA',          sub: nome, bg: 'rgba(0,0,40,0.97)',  color: '#5588ff',  duration: 2800 },
      empate:         { title: 'EMPATE',            sub: 'Nenhum vencedor',               bg: 'rgba(20,0,40,0.97)',  color: '#aa88ff', duration: 3000 },
      empate_desgaste:{ title: 'EMPATE',            sub: 'Por Desgaste M√∫tuo',            bg: 'rgba(20,0,40,0.97)',  color: '#aa88ff', duration: 3000 },
      piedade:        { title: 'PIEDADE',           sub: nome + ' mostra miseric√≥rdia',  bg: 'rgba(0,30,10,0.97)',  color: '#00ff88', duration: 3200 },
      piedade_traicao:{ title: 'TRAI√á√ÉO!',          sub: 'A piedade foi uma armadilha',  bg: 'rgba(40,0,0,0.97)',   color: '#ff4400', duration: 3500 },
      fatality:       { title: 'FATALITY',          sub: nome,                           bg: 'rgba(30,0,0,0.98)',   color: '#ff0000', duration: 4000 },
      brutality:      { title: 'BRUTALITY',         sub: nome,                           bg: 'rgba(20,0,0,0.98)',   color: '#ff2200', duration: 4000 },
    };
    var c = cfg[tipo] || cfg['vitoria'];

    overlay.style.background = c.bg;
    titleEl.textContent = c.title;
    titleEl.style.color = c.color;
    titleEl.style.textShadow = '0 0 40px ' + c.color + ', 0 0 100px ' + c.color + '88, 0 0 200px ' + c.color + '44';
    subEl.textContent = c.sub;
    subEl.style.color = c.color === '#ff0000' || c.color === '#ff2200' || c.color === '#ff4400' ? '#ffaaaa' : 'rgba(255,255,255,0.7)';

    // Add type-specific class for extra effects
    overlay.className = 'finalizacao-overlay active finalizacao-' + tipo;

    setTimeout(function() {
      overlay.classList.remove('active');
      setTimeout(resolve, 500);
    }, c.duration);
  });
}




async function parseEvents(text) {
  // Accumulate special tags globally across chunks ‚Äî they may arrive before the [DANO]
  if (/\[ULTIMATE\]/i.test(text)) _pendingSpecial = 'ultimate';
  else if (/\[CRITICO\]/i.test(text) && _pendingSpecial === 'normal') _pendingSpecial = 'crit';
  else if (/\[COUNTER\]/i.test(text) && _pendingSpecial === 'normal') _pendingSpecial = 'counter';

  // ‚îÄ‚îÄ DAMAGE ‚îÄ‚îÄ
  var danoRx = /\[DANO:\s*([\d.,]+)\s*-\s*([^\]]+)\]/gi;
  var m;
  while ((m = danoRx.exec(text)) !== null) {
    var numStr = m[1].trim();
    var amount = numStr.indexOf(',') !== -1
      ? parseFloat(numStr.replace(/\./g,'').replace(',','.'))
      : parseFloat(numStr.replace(/\./g,''));
    if (!amount || isNaN(amount)) continue;

    var hint = (m[2] || '').toLowerCase().trim();
    var ids = Object.keys(hpState);
    var targetId = null;

    if (hint) {
      for (var i = 0; i < ids.length; i++) {
        if (hpState[ids[i]].hp <= 0) continue;
        var cn = hpState[ids[i]].name;
        if (cn.indexOf(hint) !== -1 || hint.indexOf(cn) !== -1) { targetId = ids[i]; break; }
      }
    }
    if (!targetId) {
      var tA=0, tB=0;
      ids.forEach(function(id){ if(hpState[id].hp>0){ hpState[id].team==='A'?tA+=hpState[id].hp:tB+=hpState[id].hp; }});
      var tTeam = tA >= tB ? 'A' : 'B';
      var best=null, bestHp=-1;
      for (var j=0;j<ids.length;j++){
        if(hpState[ids[j]].hp<=0)continue;
        if(hpState[ids[j]].team===tTeam&&hpState[ids[j]].hp>bestHp){bestHp=hpState[ids[j]].hp;best=ids[j];}
      }
      if(!best){for(var j2=0;j2<ids.length;j2++){if(hpState[ids[j2]].hp>bestHp){bestHp=hpState[ids[j2]].hp;best=ids[j2];}}}
      targetId = best;
    }

    if (!targetId || hpState[targetId].hp <= 0) continue;

    var prevHp    = hpState[targetId].hp;
    var actualDmg = Math.min(amount, prevHp);
    if (actualDmg <= 0) continue;

    var evType      = _pendingSpecial;
    _pendingSpecial = 'normal'; // consume

    lastHitId = targetId;
    setHp(targetId, prevHp - actualDmg, evType === 'normal' ? 'damage' : evType, actualDmg);
    if (hpState[targetId].team === 'A') totalDamageB += actualDmg;
    else                                totalDamageA += actualDmg;

    await triggerDamagePause(targetId, actualDmg, evType);

    if (hpState[targetId].hp <= 0) {
      var dw = document.getElementById('hpWrap_' + targetId);
      if (dw) { dw.classList.add('dying'); setTimeout(function(el){el.classList.remove('dying');el.classList.add('dead');},700,dw); }
      await triggerKOPause(targetId);
    }
  }

  // ‚îÄ‚îÄ HEAL ‚îÄ‚îÄ
  var curaRx = /\[CURA:\s*([\d.,]+)\s*-\s*([^\]]+)\]/gi;
  var cm;
  while ((cm = curaRx.exec(text)) !== null) {
    var hNum = cm[1].trim();
    var hAmt = hNum.indexOf(',') !== -1
      ? parseFloat(hNum.replace(/\./g,'').replace(',','.'))
      : parseFloat(hNum.replace(/\./g,''));
    if (!hAmt || isNaN(hAmt)) continue;
    var hHint = (cm[2]||'').toLowerCase().trim();
    var hids  = Object.keys(hpState);
    var hTarget = null;
    for (var hi=0;hi<hids.length;hi++){
      var hn=hpState[hids[hi]].name;
      if(hn.indexOf(hHint)!==-1||hHint.indexOf(hn)!==-1){hTarget=hids[hi];break;}
    }
    if (!hTarget) {
      var loPct=2,loId=null;
      hids.forEach(function(id){var hs=hpState[id];if(hs.hp>0&&(hs.hp/hs.maxHp)<loPct){loPct=hs.hp/hs.maxHp;loId=id;}});
      hTarget=loId;
    }
    if (hTarget) {
      var maxH=hpState[hTarget].maxHp-hpState[hTarget].hp;
      var actH=Math.min(hAmt,maxH);
      if (actH>0){setHp(hTarget,hpState[hTarget].hp+actH,'heal',actH);await triggerHealPause(hTarget,actH);}
    }
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   START / STOP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setBattleRunning(running) {
  battleRunning = running;
  var startBtn = document.getElementById('battleStartBtn');
  var stopBtn  = document.getElementById('battleStopBtn');
  startBtn.disabled = running || (!battleTeamA.length || !battleTeamB.length);
  stopBtn.style.display = running ? 'block' : 'none';
}

function stopBattle() {
  if (battleAbortController) battleAbortController.abort();
  setBattleRunning(false);
  ttsStop();
  var cur = document.getElementById('streamCursor');
  if (cur) cur.remove();
  showToast('Batalha interrompida.');
}

async function startBattle() {
  var apiKey = localStorage.getItem(BATTLE_API_KEY);
  if (!apiKey) { showToast('Configure a chave da API Groq!'); return; }
  if (!battleTeamA.length || !battleTeamB.length) { showToast('Adicione personagens nos dois times!'); return; }
  if (battleRunning) return;
  setBattleRunning(true);
  battleAbortController = new AbortController();
  ttsStop();
  initHpBars(battleTeamA, battleTeamB);

  var resultDiv = document.getElementById('battleResult');
  var resultBox = document.getElementById('battleResultBox');
  resultDiv.classList.add('visible');
  resultBox.innerHTML =
    '<div style="margin-bottom:20px;">' +
    '<h3 style="margin-bottom:14px;letter-spacing:2px;">Narracao da Batalha</h3>' +
    '<div id="streamNarrative" class="battle-narrative"></div>' +
    '<span id="streamCursor" style="display:inline-block;width:2px;height:1em;background:var(--accent);margin-left:2px;vertical-align:middle;animation:blink .7s step-end infinite;"></span>' +
    '</div>';
  resultBox.scrollIntoView({ behavior:'smooth', block:'start' });

  var narrativeEl = document.getElementById('streamNarrative');
  var allNames = battleTeamA.concat(battleTeamB).map(function(c){return c.name;}).join(', ');
  var prompt = buildBattlePrompt(battleTeamA, battleTeamB);
  var ex1 = battleTeamA[0] ? battleTeamA[0].name : 'Guerreiro';
  var ex2 = battleTeamB[0] ? battleTeamB[0].name : 'Inimigo';
  var streamPrompt = prompt +
    '\n\n‚ïê‚ïê‚ïê‚ïê SISTEMA DE TAGS (INVIS√çVEIS AO LEITOR) ‚ïê‚ïê‚ïê‚ïê' +
    '\nDurante a narra√ß√£o, insira tags de controle COLADAS ao texto.' +
    '\n' +
    '\nTAG DE DANO (obrigat√≥ria a cada golpe):' +
    '\n  [DANO:VALOR-Nome]  ‚Äî Nome = personagem que RECEBE o dano' +
    '\n  Exemplos: [DANO:2800-' + ex1 + '] [DANO:1500-' + ex2 + ']' +
    '\n  Personagens: ' + allNames +
    '\n' +
    '\nTAG DE CURA: [CURA:VALOR-Nome]  ex: [CURA:900-' + ex1 + ']' +
    '\n  ATEN√á√ÉO: S√≥ cure personagens que ainda est√£o de p√© (HP > 0). Personagens em KO N√ÉO podem ser curados.' +
    '\n' +
    '\nTAGS ESPECIAIS (coladas ANTES do [DANO] correspondente):' +
    '\n  [CRITICO] = golpe cr√≠tico devastador' +
    '\n  [COUNTER] = contragolpe' +
    '\n  [ULTIMATE] = t√©cnica suprema' +
    '\n' +
    '\nTAG DE FINALIZA√á√ÉO (use UMA VEZ, antes do ===RESULTADO===):' +
    '\n  [FINALIZACAO:tipo-NomeVencedor]' +
    '\n  Tipos: vitoria | empate | empate_desgaste | piedade | piedade_traicao | fatality | brutality' +
    '\n  Exemplos: [FINALIZACAO:fatality-' + ex1 + '] [FINALIZACAO:empate-Empate]' +
    '\n' +
    '\n‚ïê‚ïê‚ïê‚ïê FORMATA√á√ÉO RICA DO TEXTO ‚ïê‚ïê‚ïê‚ïê' +
    '\n  @@texto@@  = vermelho intenso em negrito (nomes de t√©cnicas, gritos)' +
    '\n  ##texto##  = dourado brilhante (momentos √©picos, viradas)' +
    '\n  ^^texto^^  = verde (cura, regenera√ß√£o, recupera√ß√£o)' +
    '\n  ~~texto~~  = roxo it√°lico (mist√©rio, poderes ocultos)' +
    '\n  **texto**  = negrito  |  *texto* = it√°lico' +
    '\n' +
    '\nREGRAS ABSOLUTAS:' +
    '\n  1. Narre SEM mencionar n√∫meros no texto vis√≠vel' +
    '\n  2. Personagem em KO = ELIMINADO. N√£o ataca, n√£o √© curado, n√£o age mais.' +
    '\n  3. Escreva par√°grafos longos e detalhados, 4-6 frases cada' +
    '\n  4. Use @@nome da t√©cnica@@ para destacar ataques especiais' +
    '\n  5. Use ##momento √©pico## para viradas dram√°ticas' +
    '\n  6. Use pelo menos 10x [DANO], 1x [CURA], 1x [CRITICO], 1x [COUNTER], 1x [ULTIMATE]' +
    '\n  7. AO FINAL, ap√≥s toda a narra√ß√£o, coloque EXATAMENTE:' +
    '\n===RESULTADO===' +
    '\n{"vencedor":"Nome ou Empate","tipo_desfecho":"vitoria|empate|empate_desgaste|piedade|piedade_traicao|fatality|brutality","mvp":null,"placar":{"timeA":{"habilidadesDecisivas":["h1","h2"]},"timeB":{"habilidadesDecisivas":["h1","h2"]}},"desfecho":"frase epica de encerramento curta"}';

  try {
    var resp = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      signal: battleAbortController.signal,
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
      body: JSON.stringify({ model: 'llama-3.3-70b-versatile', max_tokens: 10000, temperature: 1.0, stream: true, messages: [{ role: 'user', content: streamPrompt }] })
    });
    if (!resp.ok) { var e=await resp.json().catch(function(){return {};}); throw new Error((e.error&&e.error.message)||'Erro '+resp.status); }

    // ‚îÄ‚îÄ PHASE 1: Read the entire stream into fullText first ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    narrativeEl.innerHTML = '<span style="color:var(--text3);font-size:.85rem;font-style:italic;animation:blink 1s step-end infinite;">‚öî Preparando batalha √©pica...</span>';
    var reader = resp.body.getReader();
    var decoder = new TextDecoder();
    var fullText = '', buf = '';
    while (true) {
      var chunk = await reader.read();
      if (chunk.done) break;
      buf += decoder.decode(chunk.value, {stream:true});
      var splitLines = buf.split('\n');
      buf = splitLines.pop();
      for (var li = 0; li < splitLines.length; li++) {
        var line = splitLines[li];
        if (line.indexOf('data: ') !== 0) continue;
        var raw = line.slice(6).trim();
        if (raw === '[DONE]') continue;
        try {
          var obj = JSON.parse(raw);
          var delta = (obj.choices && obj.choices[0] && obj.choices[0].delta && obj.choices[0].delta.content) || '';
          if (delta) fullText += delta;
        } catch(e2) {}
      }
    }

    // ‚îÄ‚îÄ Split narrative from JSON result ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var resultJson = '';
    var narrativeOnly = fullText;
    var splitIdx = fullText.indexOf('===RESULTADO===');
    if (splitIdx !== -1) {
      narrativeOnly = fullText.slice(0, splitIdx);
      resultJson    = fullText.slice(splitIdx + 15);
    }

    // ‚îÄ‚îÄ PHASE 2: Typewriter playback ‚Äî char by char, pausing on tags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Tokenize: split into array of {type:'text'|'tag', value}
    var tokens = [];
    var tagRx = /\[(DANO:[^\]]+|CURA:[^\]]+|CRITICO|COUNTER|ULTIMATE|FINALIZACAO:[^\]]+)\]/gi;
    var lastIdx = 0, tm;
    tagRx.lastIndex = 0;
    while ((tm = tagRx.exec(narrativeOnly)) !== null) {
      if (tm.index > lastIdx) tokens.push({type:'text', value: narrativeOnly.slice(lastIdx, tm.index)});
      tokens.push({type:'tag', value: tm[0]});
      lastIdx = tm.index + tm[0].length;
    }
    if (lastIdx < narrativeOnly.length) tokens.push({type:'text', value: narrativeOnly.slice(lastIdx)});

    // Typewriter: accumulate displayed text; on tag ‚Üí fire event and pause
    var displayed = '';
    var CHAR_DELAY = 38; // ms per character ‚Äî slower so voice keeps up

    function renderDisplayed() {
      var fmt = displayed
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        .replace(/@@([^@]+)@@/g, '<span style="color:#ff4422;font-weight:900;font-family:\'Black Ops One\',sans-serif;letter-spacing:2px;font-size:1.1em;">$1</span>')
        .replace(/##([^#]+)##/g, '<span style="color:#ffcc00;font-weight:900;font-size:1.05em;text-shadow:0 0 12px #ffcc0088;">$1</span>')
        .replace(/\^\^([^^]+)\^\^/g, '<span style="color:#00ff88;font-weight:800;">$1</span>')
        .replace(/~~([^~]+)~~/g, '<span style="color:#aa66ff;font-style:italic;">$1</span>')
        .replace(/\n\n/g,'<br><br>')
        .replace(/\n/g,'<br>');
      narrativeEl.innerHTML = fmt;
    }

    function sleep(ms) { return new Promise(function(r){ setTimeout(r, ms); }); }

    // pending special tag that arrived before its [DANO]
    _pendingSpecial = 'normal';

    for (var ti = 0; ti < tokens.length; ti++) {
      var tok = tokens[ti];
      if (battleAbortController && battleAbortController.signal.aborted) break;

      if (tok.type === 'text') {
        // Type out char by char
        for (var ci = 0; ci < tok.value.length; ci++) {
          if (battleAbortController && battleAbortController.signal.aborted) break;
          displayed += tok.value[ci];
          ttsTypeChar(tok.value[ci]);
          elevenTypeChar(tok.value[ci]);
          renderDisplayed();
          // Slightly longer pause on sentence end
          var ch = tok.value[ci];
          var delay = (ch === '.' || ch === '!' || ch === '?') ? CHAR_DELAY * 6 : CHAR_DELAY;
          await sleep(delay);
        }
      } else {
        // It's a tag ‚Äî process it immediately (no char delay)
        var tagVal = tok.value;
        var upperTag = tagVal.toUpperCase();

        if (upperTag.indexOf('[ULTIMATE]') !== -1) {
          _pendingSpecial = 'ultimate';
        } else if (upperTag.indexOf('[CRITICO]') !== -1 && _pendingSpecial === 'normal') {
          _pendingSpecial = 'crit';
        } else if (upperTag.indexOf('[COUNTER]') !== -1 && _pendingSpecial === 'normal') {
          _pendingSpecial = 'counter';
        } else if (upperTag.indexOf('[DANO:') !== -1) {
          var danoM = tagVal.match(/\[DANO:\s*([\d.,]+)\s*-\s*([^\]]+)\]/i);
          if (danoM) {
            var numStr = danoM[1].replace(/\./g,'').replace(',','.');
            var amount = parseFloat(numStr);
            if (!isNaN(amount) && amount > 0) {
              var hint = danoM[2].toLowerCase().trim();
              var ids = Object.keys(hpState);
              var targetId = null;
              for (var ki=0;ki<ids.length;ki++){
                if(hpState[ids[ki]].hp<=0) continue;
                var cn=hpState[ids[ki]].name;
                if(cn.indexOf(hint)!==-1||hint.indexOf(cn)!==-1){targetId=ids[ki];break;}
              }
              if (!targetId) {
                var tA=0,tB=0;
                ids.forEach(function(id){if(hpState[id].hp>0){hpState[id].team==='A'?tA+=hpState[id].hp:tB+=hpState[id].hp;}});
                var tTeam=tA>=tB?'A':'B'; var best=null,bestHp=-1;
                for(var ki2=0;ki2<ids.length;ki2++){if(hpState[ids[ki2]].hp>0&&hpState[ids[ki2]].team===tTeam&&hpState[ids[ki2]].hp>bestHp){bestHp=hpState[ids[ki2]].hp;best=ids[ki2];}}
                if(!best){for(var ki3=0;ki3<ids.length;ki3++){if(hpState[ids[ki3]].hp>bestHp){bestHp=hpState[ids[ki3]].hp;best=ids[ki3];}}}
                targetId=best;
              }
              if (targetId && hpState[targetId].hp > 0) {
                var prevHp = hpState[targetId].hp;
                var actualDmg = Math.min(amount, prevHp);
                if (actualDmg > 0) {
                  var evType = _pendingSpecial;
                  _pendingSpecial = 'normal';
                  if (hpState[targetId].team === 'A') totalDamageB += actualDmg;
                  else totalDamageA += actualDmg;
                  setHp(targetId, prevHp - actualDmg, evType === 'normal' ? 'damage' : evType, actualDmg);
                  await triggerDamagePause(targetId, actualDmg, evType);
                  if (hpState[targetId].hp <= 0) {
                    var dw = document.getElementById('hpWrap_' + targetId);
                    if (dw) { dw.classList.add('dying'); setTimeout(function(el){el.classList.remove('dying');el.classList.add('dead');},700,dw); }
                    await triggerKOPause(targetId);
                  }
                }
              }
            }
          }
        } else if (upperTag.indexOf('[CURA:') !== -1) {
          var curaM = tagVal.match(/\[CURA:\s*([\d.,]+)\s*-\s*([^\]]+)\]/i);
          if (curaM) {
            var hNum = curaM[1].replace(/\./g,'').replace(',','.');
            var hAmt = parseFloat(hNum);
            if (!isNaN(hAmt) && hAmt > 0) {
              var hHint = curaM[2].toLowerCase().trim();
              var hids = Object.keys(hpState);
              var hTarget = null;
              // Only heal living characters (KO guard)
              for(var hi=0;hi<hids.length;hi++){
                if(hpState[hids[hi]].hp <= 0) continue; // skip dead
                var hn=hpState[hids[hi]].name;
                if(hn.indexOf(hHint)!==-1||hHint.indexOf(hn)!==-1){hTarget=hids[hi];break;}
              }
              // fallback: lowest HP among living
              if(!hTarget){var loPct=2,loId=null;hids.forEach(function(id){var hs=hpState[id];if(hs.hp>0&&(hs.hp/hs.maxHp)<loPct){loPct=hs.hp/hs.maxHp;loId=id;}});hTarget=loId;}
              if(hTarget && hpState[hTarget].hp > 0){var maxH=hpState[hTarget].maxHp-hpState[hTarget].hp;var actH=Math.min(hAmt,maxH);if(actH>0){setHp(hTarget,hpState[hTarget].hp+actH,'heal',actH);await triggerHealPause(hTarget,actH);}}
            }
          }
        } else if (upperTag.indexOf('[FINALIZACAO:') !== -1) {
          var finM = tagVal.match(/\[FINALIZACAO:\s*([^-\]]+)-([^\]]*)\]/i);
          if (finM) {
            var finType = finM[1].trim().toLowerCase();
            var finName = finM[2].trim();
            await triggerFinalizacao(finType, finName);
          }
        }
      }
    }

    var cur2 = document.getElementById('streamCursor');
    if (cur2) cur2.remove();

    // TTS finalization
    ttsFlushBuffer();
    elevenFlushBuffer();
    if (_ttsEngine === 'eleven') {
      await elevenLabsNarrate(narrativeOnly);
    }

    setBattleRunning(false);

    var parsed = null;
    try {
      var clean = resultJson.replace(/```json|```/g,'').trim();
      var mx = clean.match(/\{[\s\S]*\}/);
      if (mx) parsed = JSON.parse(mx[0]);
    } catch(je) {}
    if (parsed) {
      if (!parsed.placar) parsed.placar = {timeA:{},timeB:{}};
      if (!parsed.placar.timeA) parsed.placar.timeA = {};
      if (!parsed.placar.timeB) parsed.placar.timeB = {};
      parsed.placar.timeA.danoTotal = Math.round(totalDamageA); // damage dealt BY team A (to team B)
      parsed.placar.timeB.danoTotal = Math.round(totalDamageB); // damage dealt BY team B (to team A)
    }
    renderBattleResult(parsed, resultBox);

  } catch(err) {
    if (err.name === 'AbortError') return;
    var cur3 = document.getElementById('streamCursor');
    if (cur3) cur3.remove();
    setBattleRunning(false);
    resultBox.innerHTML += '<div style="text-align:center;padding:20px;color:#ff6666;font-size:.85rem;"><b>ERRO:</b> ' + err.message + '</div>';
  }
}

function renderBattleResult(data, resultBox) {
  var tipo = (data && data.tipo_desfecho) || 'vitoria';
  var vencedor = (data && data.vencedor) || '';
  var isEmpate = tipo.indexOf('empate') !== -1 || vencedor.toLowerCase().indexOf('empate') !== -1;
  var isPiedade = tipo === 'piedade';

  var winnerIsA = !isEmpate && (
    (vencedor.toLowerCase().indexOf('time a') !== -1) ||
    battleTeamA.some(function(c) { return c.name.toLowerCase() === vencedor.toLowerCase(); })
  );

  var winnerColor, bannerLabel, bannerName;
  if (isEmpate) {
    winnerColor  = '#aa88ff';
    bannerLabel  = tipo === 'empate_desgaste' ? '‚ö° EMPATE POR DESGASTE' : '‚öñ EMPATE';
    bannerName   = 'Nenhum vencedor';
  } else if (isPiedade) {
    winnerColor  = winnerIsA ? '#5588ff' : '#ff4422';
    bannerLabel  = 'üïä VIT√ìRIA POR PIEDADE';
    bannerName   = vencedor;
  } else {
    winnerColor  = winnerIsA ? '#5588ff' : '#ff4422';
    bannerLabel  = 'üèÜ VENCEDOR';
    bannerName   = vencedor || (winnerIsA ? 'Time A' : 'Time B');
  }

  var statsA = (data && data.placar && data.placar.timeA) || {};
  var statsB = (data && data.placar && data.placar.timeB) || {};
  var mvpHtml = (data && data.mvp && data.mvp !== 'null') ? '<div class="battle-mvp">‚≠ê MVP: ' + data.mvp + '</div>' : '';
  var desfechoHtml = (data && data.desfecho) ? '<p style="margin-top:14px;font-size:.9rem;color:var(--text2);font-family:Rajdhani,sans-serif;font-style:italic;">"' + data.desfecho + '"</p>' : '';
  var habA = ((statsA.habilidadesDecisivas) || []).map(function(h){return '<div class="battle-stat-row"><span style="color:var(--text3);font-size:.76rem;">‚öî '+h+'</span></div>';}).join('');
  var habB = ((statsB.habilidadesDecisivas) || []).map(function(h){return '<div class="battle-stat-row"><span style="color:var(--text3);font-size:.76rem;">‚öî '+h+'</span></div>';}).join('');
  var div = document.createElement('div');
  div.innerHTML =
    '<hr style="margin:20px 0;border-color:' + winnerColor + '44;">' +
    '<div class="battle-winner-banner" style="border-color:' + winnerColor + '55;background:linear-gradient(135deg,' + winnerColor + '11,' + winnerColor + '22,' + winnerColor + '11);">' +
      '<div class="battle-winner-label" style="color:' + winnerColor + ';">' + bannerLabel + '</div>' +
      '<div class="battle-winner-name" style="color:#fff;text-shadow:0 0 20px ' + winnerColor + ',0 0 50px ' + winnerColor + '55;">' + bannerName + '</div>' +
      mvpHtml + desfechoHtml +
    '</div>' +
    '<div class="battle-stats" style="margin-bottom:20px;">' +
      '<div class="battle-stat-card" style="border-color:#5588ff44;"><h4 style="color:#5588ff;">Time A</h4>' +
        '<div class="battle-stat-row"><span>Dano Causado</span><span class="battle-stat-val" style="color:#5588ff;">' + Math.round(totalDamageA).toLocaleString() + '</span></div>' + habA +
      '</div>' +
      '<div class="battle-stat-card" style="border-color:#ff442244;"><h4 style="color:#ff4422;">Time B</h4>' +
        '<div class="battle-stat-row"><span>Dano Causado</span><span class="battle-stat-val" style="color:#ff4422;">' + Math.round(totalDamageB).toLocaleString() + '</span></div>' + habB +
      '</div>' +
    '</div>' +
    '<div style="display:flex;gap:10px;flex-wrap:wrap;">' +
      '<button class="btn-primary" onclick="startBattle()">‚öî Rolar Novamente</button>' +
      '<button onclick="clearBattle()" class="btn-danger">üóë Nova Batalha</button>' +
    '</div>';
  resultBox.appendChild(div);
  div.scrollIntoView({behavior:'smooth',block:'start'});
}

function clearBattle() {
  if (battleRunning) stopBattle();
  battleTeamA = []; battleTeamB = []; hpState = {}; totalDamageA = 0; totalDamageB = 0;
  renderBattleTeams();
  document.getElementById('battleResult').classList.remove('visible');
  document.getElementById('battleResultBox').innerHTML = '';
  document.getElementById('battleHpBars').classList.remove('visible');
  document.getElementById('hpRowA').innerHTML = '';
  document.getElementById('hpRowB').innerHTML = '';
}

/* Init teams on load */
renderBattleTeams();
refreshBattleApiKeyStatus();
initCutsceneToggle();

</script>
</html>
